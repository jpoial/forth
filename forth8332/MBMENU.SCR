( Modula-2 menu                                      10/14/89 ) (                                                                       This file contains source for Modula-2 system              menu.                                                                                                                                Copyright (c), 1989, Viljo Soo                                          Tartu University, Estonia                                                                                       )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (                                                    10/16/89 ) HEX                                                             : STR, ( addr --- )                                                     COUNT HERE SWAP DUP ALLOT CMOVE ;                       : DEST|SOUR ( destad sourad --- )                                       ( concatenates two counted strings dest|sour -> dest )          SWAP >R DUP COUNT R@ COUNT + SWAP CMOVE                         C@ R@ C@ + R> C! ;                                      : SOUR|DEST ( sourad destad --- )                                       ( concatenates two counted strings sour|dest -> dest )          DUP >R 1+ OVER C@ ( s da sl )                                   OVER + R@ C@ CMOVE> ( s )                                       DUP C@ R@ C@ + R@ C! ( s )                                      COUNT R> 1+ SWAP CMOVE ;                                -->                                                                                                                             (                                                    10/14/89 ) : INTENS_EMIT INTENSITY EMIT INTENSITY-OFF ;                    : CAP ( chr1 --- chr2 )                                                 DUP ASCII a < OVER ASCII z > OR 0=                              IF 20 - THEN ;                                          VARIABLE ENV_ADDR                                               : ENV_SEG ENV_ADDR @ 10 / ?fs: + ;                              : ADRUN ( addr1 addr2 --- )                                     (       OVER COUNT TYPE SPACE DUP COUNT TYPE KEY DROP    )              HIDDEN                                                          PGM_NAME 40 ERASE CMD_LINE 40 ERASE                             DUP C@ 1+ CMD_LINE SWAP CMOVE                                   COUNT PGM_NAME SWAP CMOVE ENV_SEG exec-run                      FORTH ;                                                 : ?DISCERR ( errcode --- )                                       ?DUP IF CR .STATUS ABORT THEN ; -->                            ( Filenames and pathes                               10/14/89 ) HANDLE WFILE HANDLE MFILE                                       HANDLE TEMPOUT                                                  DIRECTORY EDITOR_NAME EDITOR_NAME DIRNAME NE.COM                DIRECTORY COMPILER_NAME COMPILER_NAME DIRNAME M2COMP.COM        DIRECTORY MAKE_NAME MAKE_NAME DIRNAME MAKE.EXE                  DIRECTORY LOADER_NAME LOADER_NAME DIRNAME LOADR.COM             DIRECTORY LINKER_NAME LINKER_NAME DIRNAME M2LINK.COM            DIRECTORY RUNNER_NAME RUNNER_NAME DIRNAME M2LINK.COM            DIRECTORY DATABAS_NAME DATABAS_NAME DIRNAME SHOWREC.COM         DIRECTORY DBP_NAME DBP_NAME DIRNAME MF.COM                      DIRECTORY MODPATH MODPATH 40 ERASE                              DIRECTORY SOURCEPATH SOURCEPATH 40 ERASE                        DIRECTORY OBJECTPATH OBJECTPATH 40 ERASE                        DIRECTORY LIBPATH LIBPATH 40 ERASE                              -->                                                             (                                                    10/17/89 ) : PATHEND ( addr1 --- addr2 )                                           BEGIN ASCII \ SCAN                                              WHILE 1+ REPEAT ;                                       : REDIRECT ( handle_parsS handle_parsD --- )                            2DUP >R >R SWAP DROP SWAP forcedup 0=                           IF ?DISCERR                                                     THEN                                                            DROP R> R> CLOSE-FILE ?DISCERR ;                        VARIABLE PARAMADDR                                              : EXECMAKE                                                              HERE PARAMADDR ! 0 HERE !                                       PARAMADDR @ DUP LIT"  -n -f" DEST|SOUR                          DUP OBJECTPATH DEST|SOUR                                        LIT" MAKEFILE " DEST|SOUR                                       MFILE DROP 5 + PATHEND COUNTZ DUP >R -->                (                                                    10/17/89 )         PARAMADDR @ COUNT + SWAP CMOVE                                  R> PARAMADDR @ C@ + PARAMADDR @ C!                              LIT" $$" 1+ PARAMADDR @ COUNT + 3 - 2 CMOVE                     TEMPOUT FILENAME LOADINFO.TMP                                   TEMPOUT MAKE-FILE ?DISCERR                                      STD-OUTPUT TEMPOUT REDIRECT                                     ENV_ADDR @ >R 0 ENV_ADDR !                                      MAKE_NAME PARAMADDR @ ADRUN                                     R> ENV_ADDR !                                                   TEMPOUT FILENAME CON                                            TEMPOUT OPEN-FILE ?DISCERR                                      STD-OUTPUT TEMPOUT REDIRECT ;                            -->                                                                                                                                                                                            (                                                    11/30/89 ) : M2EDIT                                                                EDITOR_NAME WFILE DROP 4 + ADRUN ;                      : M2COMPILE                                                             COMPILER_NAME WFILE DROP 4 + ADRUN ;                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/14/89 ) : M2LINK                                                                EXECMAKE                                                        LOADER_NAME LINKER_NAME ADRUN ;                         : M2RUN                                                                 HERE PARAMADDR ! 0 C,                                           PARAMADDR @ DUP RUNNER_NAME DEST|SOUR                           DUP LIT"  " DEST|SOUR                                           MFILE DROP 4 + DEST|SOUR                                        MFILE ?FILE-EXT                                                 IF DROP PARAMADDR @ COUNT + 3 -                                    LIT" BIN" 1+ SWAP 3 CMOVE                                    ELSE PARAMADDR @ LIT" .BIN"  DEST|SOUR                          THEN                                                            LOADER_NAME PARAMADDR @ ADRUN PARAMADDR @ DP ! ;        -->                                                             (                                                    01/16/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/14/89 ) : SET_WORKFILE                                                          INTENSITY ." Work file name: " QUERY INTENSITY-OFF              WFILE [COMPILE] FILENAME                                        WFILE ?FILE-EXT SWAP DROP 0=                                    IF WFILE DROP 4 + LIT" .MOD" DEST|SOUR THEN                     WFILE DROP 5 + ASCII \ SCAN 0=                                  IF SOURCEPATH WFILE DROP 4 + SOUR|DEST                          THEN DROP ;                                             : SET_MAINFILE                                                          INTENSITY ." Main module name: " QUERY INTENSITY-OFF            MFILE [COMPILE] FILENAME                                        MFILE ?FILE-EXT SWAP DROP 0=                                    IF MFILE DROP 4 + LIT" .OBM" DEST|SOUR THEN             -->                                                                                                                             (                                                    10/14/89 )         MFILE DROP 5 + ASCII \ SCAN 0=                                  IF OBJECTPATH MFILE DROP 4 + SOUR|DEST                          THEN DROP ;                                             : SET_LOGDISK                                                           INTENSITY ." Log disk drive: "                                  KEY CAP DUP EMIT ASCII : EMIT INTENSITY-OFF                     ASCII A - 0 MAX 3F MIN                                          0E OVER FDOS DROP 0FF AND >=                                    IF CR ." Illegal drive." CR                                     THEN ;                                                  : SET_ACTDIR                                                            INTENSITY ." New directory name: " QUERY INTENSITY-OFF          BL WORD DUP COUNT + 0 SWAP C! chdir 0=                          IF DROP THEN ;                                          -->                                                             (                                                    10/14/89 ) : SHOWDIR                                                               INTENSITY ." Dir mask: " QUERY INTENSITY-OFF                    DIR ;                                                   : PROMPT CR ." $ " ;                                            : .LOGGED_DRIVE                                                         ." lo" ASCII G INTENS_EMIT ." ged drive: "                      19 0 FDOS DROP 0FF AND ASCII A + INTENS_EMIT                    ASCII : INTENS_EMIT ;                                   : .ACTIVE_DIR                                                           ASCII A INTENS_EMIT ." ctive directory: "                       19 0 FDOS DROP 0FF AND 1+ ( drive )                             INTENSITY .DIR INTENSITY-OFF ;                          -->                                                                                                                                                                                             (                                                    10/14/89 ) : .COMMANDS                                                             ASCII E INTENS_EMIT ." dit      "                               ASCII C INTENS_EMIT ." ompile   "                               ASCII L INTENS_EMIT ." ink      "                               ASCII R INTENS_EMIT ." un       "  CR                           ASCII Q INTENS_EMIT ." uit      "                               ASCII B INTENS_EMIT ." ase      "                               ASCII D INTENS_EMIT ." irectory "                               ASCII P INTENS_EMIT ." athes    "  CR                           ASCII R INTENS_EMIT ." aport    "  ;                    -->                                                                                                                                                                                                                                                                                                                             (                                                    10/14/89 ) : .WORKFILE                                                             ASCII W INTENS_EMIT ." ork file: "                              INTENSITY WFILE .FILENAME INTENSITY-OFF ;               : .MAINFILE                                                             ASCII M INTENS_EMIT ." ain file: "                              INTENSITY MFILE .FILENAME INTENSITY-OFF ;               : M2IDENTIFY CLEARSCREEN                                                10 SPACES ." Modula-2 system. Version 3.0"                      CR 0E SPACES ." Tartu University, Estonia. 1989"                     CR CR ;                                            : SHOWMENU                                                              M2IDENTIFY .LOGGED_DRIVE CR .ACTIVE_DIR CR CR                   .WORKFILE CR .MAINFILE CR CR .COMMANDS CR CR ;          -->                                                                                                                             (                                                    10/22/89 ) : CHECK\ ( addr --- )                                                   DUP COUNT + 1- C@ ASCII \ =                                     IF DROP                                                         ELSE LIT" \" DEST|SOUR                                          THEN ;                                                  : INPUT_PATH DUP INPUT-DIRNAME INTENSITY-OFF CHECK\ ;           ( : SET_MODPATH INTENSITY ." Modula-2 system directory path: "          MODPATH INPUT_PATH ; )                                  : SET_SOURCEPATH INTENSITY ." Source text directory path: "             SOURCEPATH INPUT_PATH ;                                 : SET_OBJECTPATH INTENSITY ." Object modules directory path: "          OBJECTPATH INPUT_PATH ;                                 : SET_LIBPATH INTENSITY ." Library modules directory path: "            LIBPATH INPUT_PATH ;                                    -->                                                             (                                                    10/22/89 ) : SET_EDITOR INTENSITY ." Editor's pathname: "                          EDITOR_NAME INPUT-DIRNAME INTENSITY-OFF ;               ( : .MODPATH ASCII M INTENS_EMIT ." odula-2 system directory : "        INTENSITY MODPATH COUNT TYPE INTENSITY-OFF ; )          : .EDITORPATH ASCII E INTENS_EMIT ." ditor : "                          INTENSITY EDITOR_NAME COUNT TYPE INTENSITY-OFF ;        : .SOURCEPATH ASCII S INTENS_EMIT ." ource text directory : "           INTENSITY SOURCEPATH COUNT TYPE INTENSITY-OFF ;         : .OBJECTPATH ASCII O INTENS_EMIT ." bject modules directory : "        INTENSITY OBJECTPATH COUNT TYPE INTENSITY-OFF ;         -->                                                                                                                                                                                                                                                                                                                             (                                                    10/22/89 ) : .LIBPATH ASCII L INTENS_EMIT ." ibrary modules directory : "          INTENSITY LIBPATH COUNT TYPE INTENSITY-OFF ;            : .PATH_COMMANDS ASCII Q INTENS_EMIT ." uit" CR                         ." save " ASCII C INTENS_EMIT                                   ." urrent settings in file and exit " ;                 : PATHIDENTIFY CLEARSCREEN 10 SPACES                                    ." Modula-2 system." CR 10 SPACES                               ." Path setting menu." CR ;                             : SHOW_PATHMENU PATHIDENTIFY ( CR .MODPATH ) CR .EDITORPATH             CR CR .SOURCEPATH CR .OBJECTPATH CR .LIBPATH CR CR              .PATH_COMMANDS CR CR ;                                  -->                                                                                                                                                                                                                                                             (                                                    10/22/89 ) : HEREPARA ( --- addr )                                                    HERE 0F + FFFF0 AND DUP DP ! ;                       : CREATE_ENV HEREPARA ENV_ADDR ! ;                              : INIT_ENV ENV_ADDR @ DP ! ;                                    : ENV_END 0 C, ;                                                : SET_ENV ( addr1 addr2 --- )                                           SWAP STR, ASCII = C, STR, 0 C, ;                        : MODIFY_ENV INIT_ENV                                                   LIT" SOURCE" SOURCEPATH SET_ENV                                 LIT" OBJECT" OBJECTPATH SET_ENV                                 LIT" LIBRARY" LIBPATH SET_ENV                                   LIT" WNAME" WFILE DROP 4 + SET_ENV                              ENV_END ;                                               -->                                                                                                                             (                                                    10/22/89 ) : M2BASE                                                                MODIFY_ENV EXECMAKE                                             LOADER_NAME DATABAS_NAME ADRUN ;                        : M2BP                                                                  MODIFY_ENV EXECMAKE                                             LOADER_NAME DBP_NAME ADRUN ;                            : SAVE_CONFIG INTENSITY                                                 ." Name of .COM file with current settings: "                   WFILE FILENAME NUL MFILE FILENAME NUL                           INIT_ENV QUERY INTENSITY-OFF SAVE ;                     -->                                                                                                                                                                                                                                                                                                                             (                                                    10/22/89 ) -->                                                             : RESET_NAME ( newpath name --- )                                       DUP >R 1+ PATHEND DUP R@ - 1- R@ C@ SWAP - DUP HERE C!          HERE 1+ SWAP CMOVE                                              R@ 40 ERASE                                                     R@ SWAP DEST|SOUR                                               R> HERE DEST|SOUR ;                                     : NEW_NAMES MODPATH DUP COMPILER_NAME RESET_NAME                        DUP MAKE_NAME RESET_NAME                                        DUP LOADER_NAME RESET_NAME                                      DUP LINKER_NAME RESET_NAME                                      RUNNER_NAME RESET_NAME ; -->                                                                                                                                                                                                                            (                                                    10/22/89 ) : PATH_SHELL                                                            BEGIN SHOW_PATHMENU PROMPT KEY CAP                                CASE                                                              ASCII E OF SET_EDITOR ENDOF                         (           ASCII M OF SET_MODPATH ENDOF )                                  ASCII S OF SET_SOURCEPATH ENDOF                                 ASCII O OF SET_OBJECTPATH ENDOF                                 ASCII L OF SET_LIBPATH ENDOF                                    ASCII Q OF EXIT ENDOF                                           ASCII C OF SAVE_CONFIG ENDOF                                  ENDCASE                                                       AGAIN ;                                                 -->                                                                                                                                                                                             (                                                    10/22/89 ) : SET_PATHES PATH_SHELL SHOWMENU                                       (  NEW_NAMES ) MODIFY_ENV ;                              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/14/89 ) : MENUSHELL                                                       SHOWMENU                                                        BEGIN PROMPT KEY CAP CASE                                         ASCII E OF M2EDIT ENDOF       ASCII C OF M2COMPILE ENDOF        ASCII L OF M2LINK ENDOF       ASCII R OF M2RUN ENDOF            ASCII W OF SET_WORKFILE ENDOF ASCII M OF SET_MAINFILE ENDOF     ASCII G OF SET_LOGDISK ENDOF  ASCII A OF SET_ACTDIR ENDOF       ASCII Q OF BYE ENDOF          ASCII D OF SHOWDIR ENDOF          ASCII P OF SET_PATHES ENDOF   ASCII B OF M2BASE ENDOF                                         ASCII R OF M2BP ENDOF             ( else ) SHOWMENU                                              ENDCASE ( SHOWMENU ) AGAIN ;  -->                                                                                                                                                                                                                            (  End of modmenu                                    10/16/89 ) : MODMENU CREATE_ENV MODIFY_ENV MENUSHELL ;                       ' MODMENU DUP UIDENT ! UQUIT !                                DECIMAL                                                           SAVE MB                                                       ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              