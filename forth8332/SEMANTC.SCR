MODULA-2                                                        Executing-time semantics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       \ #1 Semantics: RLIT GLIT variables                  12/06/90 ) ( : RLIT R> DUP @ SWAP 4 + >R ;                                 : GLIT R> DUP @ SWAP 4 + >R ;                                   : PLIT R> DUP @ SWAP 4 + >R ;                                   VARIABLE PASSTAB )  PASSBUF PASSTAB !                           : rLIT ;                                                        : gLIT ;                                                        : pLIT ;                                                        : ;s ;     ' ;S @ ' ;s !                                                                                                        : GET-PROCADDR ( nr --- addr )                                     1 - PASSTAB @ + @ ;                                           -->                                                                                                                                                                                                                                                            \ #2 Semantics: arithmetical commands.               01/13/88 ) ( Relations. [ x y --- mf ] mf - modula-flag:0=FALSE,1=TRUE )   : EQ = ABS ;                                                    : NE <> ABS ;                                                   : LTI < ABS ;                                                   : LTC U< ABS ;                                                  : LEI <= ABS ;                                                   -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ #3 Semantisc: arithmetical commands,               05/14/90 ) : LEC 2DUP = ROT ROT U< OR ABS ;                                ( Binary arithmetics. [ x y --- z ]  )                          : GTI > ABS ;                                                   : GTC U> ABS ;                                                  : GEI >= ABS ;                                                  : GEC 2DUP = ROT ROT U> OR ABS ;                                : *C UM* DROP ;                                                 : DIVC SWAP 0 ROT UM/MOD SWAP DROP ;                            : MODC SWAP 0 ROT UM/MOD DROP ;                                 ( Set operations. x - operand; s,s1,s2 - sets )                 : DIFFERENCE ( s1 s2 --- s ) NOT AND ;                          : SETSUB ( s1 s2 --- mf ) DUP ROT AND = ABS ;                   : SUBSET ( s1 s2 --- mf ) OVER AND = ABS ;                      : 1SET ( x --- s ) 1 SWAP  <-L ;                                : IN ( x s --- mf ) SWAP 1SET SETSUB ; -->                      \ #4 Semantics: memory handling                      12/06/90 ) VARIABLE PDP                                                    ( VARIABLE MODBASE )                                            VARIABLE DDP                                                    : DHERE DDP @ ;                                                 : DALLOT DDP +! DDP @ PDP @ >                                      IF ( ." Memory overflow" ABORT ) THEN ;                      HEX  8480 DUP DDP ! MODBASE ! DECIMAL                           256 CONSTANT PROC#                                              VARIABLE BASETABLE PROC# ALLOT                                  VARIABLE BAAS                                                   DHERE BAAS !       ( ajutine asi )                              : ERASE-BASETABLE ( --- )                                          BASETABLE PROC# ERASE ;                                      -->                                                                                                                             \ #5 Semantics: memory handling                      12/10/90 ) : GET-CONSTADDR ( --- addr )                                       BAAS @ 4 + @ ;                                               : GET-WORKMEM ( len --- )                                          DALLOT DHERE BAAS @ 4 + ! ;                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #6 Semantics: procedure environment                12/06/90 ) : GETLOCMEM ( procnr --- procaddr )                                GET-PROCADDR BAAS @ SWAP                                        DHERE BAAS !                                                    DUP 2 + @ GET-WORKMEM     ( allocate local memory )             @ DUP BAAS @ 2 + !        ( save procnumber )                   BASETABLE + DUP @         ( previous base )                     BAAS @ 1 + !              ( for current procedure )             BAAS @ SWAP !             ( new basetable element )             BAAS @ ! ;                ( previous stack element )         : EXEC-BODY ( procnr --- )                                        GET-PROCADDR ( RP@ BAAS @ 3 + ! 11.12.1990. ) 1 + @ EXECUTE ; : FREELOCMEM ( --- )                                               BAAS @ DUP DDP !                                                DUP 1 + @ OVER 2 + @ BASETABLE + !                              @ BAAS ! ; -->                                               \ #7 Semantics:                                      12/06/90 ) : FLEXPARMMOV ( addr1 el# fpaddr ellen --- )                       2 PICK 2 PICK 1 + !                                             ROT * DHERE OVER GET-WORKMEM                                    ROT OVER SWAP !                                                 SWAP CMOVE ;                                                 : FLEXCHARMOV ( char fpaddr --- )                                  SWAP DHERE C! DHERE OVER ! 1 SWAP 1 + ! 1 GET-WORKMEM ;      : PARMADDR ( procnr 8+i*4 --- i-parm-addr )                        OVER GET-PROCADDR + @                                           SWAP BASETABLE + @ + ;                                       ( : EXIT-FORTH ( --- )                                          : 2! ( d addr --- ) SWAP OVER 1 + ! ! ;                         : MIN$ MIN ;                                                    -->                                                                                                                             \ #8 Built-in procedures                             05/20/90 ) : *CHR ( x --- char ) 255 AND ;                                 : *ODD ( x --- flag ) 1 AND ;                                   : *CAP ( C1 --- C2 )                                               DUP 96 > OVER 123 < AND IF 32 - THEN ;                       : *INCL ( setvar el --- )                                          1SET OVER @ OR SWAP ! ;                                      : *EXCL ( setvar el --- )                                          1SET NOT OVER @ AND SWAP ! ;                                 : *NEW ( pointaddr len --- )                                       PDP @ SWAP - DUP DHERE >                                        IF DUP PDP ! SWAP !                                             ELSE ( ." Memory overflow"  ABORT ) THEN ;                   : *DISPOSE ( pointaddr --- )                                       0 SWAP ! ;                                                   -->                                                             \ #9                                                 12/06/90 ) : $RETURN ( --- )                                                  BAAS @ 3 + @ RP! ;                                           HEX                                                             VARIABLE RM.INITFLAG 0 RM.INITFLAG !                            : RM.INIT ( --- )                                                   RM.INITFLAG @ 0=                                                IF MODBASE @ DUP DDP ! BAAS !                                      FFFF PDP ! ST-FFL @ GET-WORKMEM -1 RM.INITFLAG !             THEN ;                                                      DECIMAL                                                          -->                                                                                                                                                                                                                                                                                                                            \ #10                                                01/18/90 )                                                                 ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              