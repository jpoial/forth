 MODULA-2                                                       parameetrite tabelid.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( #1 Pseudovariables                                 03/01/91 ) VARIABLE F+P     ( parameetrite v„li )                          : ReWri          F+P @ ;                                        : KEY_LENGTH     F+P @ 4 + ;                                    : MASTERS_LENGTH F+P @ 8 + ;                                    : MASTER-R       F+P @ 12 + ;                                   : FP-VIIT        F+P @ 16 + ;                                   : I-KIRJE        F+P @ 20 + ;                                   : J-KIRJE        F+P @ 24 + ;                                   : KIRPIK         F+P @ 28 + ;                                   : FKIRJE         F+P @ 32 + ;                                   : PURELENGTH     F+P @ 36 + ;                                   : KIRJE          F+P @ 40 + ;                                   : IX-parm        F+P @ 44 + ;   ( DINDEX parm )                 : H-INX          F+P @ 48 + ;   ( INX-handle ahela pea )        -->                                                             ( #2 Pseudovariables                                 03/01/91 ) : KonkA      F+P @ 52 + ; : I-KonkA    F+P @ 56 + ;             : F-SUUND    F+P @ 60 + ; : NIHEK      F+P @ 64 + ;             : A.KEY-INST F+P @ 68 + ; : VETO       F+P @ 72 + ;             : <KIRJE     F+P @ 76 + ; : >KIRJE     F+P @ 80 + ;             : FAILIOTS   F+P @ 84 + ; : RC#        F+P @ 88 + ;             : A-KEY-INST F+P @ 92 + ; : KEYDEPOT   F+P @ 96 + ;             : REC-NR    F+P @ 100 + ; : K-NIHE    F+P @ 104 + ;             : DBF#      F+P @ 108 + ; : DEFNAME   F+P @ 112 + ;             : #KOMPLEKT F+P @ 116 + ; : #VABA     F+P @ 120 + ;             : R/G       F+P @ 124 + ; : KIRJETYYP F+P @ 128 + ;             : KEY.ARRAY F+P @ 132 + ; : TEXT.ARRAY F+P @ 136 + ;            : PROCED.ARRAY F+P @ 140 + ;                                    : Avatud F+P @ 144 + ;                                          -->                                                                                                                             ( #3 Pseudovariables, record addressing              03/01/91 ) DIRECTORY DB-PATH DB-PATH 40 ERASE                              : MASTER_RECORD MASTER-R @ 32 + ;                               : A-FK ( --- A )                                                FKIRJE @ ;                                                      : A-TK ( --- )                                                  A-FK MASTER_RECORD 4 + H@ + KIRJE ! ;                           : A-T? ( A --- )                                                MASTER_RECORD 4 + H@ + KIRJE ! ;                                : A-Fk ( --- A )                                                A-FK MASTER_RECORD 4 + H@ + ;                                   : ?DISKERR ( errcode --- )                                       ?DUP IF CR .STATUS .STACK ABORT THEN ;                         -->                                                                                                                                                                                             ( #4 Indexfile extensions                            03/01/91 ) 9 ARRAY IXi                                                     : IX! ( --- )                                                   0 0 IXi !                                                       LIT" IX1" 1 IXi ! LIT" IX2" 2 IXi ! LIT" IX3" 3 IXi !           LIT" IX4" 4 IXi ! LIT" IX5" 5 IXi ! LIT" IX6" 6 IXi !           LIT" IX7" 7 IXi ! LIT" IX8" 8 IXi ! ;                           : IX@ ( --- pikkusbaidiga sqne )                                MASTER_RECORD 6 + H@ IXi @ ;                                    : DECL ( n --- Addr )                                           HERE DUP >R SWAP 4 + DUP ALLOT ERASE R> ;                       VARIABLE DBF-INDEX                                              : SET-IXP IX-parm @ IX-PARM !   ( declared in DINDEX.SCR ) ;    : DBIX@ ( --- handle pars )                                     SET-IXP MASTER_RECORD 6 + H@ 4 * H-INX @ + @ DUP H@ ;           -->                                                             ( #5 Filehandles                                     03/03/91 ) HANDLE DBF0                                                     HANDLE DBF1  HANDLE DBF2  HANDLE DBF3  HANDLE DBF4              HANDLE DBF5  HANDLE DBF6  HANDLE DBF7  HANDLE DBF8              : DBFILE ( --- handle pars )                                    DBF# @ CASE 0 OF DBF0 ENDOF                                                 1 OF DBF1 ENDOF                                                 2 OF DBF2 ENDOF                                                 3 OF DBF3 ENDOF                                                 4 OF DBF4 ENDOF                                                 5 OF DBF5 ENDOF                                                 6 OF DBF6 ENDOF                                                 7 OF DBF7 ENDOF                                                 8 OF DBF8 ENDOF                                            ENDCASE ;                                                -->                                                             ( #6 Indexfile support                               03/01/91 ) : INX-NAME ( --- )                                              DBFILE DROP DUP 4 + C@ 3 - DUP ROT 5 +    ( l-3,  A.filename )  DBIX@ DROP 5 + ROT CMOVE                                        IX@ 1+ DBIX@ DROP 4 + ROT 2DUP 3 + SWAP C!                      SWAP 1+ + 3 CMOVE ;                                             : RED-ON  ?MODE 7 <> IF 4 FOREGROUND THEN INTENSITY ;           : RED-OFF ?MODE 7 <> IF B/W THEN INTENSITY-OFF ;                : TEXT-LENGTH? ( A --- n )                                      DUP >R BEGIN DUP C@ 0=                                                       IF R> - -1                                                      ELSE 1+  0                                                      THEN                                                      UNTIL ;                                                  -->                                                                                                                             ( #7                                                 03/03/91 ) : MAKE_HANDLE ( I --- )                                         70 DECL H-INX @ ROT 4 * + ! ;                                   : ?MAKE_HANDLE ( I --- )                                        DUP H-INX @ 0=                                                    IF MAKE_HANDLE                                                  ELSE H-INX @ 70 ERASE                                           THEN ;                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #8 Filetables, initialization                      03/10/91 ) VARIABLE pUHVER 1024 DECL pUHVER !                              VARIABLE FILEPARMS                                              HERE FILEPARMS ! 36 ALLOT FILEPARMS @ 36 ERASE                                                                                  : DECL-FP ( --- )                                               8 0 DO 148 DECL FILEPARMS @ I 4 * + ! LOOP ;                                                                                    : GET-FP ( i --- )                                              4 * FILEPARMS @ + @ F+P ! ;                                                                                                     : INIT-DBFs ( --- )                                             IX! DECL-FP  -1 DBF-INDEX ! 0 GET-FP ;                          -->                                                                                                                                                                                             ( #9 Get fileparm by name                            03/12/91 ) : GET-FP-BY-NAME ( A.filename length --- f )                    9 0 DO 2DUP FILENAMES @ I 70 * + SWAP S=                                 IF I DUP DBF-INDEX ! GET-FP -1 LEAVE                            ELSE 0                                                          THEN                                                       LOOP                                                        >R 2DROP R> ;                                                   -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #10 Make handle for index-file                     03/17/91 ) : DECL_H-INX ( --- )                                            2580 DECL IX-parm !                                             MASTER_RECORD 34 + H@ 1+ DUP 4 * DECL H-INX !                   1 DO I MASTER_RECORD 6 + H!                                          I MAKE_HANDLE INX-NAME DBIX@ OPEN-FILE ?DISKERR                 DBIX@ I B-INITS 2DROP ReWri @ 0= IF LEAVE THEN               LOOP                                                          1 MASTER_RECORD 6 + H! IX-parm @ IX-PARM ! ;                    : S-VIGA ( --- )                                                ." S" 129 EMIT ." steemi viga: " ;                              -->                                                                                                                                                                                                                                                                                                                             ( File-errors print                                  05/12/91 ) : DEFILER ( kood --- kood ) DUP                                 CASE -1 OF ." Faili l" 147 EMIT ." pp"                    ENDOF       0 OF                                                ENDOF       1 OF S-VIGA ." Invalid function number"             ENDOF       2 OF ." Faili " DBFILE .FILENAME ."  ei ole. Loon?" ENDOF       3 OF ." Teed" DB-PATH .DIR ." ei ole"               ENDOF       4 OF ." Failide arv on ammendatud"                  ENDOF       5 OF ." Access denied"                              ENDOF       6 OF S-VIGA ." Invalid handle"                      ENDOF      7 OF S-VIGA ." M" 132 EMIT ." lu juhtplokid rikutud" ENDOF       8 OF ." M" 132 EMIT ." lu on otsas"                 ENDOF       9 OF S-VIGA ." Invalid memory block address"        ENDOF      10 OF ." Vigane keskkond"                            ENDOF      11 OF ." Vigane formaat"                             ENDOF -->                                                             ( #12                                                05/10/91 )      12 OF S-VIGA ." Invalid access code"                 ENDOF      13 OF ." Vigased andmed"                             ENDOF      14 OF ." ???"                                        ENDOF      15 OF ." Vale kettaseade"                            ENDOF      16 OF ." Kataloogi ei saa vahetada"                  ENDOF      17 OF ." Vahetatud v" 132 EMIT ." lisseade!"         ENDOF      18 OF ." Rohkem faile pole"                          ENDOF      20 OF ." Bad INDEX# "                                ENDOF      30 OF ." Faili l" 147 EMIT ." pp"                    ENDOF      41 OF ." Failis pole selle v“tmega kirjet "          ENDOF      42 OF ." Failis pole kustutatud kirjeid "            ENDOF      43 OF ." Fail on avatud ainult lugemiseks! "         ENDOF     100 OF ." Ketas on t" 132 EMIT ." is"                 ENDOF     101 OF ." Fail" DBFILE .FILENAME ." on avamata!"      ENDOF ENDCASE ;                                             ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        