(                                                    10/13/89 )                                                                                                                                                    Modula-2 Descriptions:                                            Record-type,                                                    Const. Expression.                                                                                                          Translation CASE-statement,                                                 WITH-statement.                                                                                                                                                                                                                                                                                                                                                                                                                                      Programmed by A. Isotamm.                     \ #1  Record description: pointer, vocabulary.       08/06/89 ) : CHAIN ( >tab first next --- >tab  | kirjev@li ==> ahel )      SWAP DUP ROT 3 PICK                                             ROT  + DUP @ 0 =  ( esimene ? )                                 IF LATEST-TAB SWAP !  DROP ( oma PFA ==> first )                ELSE  4 + @ +  LATEST-TAB SWAP !  ( oma PFA := next.last )      THEN OVER + 4 + LATEST-TAB SWAP ! ( oma PFA ==> last )          ;                                                               : XX ( >rectab --- >rectab | new context ==> rectab )           CONTEXT  @ OVER 20 + !                                          CONTEXT @ CURRENT ! ;                                           : CONTACT ( >rectab --- >rectab | oma context ==> aktiiv )      DUP 20 + @ DUP CONTEXT ! CURRENT ! ;                            : CONTBACK ( >rectab --- >rectab | taastab vana contexti )      DUP 16 + @ DUP CONTEXT ! CURRENT ! ;                            -->                                                             \ #2  Record description: simple field.              08/06/89 ) : EL$ ( >rec >type >type --- >rec >type | in form EL$ XXX )     DEF-OBJ ,                     ( >type ==> INFO )                0 ,                           ( INFO+4 : viit moodulile )       0 ,                           ( INFO+8 : next )                 OVER , 0 ,                    ( >rectab ==> INFO+12, >mass. )   DUP ?T 15 = IF DUP 12 + @ ?T 13 =                                              IF 3 3 ELSE 3 1 THEN  ( "recroot" L=3,T=3 )                  ELSE 3 1                 ( lihtv@li L=3, T=1 )                  THEN LATEST-TAB SET-L&T                             OVER 8 + @ LATEST-TAB 4 + !   ( nihe ==> EXEC )                 OVER 12 + 1 SWAP +!           ( rectab: n+ )                    DUP ?TSIZE 2 PICK 8 + +!      ( rectab: tsize+ )                OVER 24 16 CHAIN DROP         ( ise ==> last; next.prior )      ;                                                               -->                                                             \ #3  Record description: rectype.                   11/12/89 )   VARIABLE KIRJETYYP                                            : MRT ( --- >rectab )                                           9 13 ANON-OBJ DUP >R SET-L&T                                    0 , 0 , ( pikkus, v@ljade arv - INFO, INFO+4 )                  CONTEXT  @ , 0 , ( vana context, oma context )                  0 , 0 , ( viit v@ljadele, viit viimasele )                      HERE >R                                    ( Make vocabulary )      129 C, 160 C, ['] FORTH 10 + CURRENT @ =                        IF 0 , ELSE CURRENT @ 2 - , THEN                                HERE VOC-LINK @ , VOC-LINK !                                R> 2+ CONTEXT !                             ( Make it activ   ) R> DUP KIRJETYYP ! XX ;                                         : ?SBTYPE ( >consttable --- >basetype-of-set )                     ?TYPE ?ELTYPE ;                                              -->                                                             \ #4  Record description.                            06/30/89 ) : UNCEL$  ( >rectab >typetab --- >rectab >ct )                  ANON-OBJ , DUP , 0 , 0 , 0 , 0 ,                                3 2 LATEST-TAB SET-L&T                                          DUP 8 + @ LATEST-TAB 4 + !                                      24 16 CHAIN ;                                                   : CHAN ( >tab >ct --- >tab | uus alternatiiv ==> ahel )         OVER 28 + DUP @ 0 = IF 2DUP !                                   ELSE 2DUP  4 + @ 16 + !                                         THEN 4 + ! ;                                                    : START-ADDR ( >rectab >ct >ct-rectab --- >rectab >ct >ct-r )   2 PICK 8 + @ ( suhtaadress )                                    OVER   8 + !                                                    ;                                                               -->                                                                                                                             \ #5  Record description: caseroot.                  08/06/89 ) : CEL$ ( >rectab >typetab --- >rectab >ct | in form CEL$ XXX )  DEF-OBJ LATEST-TAB >R ,      ( >type ==> INFO )                 0 ,                          ( INFO+4 : viit moodulile )        0 ,                          ( INFO+8 : next-v@li )             DUP , 0 ,                    ( >rectab ==> INFO+12, >massiiv )  0 , 0 , 0 ,   ( >1.altern., >viimane altern., max-size )        3 2 LATEST-TAB SET-L&T       ( L=3, T=2 )                       DUP 8 + @ LATEST-TAB 4 + !   ( nihe ==> EXEC )                  LATEST-TAB 8 + @ ?TSIZE OVER 8 +  +! ( rectab: size + )         DUP 12 + 1 SWAP +!           ( rectab: n+ )                     24 16 CHAIN R> ;        ( self ==> rectab.last, prior.next )    -->                                                                                                                                                                                                                                                             \ #6  Selector: CONST$ for record-caselabel.         11/09/89 ) : Selector (  const  T  ---  >consttable )                          ANON-OBJ >R 5 OVER R@ SET-L&T                                   CASE 1 OF INTEGER , , ENDOF                                          2 OF CARDINAL , , ENDOF                                         3 OF INT/CARD , , ENDOF                                         6 OF CHAR , 1 C, 1+ C@ C, ENDOF                               7 OF STRING , DUP C@ 1+ HERE SWAP DUP ALLOT CMOVE ENDOF           8 OF ADDRESS , , ENDOF                                          9 OF DUP 0 TAB@ , 4 TAB@ , ENDOF                               10 OF DUP 0 TAB@ , 4 TAB@ , ENDOF                               11 OF DUP , DUP 8 TAB@ , 12 TAB@ , ENDOF                        12 OF BOOLEAN , , ENDOF                                        SWAP INT/CARD , ,                                            ENDCASE R> ;                                                -->                                                             \ #7  Error handling: print right 10 lexems.         11/10/89 ) : MEXIT ( nr --- )                                              .MSG ."    ... "                                                10 1 DO BL word DUP C@ DUP 0 = IF LEAVE THEN                         SWAP 1 + SWAP TYPE ."   "                                       LOOP ERR_EXIT ;                                            : GET-BASE ( >pass --- >basetype )                              DUP ?T CASE 10 OF  ENDOF                                                    11 OF  ENDOF                                                    15 OF  12 + @ MYSELF ENDOF                                        33 MEXIT                                                 ENDCASE ;                                                : SELECTOR$ (  const  T  --- >consttable )                          SWITCH-TO-SETTABLE >R >R >R  Selector                           R> R> R> SWITCH-BACK ;                                      -->                                                             \ #8  Record description: case checking.             11/30/89 ) : ?BASE-TYPE ( >type --- >type )                                DUP ?L 6 =                                                        IF  DUP ?T CASE 9 OF ?SBTYPE ENDOF                                             11 OF 8 + @   ENDOF                                         ENDCASE                                              THEN ;                                                        : CASECHECK  ( >cr >rect >casel --- >cr >rect >casel )          DUP ?TYPE ?BASE-TYPE                                            3 PICK ?TYPE ?BASE-TYPE <>  ( types are identical? )            IF 35 MEXIT THEN                                                ;                                                               -->                                                                                                                                                                                                                                                             \ #9  Record description: case checking.             08/19/89 ) : CASELENGTH ( >cr >rect >casel --- >cr >rect >casel )          OVER 0 <> IF 2 PICK 4 + @ >R   ( start-addr )                             2 PICK 2 PICK 8 + @ R> -                                        DUP ROT 36 + DUP @ ROT <                                          IF !  ( variandi max-pik. CASEROOT+36 )                         ELSE 2DROP                                                      THEN                                                          THEN ;                                                : CLENGTH ( >rect >cr --- >rect )                               OVER 0 <> IF 36 + @ OVER 8 + +! THEN ;                          -->                                                                                                                                                                                                                                                                                                                             \ #10 Record description: case, flags.               09/20/89 ) VARIABLE WLIPP     ( 1: subvocabulary opened; old cont. CPOP )  VARIABLE CaseFlag  ( 1 if CaseStatHead )  VARIABLE Rets         0 CaseFlag !      0 Rets !  ( Case kirjeta )                    0 WLIPP !          VARIABLE WFLAG    0 WFLAG !                  : MAKECT ( >cr >rectab >ct-list --- >cr >rectab )                  CASELENGTH                                                      9 0 ANON-OBJ  DUP >R  SET-L&T  ( Alternatiivitabel )            ,                              ( >caselabel-chain ==> INFO )    ,                              ( >rectab ==> INFO+4 )           0 ,                            ( INFO + 8 = next )              DUP , R> CHAN                  ( >caseroot ==> INFO+12 )     ;                                                               -->                                                                                                                                                                                             \ #11 RecordCase: caselabel.                         11/25/89 ) : SELECTOR ( >cr >rect >ct const T ---  >cr >rect >ct )            9 0 ANON-OBJ  DUP >R  SET-L&T  ( Caselabel-table )              SELECTOR$ DUP , >R             ( Caselabel ==> INFO )           ,                              ( >ct ==> next =INFO+4 )         0 , 0 ,                        ( 2 h@@lestamisnulli )           R> CASECHECK DROP R> ;                                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #12 With-flag, Case-stack.                         10/04/89 ) : -!  ( n aadr --- )                                            DUP @ ROT - SWAP ! ;                                            : WFLAG+ 1 WFLAG ! ;  IMMEDIATE                                 : WFLAG- 0 WFLAG ! ;  IMMEDIATE                                 VARIABLE CTOP                                                   VARIABLE CSTACK 252 ALLOT                                       CSTACK 256 ERASE CSTACK CTOP !                                  : CPUSH ( x --- )                                                 CTOP @ ! 4 CTOP +! ;                                          : CPOP  ( |x|   --- x )                                           CTOP @  4 - @ ;                                               : CPOP1 ( |xz|  --- x )                                           CTOP @  8 - @ ;                                               : CPOP2 ( |xzz| --- x )                                           CTOP @ 12 - @ ;                                     -->       \ #13 Case: stack for pass & type.                   11/17/89 ) : CTOPS CTOP @ 4 - CTOP ! ;                                     : CT? ( >table  *  ---  *  )                                        >R IS-RECTYPE? IF CTOPS THEN DROP R> ; IMMEDIATE            : CF+  ( --- )                                                  CONTEXT @ CPUSH  ( old context => stack )                       1 CaseFlag +! Rets @ 0 > IF 1 Rets -! THEN ; IMMEDIATE          : CF-  ( [>caseroot] >selector-type --- )                       COMPILE >R                       ( selector-value      )        Rets @ 0  > IF SWAP CPUSH THEN   ( >caseroot => CSTACK )        CPUSH  1 CaseFlag -! ;           (     >type => CSTACK )        IMMEDIATE                                                       : WITHOUT ( >table --- )                                        DROP CPOP  CONTEXT !            ( old context => current )      CTOPS ; IMMEDIATE                                               -->                                                             \ #14 Transexp: switch vocabulary.                   03/26/90 ) : VOCIN ( >rectype --- )                                        20 + @ CONTEXT ! ;                                              : RECTAB? ( >rectype [recbase] --- [>rectype] )                 DUP ?L 3 = IF DROP 0        ( 3,3-rec-field )                              ELSE DUP ?L 9 <> OVER ?T 13 <> OR                               THEN ;                                               : VOCOFF ( ---  )                                               Rets @ 0 >                                                        IF CPOP2 CONTEXT !      ( old context => current )              THEN ; IMMEDIATE                                              : RECTYPE ( >rectype --- >rectype )                             CONTEXT @ CPUSH DUP VOCIN ;                                     -->                                                                                                                                                                                             \ #15 Enumeration-type.                              03/26/90 ) : OP-REC (  >table ---  >table )                                   CASE IS-MODULE?   =>            ENDOF                                IS-RECTYPE?  =>  RECTYPE   ENDOF                                                 62 ?PRINTERROR                            ESAC ; IMMEDIATE                                             : MVLROOT ( --- >ValueListRoot )                                9 10 ANON-OBJ DUP >R SET-L&T  R>                                B/WORD , 0 , ( elementide arv -  INFO+4 )                       0 , 0 , ( viit esimesele, viit viimasele ) ;                    : ENUID$ ( >VLR --- >VLR | in form ENUID$ XXX )                 DUP DEF-OBJ ,    ( ValueListRoot ==> INFO )                     DUP 12 + DUP @ , ( jrk-nr ==> INFO+4      )                     0 ,              ( >next  ==> INFO+8      )                     1 SWAP  +!       ( in VLR: n:=n+1         )                     16 16 CHAIN 7 0 LATEST-TAB SET-L&T ; -->                        \ #16 ConstExpression: Subrange.                     10/15/89 ) : Crroot ( c1 T1 c2 T2 --- >tab 11 )                            6 11 ANON-OBJ DUP >R SET-L&T                                    DUP 10 =        ( loendityypi identif. ? )                          IF SWAP DUP ?TYPE ,  ( baastyyp ==> INFO )                         3 PICK 2DUP                                                     12 + @         ( i2 )                                           SWAP 12 + @    ( i1 )                                           SWAP - 1 + ,   ( n ==> INFO+4 )                                 DROP ROT ROT 2SWAP SWAP                                         , ,            ( i1==> INFO+8 , i2==>INFO+12 )                  SWAP , ,       ( T1==> INFO+16, T2==>INFO+20 )               ELSE ( NB! Matilt ) 3 PICK 2 PICK SWAP 0 , ( 0 ==> INFO )          - 1 + , ROT 2SWAP SWAP  ( n ==> INFO+4 )                        , , , ,  ( a==>INFO+8, b==>INFO+12, T1=>I+16,T2=>I+20 )      THEN R> 11 ; -->                                            \ #17 CaseStatement: open vocabulary, ENDCASE.       11/10/89 ) : CASE-OPEN ( label >altern --- )                               2DUP 8 + @ 8 + @ 12 + @ =                                         IF 12 + @ 20 + @ CONTEXT ! DROP  ( open subvocabulary )         ELSE 16 + @ DUP 0 <>                                              IF MYSELF                                                       ELSE 32 MEXIT                                                   THEN                                                          THEN ;                                                                                                                        : CASE-DROP ( --- )             ( "ENDCASE" semantika )           COMPILE R> COMPILE DROP       ( expression-value    )         Rets @ 0 >                                                        IF CTOPS CTOPS                ( >rectype, >caseroot )           THEN CTOPS ; IMMEDIATE        ( rets: context; muu: >type )   -->                                                             \ #18 ConstSet checking                              10/28/89 ) : ?IS-SET? ( >pass --- >basetype )                              DUP ?L CASE 6 OF DUP ?T 9 = IF 8 + @ GET-BASE                                               ELSE 33 MEXIT                                                   THEN                                              ENDOF                                                         8 OF DUP ?T 15 <> IF 33 MEXIT                                                     ELSE 12 + @ DUP ?T 9 =                                            IF 12 + @ GET-BASE                                              ELSE 33 MEXIT                                                   THEN                                                          THEN                                             ENDOF                                                         9 OF DUP ?T 9 = IF 12 + @ GET-BASE THEN ENDOF                     33 MEXIT                                                 ENDCASE ;                                      -->      \ #19 ConstSet                                       10/28/89 ) : CSROOT00  ( >ownertype --- >tab )                                 DUP ?IS-SET?  DROP  ( >ownertype --- >basetype )              6 9 ANON-OBJ DUP >R SET-L&T                                     ,     ( >basetype ==> INFO )                                    0 ,   ( Set )                                                   R> ;                                                          : CSROOT                                                            SWITCH-TO-SETTABLE >R >R >R CSROOT00                            R> R> R> SWITCH-BACK ;                                      : BENUM ( C T' --- c T )                                        DUP 20 >     ( sisetyyp ? Siis C = >type; c:=value, T:=T'-20 )  IF 20 -  SWAP 12 + OVER 6 = 2 PICK 7 = OR IF SWAP               ELSE @ SWAP THEN THEN ;                                         -->                                                                                                                             \ #20 ConstSet: subrange.                            10/29/89 ) : MMTYPE ( >type --- min max )                                  DUP  20 + @ 12 + @   ( min )                                    SWAP 24 + @ 12 + @   ( max ) ;                                  : MMCONST ( >const --- min max )                                DUP  16 + @ 12 + @   ( min )                                    SWAP 20 + @ 12 + @   ( max ) ;                                  : PPTYPE ( >type --- min max )                                  DUP  20 + @          ( min )                                    SWAP 24 + @          ( max ) ;                                  : PPCONST ( >const --- min max )                                DUP  16 + @          ( min )                                    SWAP 20 + @          ( max ) ;                                  -->                                                                                                                                                                                             \ #21 ConstSet.                                      11/03/89 ) : E-MIN&MAX ( >crroot --- min max )                             DUP  ?L 6 = IF MMCONST                                                      ELSE MMTYPE                                                     THEN 2DUP > IF 41 MEXIT THEN ;                      : MIN&MAX ( >crroot --- min max )                               DUP  ?L 6 = IF PPCONST                                                      ELSE PPTYPE                                                     THEN 2DUP > IF 41 MEXIT THEN ;                      : PUT-IN-SET ( >csroot i --- >csroot )                          DUP 31 > IF 40 MEXIT                                                     ELSE 1 SWAP <-L OVER 12 + @ OR OVER 12 + !                      THEN                                                   ;                                                               -->                                                                                                                             \ #22 ConstSet.                                      09/18/90 ) : ENUM-SET? ( >csr >cid --- >csr >cid )                         2DUP ?TYPE SWAP ?SBTYPE DUP ?T                                  CASE 10 OF <>         ENDOF                                          11 OF 16 + @ <>  ENDOF                                     ENDCASE                                                              IF 35 MEXIT THEN ;                                         : CRROOT (    )                                                     SWITCH-TO-SETTABLE >R >R >R Crroot                              R> R> R> SWITCH-BACK ;                                      0 I/C  31 I/C                                                                   Crroot  RANGE-TAB                                      $SET-OF  TYPE$ BITSET                                    -->                                                                                                                                                                                             \ #23 ConstSet.                                      09/18/90 ) : EQ-TYPES? ( >csr >type --- >csr >type )                       2DUP ?TYPE DUP 0 <> IF SWAP ?SBTYPE <>                          IF 35 MEXIT THEN ELSE 2DROP THEN ;                              : GET-ENUM-I ( i >basetype --- j )                              E-MIN&MAX 2 PICK > IF 2DUP < IF 39 MEXIT                                                     ELSE -                                                          THEN                                                  ELSE 39 MEXIT                                                   THEN ;                                       : ENUM-SET ( >csr >cid --- >csr j )                             ENUM-SET? 12 + @ OVER ?SBTYPE DUP ?T                            CASE 10 OF DROP       ENDOF                                          11 OF GET-ENUM-I ENDOF                                     ENDCASE ;                                                       -->                                                             \ #24 ConstSet: SETONE.                              10/29/89 ) : I/C-SET ( >csr c --- >csr j )                                 OVER ?SBTYPE DUP ?T 11 <>                                            IF 34 MEXIT                                                     ELSE  GET-ENUM-I                                           THEN ;                                                          : SETONE ( >csroot >cid|c T  --- >csroot )                      10 =     ( identifikaatorid ? )                                 IF ENUM-SET                                                     ELSE I/C-SET                                                    THEN  PUT-IN-SET ;                                              : SETSUBR ( >csroot a b  --- >csroot )                          SWAP                     ( b a )                                DO &I PUT-IN-SET   ( ettevaatust !)                             LOOP ;                                                          -->                                                             \ #25 ConstSet: subrange.                            10/29/89 ) : SUBR-LIMIT ( >csroot min max >subr-basetype --- >csr a b )    E-MIN&MAX 2 PICK < IF 39 MEXIT                                                     ELSE 2 PICK OVER < IF 39 MEXIT THEN                             THEN                                         DUP ROT SWAP -                                                  ROT ROT - SWAP 1 + ;                                            : ENUM-LIMIT ( >csroot min max >enum-basetype --- >csr a b )    DUP 12 + @   ( n )                                              2 PICK < IF 39 MEXIT THEN                                       2 PICK 0 < IF 39 MEXIT THEN                                     DROP 1 + ;                                                      -->                                                                                                                                                                                                                                                             \ #26 ConstSet.                                      10/29/89 ) : SUBR-CHECK ( >csroot >crroot --- >csroot )                    EQ-TYPES? DUP 24 + @ 10 = IF E-MIN&MAX ELSE MIN&MAX THEN        2 PICK ?SBTYPE DUP ?T CASE 10 OF ENUM-LIMIT ENDOF                                        11 OF SUBR-LIMIT ENDOF                                     ENDCASE ;                                   : SETTWO ( >csroot >crroot 11  --- >csroot )                    DROP SUBR-CHECK SETSUBR ;                                       : ENUMSET ( >csroot >type --- >csroot a b )                     DUP 16 + @ 12 + @ SWAP 20 + @ 12 + @ ;                          : SUBRSET ( >csroot >type --- >csroot a b )                     DUP 20 + @ 12 + @ SWAP 24 + @ 12 + @ ;                          : SETTER ( >csroot --- >csroot 9 )                              DUP ?SBTYPE DUP ?T CASE 10 OF ENUMSET ENDOF                                             11 OF SUBRSET ENDOF                                      ENDCASE SETSUBR 9 ;  -->                       \ #27 ConstExpression.                               10/14/89 ) : KETT ( const-pfa --- >tab T )                                 ?TYPE DUP ?T 20 + ;    ( sisekood ! )                           : PUTCONST ( const-pfa --- >tab T )                             DUP ?T CASE                                                               9 OF KETT ENDOF                                                10 OF KETT ENDOF                                                11 OF KETT ENDOF                                                15 OF ?TYPE MYSELF ENDOF                                           DUP 20 + SWAP  ( sisekood ! )                               ENDCASE ;                                               : SET9 ( --- 9 )                                                9 ;                                                             -->                                                                                                                                                                                             \ #28 ConstExpression.                               10/14/89 ) : MAKESET ( >set1 >set2 --- >set1 >set2 >resset 9 )             2DUP ?SBTYPE SWAP ?SBTYPE 2DUP <>                                  IF 16 + @ SWAP 16 + @ <>                                           IF 35 MEXIT ELSE DUP CSROOT 9 THEN                           ELSE 2DROP DUP CSROOT 9                                         THEN ;                                                       : SNOOPSET ( >named-type --- >set 9 | error )                   DUP ?T 15 =                                                       IF 12 + @ DUP ?T 9 =                                              IF 12 + @       ( baastyyp )                                       SWITCH-TO-SETTABLE >R >R >R                                     6 9 ANON-OBJ                                                    DUP >R SET-L&T                                                  ,     ( >basetype ==> INFO )                                    0 , R> SETTER  R> R> R> SWITCH-BACK  -->                 ( #29 ConstExpression.                               10/14/89 )     ELSE 36 MEXIT THEN                                             ELSE 36 MEXIT THEN ;                                         : Makeit ( >enum-type --- >tab 10 )                                 SWITCH-TO-SETTABLE >R >R >R                                 6 10 ANON-OBJ DUP >R SET-L&T                                    DUP ?TYPE ,     ( basetype ==> INFO )                               12 + @ ,    ( index ==> INFO+4  )                           R> 10                                                               R> R> R> SWITCH-BACK ;                                      : MAKEIT ( loendit-ident-pfa --- >tab 10 | t/f 12 )             DUP ?TYPE IS-BOOL?                                              IF DROP 12 + @ 12       ( true|false 12 )                       ELSE DROP Makeit                                                THEN ;                                                          -->                                                             \ #30 ConstExpression. Compatibility checking        10/22/89 ) : CT123 ( c1 c2 --- c1 c2 3 )                                   3 ;                                                             : CTN12 ( c1 >enum --- c1 c2 12 )                               12 + @ 12 ;                                                     : CTNBASE ( c1 >set --- c1 >set 12 )                            DUP ?SBTYPE ?T 3 >                                                IF 37 MEXIT                                                     ELSE 12                                                         THEN ;                                                        : CTTT ( >type1 >type2 --- >type1 >type2 12 )                   2DUP 8 + @ SWAP 8 + @ =                                           IF 12 ELSE 37 MEXIT THEN ;                                    : CTES ( >enum >set --- c1 >set 12 )                            SWAP 12 + @ SWAP 12 ;                                           -->                                                             \ #31 ConstExpression. Compatibility checking        10/22/89 ) : CTEE ( >enum >enum --- c1 c2 3 )                              CTTT 12 + @ SWAP 12 + @ SWAP 3 ;                                12 12 2ARRAY CTAB      ( Compatiblilty table )                  ' CT123    1  2 CTAB !   ' CT123   3  1 CTAB !                  ' CT123    1  3 CTAB !   ' CT123   3  2 CTAB !                  ' CTNBASE  1  9 CTAB !   ' CTNBASE 3  9 CTAB !                  ' CTN12    1 10 CTAB !   ' CTN12   3 10 CTAB !                  ' CTNBASE  1 11 CTAB !   ' CTNBASE 3 11 CTAB !                  ' CT123    2  1 CTAB !   ' CTES   10  9 CTAB !                  ' CT123    2  3 CTAB !   ' CTEE   10 10 CTAB !                  ' CTNBASE  2  9 CTAB !   ' CTES   10 11 CTAB !                  ' CTN12    2 10 CTAB !   ' CTTT   11  9 CTAB !                  ' CTNBASE  2 11 CTAB !   ' MAKESET 9  9 CTAB !                  -->                                                                                                                             \ #32 ConstExpression. Compatibility checking        10/22/89 ) 12 1 2ARRAY CTYPETAB   ( passtype ==> Tombak-type )             1 1 1  CTYPETAB !  2 1 2  CTYPETAB !  2 1 3  CTYPETAB !         3 1 6  CTYPETAB !  3 1 7  CTYPETAB !  5 1 9  CTYPETAB !         3 1 10 CTYPETAB !  3 1 11 CTYPETAB !  6 1 12 CTYPETAB !         : CEOPS ( C1 C2 T1 T2 --- c1 c2 T )                             CTAB @ DUP 0 =                                                     IF 37 MEXIT                                                     ELSE EXECUTE                                                    THEN ;                                                       : SET-OPERATION ( >set1 >set2 >resset tehe 5 --- >resset 9 )    DROP >R ROT 12 + @ ROT 12 + @ R> 5 OP-TABLE @                   EXECUTE OVER 12 + ! 9 ;                                         -->                                                                                                                                                                                             \ #33 ConstExpression. Compatibility checking        10/22/89 ) : RESTYPE ( C1 C2 T1 T2 --- T )                                 2DUP = IF 8 > IF DUP CEOPS THEN                                        ELSE CEOPS                                                      THEN ;                                                   : IN-SET ( c T >set 9 --- tf 12 )                               9 <> IF 33 MEXIT                                                     ELSE  12 + @    ( set )                                               SWAP DROP AND 0 = IF 0 ELSE 1 THEN 12                     THEN                                                       ;                                                               : BCHECK ( C1 T1' C2 T2' --- c T )                              DUP 20 >     ( sisetyyp ? Siis C = >type; c:=value, T:=T'-20 )  IF BENUM THEN 2SWAP DUP 20 > IF BENUM THEN 2SWAP ;              -->                                                                                                                             \ #34 ConstExpression. Binary operation.             10/22/89 ) : C-BIN-OP ( C1 T1 C2 T2 nr --- c T )                           >R BCHECK R@ 15 =                           ( R: tehe )                    IF IN-SET R> DROP                                               ELSE ROT SWAP RESTYPE R> SWAP DUP >R 1 SWAP                          CTYPETAB @ DUP 0 =          ( R: tehe v, t s )                    IF 38 MEXIT                                                     ELSE DUP 5 =       ( hulgad ? )                                    IF SET-OPERATION R> DROP                                        ELSE OP-TABLE @ DUP 0 =                                            IF 38 MEXIT                                                     ELSE EXECUTE                                                    THEN R> ( res-type )                                         THEN                                                         THEN                                                      THEN  ;  -->                                        \ #35 ConstExpression. Unary operation.              11/10/89 ) : C-UN-OP ( C T tehe --- C T )                                  >R SWAP OVER DUP 10 =                                              IF DROP 12 + @                                                  ELSE 3 >                                                           IF 38 MEXIT                                                     THEN                                                         THEN R> 2 = IF NEGATE THEN SWAP ;                            : COMP= ( >selector --- )                                        12 + @ [COMPILE] LITERAL           ( selectors value )          COMPILE R@                         ( value of expression )      COMPILE = ;                                                    -->                                                                                                                                                                                                                                                             \ #36 CaseStatement: compile relation                11/24/89 ) : COMPIN ( >selector --- )                                       COMPILE R@                         ( value of expression )      12 + @ [COMPILE] LITERAL           ( selectors value )          COMPILE IN COMPILE 0= COMPILE 0= ;                             : COMP<> ( >selector --- )                                       DUP 12 + @ 12 + @                  ( lower limit )              [COMPILE] LITERAL                                               COMPILE R@                         ( value of expression )      COMPILE <=                                                      16 + @ 12 + @                      ( superior limit )           [COMPILE] LITERAL                  ( superior limit )           COMPILE R@                         ( value of expression )      COMPILE >= COMPILE AND ;                                       -->                                                                                                                             \ #37 CaseStatement: compile realation.              11/24/89 ) : COMP-REL ( >selector --- )                                    DUP ?T                                                                CASE 1 OF COMP=        ENDOF                                         2 OF COMP=        ENDOF                                         3 OF COMP=        ENDOF                                         6 OF COMP=        ENDOF                                         7 OF COMP=        ENDOF                                         8 OF COMP=        ENDOF                                         9 OF COMPIN       ENDOF                                        10 OF COMP=        ENDOF                                        11 OF COMP<>       ENDOF                                        12 OF COMP=        ENDOF                                     ENDCASE                                                  ;                                                               -->                                                             \ #38 Compiler: records field.                       11/22/89 ) VARIABLE SList  ( for CaseLabelsList )    0 SList !             : COMPILE-RFA ( >rftab ---  >rftab )                            COMPILE WPOP DUP 4 + @ [COMPILE] LITERAL COMPILE +  ;           : OPEN-SUBVOC ( >rftab ---  >rftab)                             CONTEXT @ CPUSH 1 WLIPP ! DUP 8 + @ 12 + @ 20 + @ CONTEXT ! ;   : RECFIELD-ADDR ( >pfa --- >pfa )                               DUP ?T CASE                                                          1 OF  COMPILE-RFA          ENDOF                                2 OF CaseFlag @ 1 =                                                  IF DUP 1 Rets !                                                 THEN  COMPILE-RFA     ENDOF                                3 OF COMPILE-RFA           ENDOF                                  ENDCASE ;                                                -->                                                                                                                             \ #39 Designator: close subvocabulary?               11/20/89 ) : REC-CHECK  ( --- )                                            WLIPP @ 1 =                                                       IF WFLAG @ 0 =                                                    IF CPOP CONTEXT ! CTOPS                                         THEN 0 WLIPP !                                                THEN ; IMMEDIATE                                              : CID-TYPE ( pfa --- >tab T )                                   DUP ?L CASE 5 OF PUTCONST ENDOF                                             6 OF PUTCONST ENDOF                                             7 OF MAKEIT   ENDOF                                             8 OF SNOOPSET ENDOF                                                  36 MEXIT                                               ENDCASE ;                                               -->                                                                                                                             \ #40 CaseStatement: selector.                       11/27/89 ) : Selector-list ( >selector --- )                               9 0 ANON-OBJ DUP >R SET-L&T                                     SList @ ,         ( next selector )                             DUP , 0 , 0 ,     ( >label + 2 h@@lestamisnulli )               R> SList ! ;                                                    : SELECTOR-LIST ( const T ---  >selector )                          SELECTOR$                                                       SWITCH-TO-SETTABLE >R >R >R Selector-list                       R> R> R> SWITCH-BACK                                            COMP-REL ; IMMEDIATE                                        -->                                                                                                                                                                                                                                                                                                                             \ #41 CaseStatement: CaseLabels checking             11/29/89 )   ( >s: CaseStatementLabel; >c: RecordCaseLabel )                 ( kontroll: s = c | s kuulub hulka c ?        )               : I/C= ( >s >c --- tf )                                         12 + @ SWAP 12 + @ = ;                                          : CH=  ( >s >c --- tf )                                         12 + @ SWAP 12 + @ = ;                                          : STR= ( >s >c --- tf )                                         12 + @ 1 + SWAP COUNT S= ;                                      : INSET? ( >s >c --- tf )                                       12 + @ SWAP 12 + @ SWAP IN 0= 0= ;                              : SET-IN-SET? ( >s >c --- tf )                                  12 + @ SWAP 12 + @ SWAP SUBSET 0= 0= ;                          : SETIN? ( >s >c --- tf )                                       SWAP INSET? ;                                                   -->                                                             \ #42 CaseStatement: CaseLabels checking             11/29/89 ) : INSUBR? ( >s >c --- tf )                                      DUP 12 + @ 12 + @  ( lower limit )                              SWAP 16 + @ 12 + @ ( high limit )                               2 PICK 12 + @ <=                                                SWAP 12 + @   >= AND ;                                          : SUBRIN? ( >s >c --- tf )                                      SWAP INSUBR? ;                                                  : SET-IN-SUBR? ( >s >c --- tf )                                 DUP 12 + @ SWAP 16 + @   ( low, high )                          2 PICK INSET?                                                   ROT ROT SWAP                                                    INSET? AND ;                                                    : SUBR-IN-SET? ( >s >c --- tf )                                 SWAP SET-IN-SUBR? ;                                             -->                                                             \ #43 CaseStatement: CaseLabels checking             11/29/89 ) : SUBR-IN-SUBR? ( >s >c --- tf )                                DUP 12 + @ 12 + @ SWAP 16 + @ 12 + @  ( LOW, HIGH )             ROT DUP 12 + @ 12 + @ SWAP 16 + @ 12 + @  ( low, high )         ROT <= ROT ROT >= AND ;                                         12 12 2ARRAY CL-TAB                                             ' I/C=         1  1  CL-TAB !       ' I/C=    1  2  CL-TAB !    ' I/C=         1  3  CL-TAB !       ' I/C=    1 12  CL-TAB !    ' INSET?       1  9  CL-TAB !       ' INSUBR? 1 11  CL-TAB !    ' I/C=         2  1  CL-TAB !       ' I/C=    2  2  CL-TAB !    ' I/C=         2  3  CL-TAB !       ' I/C=    2 12  CL-TAB !    ' INSET?       2  9  CL-TAB !       ' INSUBR? 2 11  CL-TAB !    ' I/C=         3  1  CL-TAB !       ' I/C=    3  2  CL-TAB !    ' I/C=         3  3  CL-TAB !       ' I/C=    3 12  CL-TAB !    ' INSET?       3  9  CL-TAB !       ' INSUBR? 3 11  CL-TAB !    -->                                                             \ #44 CaseStatement: CaseLabels checking             11/29/89 ) ' CH=          6  6  CL-TAB !   ' INSUBR?     6 11  CL-TAB !    ' STR=         7  7  CL-TAB !                                   ' SETIN?       9  1  CL-TAB !   ' SETIN?       9  2 CL-TAB !    ' SETIN?       9  3  CL-TAB !   ' SETIN?       9 10 CL-TAB !    ' SET-IN-SET?  9  9  CL-TAB !   ' SET-IN-SUBR? 9 11 CL-TAB !    ' INSET?      10  9  CL-TAB !   ' I/C=       10 10  CL-TAB !    ' INSUBR?     10 11  CL-TAB !  ' SUBR-IN-SUBR? 11 11  CL-TAB !  ' SUBRIN?     11  1  CL-TAB !  ' SUBRIN?       11  2  CL-TAB !  ' SUBRIN?     11  3  CL-TAB !  ' SUBRIN?       11 10  CL-TAB !  ' I/C=        12 12  CL-TAB !  ' SUBR-IN-SET?  11  9  CL-TAB !  : COMP-LABELS ( >cs >cc --- tf )                                2DUP ?T SWAP ?T SWAP CL-TAB @ DUP 0=                              IF DROP 2DROP 0                                                 ELSE EXECUTE                                                    THEN ;           -->                                          \ #45 CaseStatement: CaseLabels checking             11/29/89 ) : SEARCH-LABEL ( >c --->c tf )                                  SList @                                                         BEGIN 2DUP 12 + @ SWAP 8 + @                                          2DUP 0 <> SWAP 0 <> AND                                           IF COMP-LABELS                                                     IF -1 -1                                                        ELSE 8 + @ DUP 0=                                                 IF 0 -1                                                         ELSE 0                                                          THEN                                                          THEN                                                         ELSE DROP 0 -1                                                  THEN                                                    UNTIL SWAP DROP ;                                               -->                                                             \ #46 CaseStatement: CaseLabels checking             11/29/89 ) : SEARCH-SELECT ( M --- M tf )                                  DUP 8 + @ DUP 0 <>   ( M C )                                    IF BEGIN SEARCH-LABEL 0=                                              IF 12 + @ DUP 0= IF  -1 ELSE 0 THEN                             ELSE DROP DUP 12 + @ 20 + @ CONTEXT ! -1 -1                     THEN                                                          UNTIL                                                       ELSE 0                                                          THEN ;                                                          : SEARCH-CASE (  ---  )                                         CPOP1 28 + @    ( M : CPOP annab CEL$-passi )                   BEGIN SEARCH-SELECT 0=                                                IF 16 + @ DUP 0= IF 32 MEXIT THEN 0                             ELSE -1 THEN                                              UNTIL DROP ;                                          -->       \ #47 CaseStatement: STM-LABELS.                     11/29/89 ) : STM-LABELS (  ---  |open vocabulary )                         SList @                                                         12 + @ DUP CPOP SWAP ?TYPE                                      DUP ?T 11 = IF 8 + @ THEN <>                                      IF CPOP ?T 3 > IF 32 MEXIT ( ELSE DROP ) THEN                   ELSE Rets @ 1 =                                                            IF SEARCH-CASE                                                  THEN                                                 THEN                                                          DROP 0 SList !                                                   ; IMMEDIATE                                                    ;S                                                              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             