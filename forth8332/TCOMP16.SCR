                                                                Forth  Target COMPilator to Forth-83  /nr.1 optimization/       V. 2.0.                                                                                                                         Tartu University                                                01.09.1990.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( #1 Information )   -->                                                                                                         Selles programmiosas asuvad muutujate ja konstantide kirjeldu- sed. Samuti asub siin optimiseerija.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( #2 )        HEX                                               HANDLE fcomp                                                    fcomp FILENAME TCOMP.FCO                                        VARIABLE windaddr                                               VARIABLE inflen   VARIABLE firs                                 : TCOMP infadr @   12345678 <> firs @ 0= OR                             IF fcomp OPEN-FILE IF ABORT" error " THEN                        fcomp inflen @ infadr   READ IF ABORT" error " THEN            THEN  DUP                                                        ;    DP @ 8 - windaddr !                               : SCOMP infadr @   12345678 <> firs @ 0= OR                             IF fcomp OPEN-FILE IF ABORT" error " THEN                        fcomp inflen @ infadr   READ IF ABORT" error " THEN            THEN                                                             ;      -->                                                                                                             ( #2 CONSTANT )   HEX                                            VARIABLE OLDDP                                                                                                                 : EXIT R> DROP ;  ' EXIT CONSTANT CEXIT                          <BUILDS LLIT ' LIT ' (DO) >NAME OVER -                         ' LLIT SWAP 2DUP + >R CMOVE R> DP !                             : ['] ['] LLIT , ' , ; IMMEDIATE                                                                                                                                                                                                                                                                                                                                                                                                                                   -->                                                                                                                                                                                          ( #2 CONSTANT )   HEX                                                                                                           ( siin maaratakse sonastiku viit taha poole )                                                                                       DP @ DUP OLDDP ! . infadr DP ! 12345678 ,                   WORDLIST @ NAME> 4 + @ CONSTANT CASM                            ' ['] @ CONSTANT CCOLON     ( COLON program addr. )             : HHH ; DP @ 4 - @ FORGET HHH                                          CONSTANT CSEMI      ( SEMI program addr. )               : XX <BUILDS DOES> ;                                            XX XXX  '  XXX @ FORGET XX                                      CONSTANT CDOES>                                                    -->                                                                                                                                                                                                                                                          ( #3 )                                                                                                                          infadr 10000 + CONSTANT BODP ( Begin Object Dictionary Pointer )infadr 18000 + CONSTANT BEDP                                    infadr 28000 + CONSTANT BDDP                                    VARIABLE DDP                                                    8400 CONSTANT DFB                                               DECIMAL                                                         33 CONSTANT KALF    24 CONSTANT KALO                            46 CONSTANT KALC    17 CONSTANT KALW                            20 CONSTANT KALT    35 CONSTANT KALH                            -->                                                                                                                                                                                                                                                                                                                             ( #4 konstandid )   HEX                                                                                                         ' OUT @   CONSTANT CUSERCFA                                     ' EXECUTE CONSTANT CEXECUTE                                     ' LLIT    CONSTANT C[']                                         -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #5 konstandid )                                                                                                               -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #6 VARIABLE )                                                 ' (LIT")  CONSTANT C(LIT")                                      ' (MLIT")  CONSTANT C(MLIT")                                    ' (.")    CONSTANT C(.")                                        ' TYPE    CONSTANT CTYPE                                        ' LIT     CONSTANT CLIT                                         ' RLIT     CONSTANT CRLIT                                       ' GLIT     CONSTANT CGLIT                                       ' BRANCH  CONSTANT CBRANCH                                      ' ?BRANCH CONSTANT C?BRANCH                                     VARIABLE ABI                                                    ' ABI @   CONSTANT CVARCFA                                      ' CLIT @  CONSTANT CCONSTCFA     -->                                                                                                                                                                                                                            ( #7 variables & constants     )                                VARIABLE BBPDP HEX infadr 20000 + BBPDP ! DECIMAL               VARIABLE OPTSIZE  200 OPTSIZE !  ( max length to compile )      VARIABLE TABSIZE  1 TABSIZE !   ( word in table )               VARIABLE OPTABLE                ( opt. table )                   DECIMAL 1000 13 * ALLOT                                        VARIABLE PDP                    ( Program Dictionary Pointer )  VARIABLE ODP  BODP ODP !        ( Object Dictionary Pointer )   VARIABLE EDP  BEDP EDP !        ( Ext. Dictionary Pointer )     VARIABLE BRANDY 1000 ALLOT       ( u"ldine BR tabel )           VARIABLE OPTBRAND 200 ALLOT     ( optimiseerimise BR tabel )    VARIABLE BRTBL 800 ALLOT        ( BR tabel kompileerimiseks )   VARIABLE BRTBLSZ 0 BRTBLSZ !                                    VARIABLE CRESTORE 0 CRESTORE !  ( SELLE ABIL TAASTAB SO~NAST. ) VARIABLE CRESTOREAD             ( kuhu taastada )               -->                                                             ( #8 information about OPTABLE   )                              VARIABLE NLOOP  VARIABLE LOOPAR 20 ALLOT                        VARIABLE COMINF 1 COMINF !                                      VARIABLE SUBINF 2 SUBINF !                                      VARIABLE VARINF 13 VARINF !                                     VARIABLE COWOR 20 ALLOT     ( so~nade jada, mida kompileerida ) VARIABLE NCOWOR                                                 VARIABLE WABI                                                   ' (DO)  CONSTANT        C(DO)                                   ' (?DO) CONSTANT        C(?DO)                                  ' (LOOP) CONSTANT       C(LOOP)                                 ' (+LOOP) CONSTANT      C(+LOOP)                                ' (LEAVE)  CONSTANT      CLEAVE                                 ' I       CONSTANT      CI                                      ' J       CONSTANT      CJ                                           -->                                                        ( #9 )  HEX                                                     VARIABLE [']ADR 80 ALLOT                                        VARIABLE BIP 0 BIP !                                            VARIABLE EXADR                                                  VARIABLE BPDP infadr 20000 + BPDP ! ( programmi piirkonna baas ) VARIABLE FREEM              ( Fso~nastiku DP )                 VARIABLE FBASE               ( s.o. baas F baasi suhtes )       D   CONSTANT KRET                                               1B  CONSTANT KESC   4D CONSTANT KAR                             9   CONSTANT KTAB   4B CONSTANT KAL                             3B  CONSTANT KF1    3F CONSTANT KF5                             48  CONSTANT KAU    40 CONSTANT KF6                             50  CONSTANT KAD    3C CONSTANT KF2                             4D  CONSTANT KFL    44 CONSTANT KF10                            VARIABLE OPTFIL   VARIABLE FLNR                                 -->                                                             ( #10 )  HEX                                                                                                                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( #13                                                08/31/90 )                                                                 49      CONSTANT        KPGNU                                   51      CONSTANT        KPGND                                                                                                                                                                   VARIABLE RECURS 50 ALLOT                                        VARIABLE GLVAR  ( globaalsed muutujad )                         VARIABLE GLMOD  ( globaalsed moodulid )                         VARIABLE GLUSR  ( globaalsed USERid   )                         VARIABLE CWOR                                                   VARIABLE FORGETWORD                                             VARIABLE COMPWORD                                               VARIABLE COMFIL                                                 VARIABLE ONMU     ( on muudetud tabeleid )                      -->                                                             ( #14 muutujad, mis loendavad sonu                   08/31/90 )                    DECIMAL                                      VARIABLE CARV 40 ALLOT                                          VARIABLE CPOS  6 CPOS ! 11 , 18 , 21 , 27 , 41 , 48 , 56 ,                     33 ,                                             VARIABLE PRF   ( lipp, mis na"itab, kas kasutada tru"kkalit )   VARIABLE TAHTP  7 TAHTP !                                       VARIABLE TAHTV  1 TAHTV !                                       VARIABLE YLDP   0 YLDP !                                        VARIABLE YLDV   7 YLDV !                                        VARIABLE REAP   7 REAP !                                        VARIABLE REAV   0 REAV !                                        VARIABLE RAAMP  0 RAAMP !                                       VARIABLE RAAMV  7 RAAMV !                                       VARIABLE VANAP  0 VANAP !                                       VARIABLE VANAV  7 VANAV ! -->                                   ( #15 STACK COMMANDS                                 08/31/90 ) DECIMAL                                                         VARIABLE RS 0 RS !                                              VARIABLE STACK  200     ALLOT                                                                                                   : ?RS RS @ ; 100 ALLOT                                          : PUSH  ?RS  50 > IF ABORT" COMPILE-STACK OVERFLOW " THEN               ?RS 4 * STACK  +  ! ?RS 1+ RS ! ;                                                                                       : POP   ?RS 0= IF ABORT" COMPILE-STACK EMPTY " THEN                     ?RS 1- DUP RS ! 4 * STACK  +  @ ;                       : GET   ?RS 1- 4 * STACK +  @ ;                                 -->                                                                                                                                                                                                                                                             ( #16 Siia tuleb va"rvide sa"ttimine                 08/31/90 )                                                                 : COLTA TAHTP @ BACKGROUND TAHTV @ FOREGROUND ;                 : COLYL YLDP @ BACKGROUND YLDV @ FOREGROUND ;                   : COLRE REAP @ BACKGROUND REAV @ FOREGROUND ;                   : COLRA RAAMP @ BACKGROUND RAAMV @ FOREGROUND ;                 : COLOL VANAP @ BACKGROUND VANAV @ FOREGROUND ;                 HEX : 2/ DUP 0 < IF 7FFFFFFF AND 2/ 40000000 OR                                   ELSE 2/ THEN ;                                : 8*  2* 2* 2* 2* 2* 2* 2* 2* ;                                 : 8/  2/ 2/ 2/ 2/ 2/ 2/ 2/ 2/ ;                                 : >H<  DUP FF AND 8* OVER FF00 AND                                     8/ OR SWAP FFFF0000 AND OR ;                             : ><   >H< DUP FFFF AND 8* 8* SWAP FFFF0000 AND                        8/ 8/ OR  >H< ;                                           -->                                                            ( #17  abi programmid                                08/31/90 )                                                                 ( vaadatakse, kas aadress langeb piirkonda )                    : ?OKAY ( algus, lo~pp, addr )                                          2DUP <= IF 0                                                             ELSE                                                             2 PICK OVER > IF 0                                              ELSE 1                                                         THEN THEN ;                                    ( lu"litab antud aadressi BRANCH'ide tabelisse )                ( liidab loendajale juurde N addr )   DECIMAL                   : CLI  4 * CARV + DUP @ ROT + SWAP ! ;                          : CPR  [COMPILE] DECIMAL                                               4 * DUP CPOS + @ 12 GOTOXY CARV + @ . [COMPILE] HEX ;    : CINC 1 OVER CLI CPR ;                                              -->                                                        ( #18 lulitab aadressi jadasse                       08/31/90 )                                                                 ( lu"litab aadressi ahelasse )                                  : BRANDSET  BEGIN  ( addr, jada addr   PANEB addr jadasse )                  DUP @ ?DUP IF 0 <                                                IF ! 1 ELSE 4 + 0 THEN                                         ELSE SWAP OVER ! 4 + 0 SWAP ! 1 THEN                           UNTIL ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -->                                                             ( #19 muutujad, mida kasutatakse optimiseerimisel    08/31/90 ) HEX                                                             VARIABLE OPTF 100 ALLOT  ( siia toimub optimiseerimine )        VARIABLE OPTC                                                   VARIABLE OPTS 100 ALLOT  ( optimiseerimiseks imiteeriv mag. )   VARIABLE OPTSP                                                  VARIABLE INDIK                                                  VARIABLE REGTAB 50 ALLOT                                        VARIABLE OPAB                                                   : ?BR> OPTBRAND BEGIN                                                   DUP @ ?DUP                                                      IF DUP H@ >H< DUP 8000 AND IF FFFF0000 OR THEN                   4 * + 2- 2 PICK = IF DROP 0 1 ELSE 4 + 0 THEN                   ELSE DROP 1 1 THEN                                            UNTIL ;                                                  -->                                                             ( #20 abi programmid optimiseerimiseks               12/02/90 )                                                                 : OPT, OPTF OPTC @ + ! OPTC @ 4 + OPTC ! ;                      : CLROPTF 0 OPTC ! ;                                                                                                            : CLROPTAB 8 0 DO 0 I 5 * REGTAB + ! LOOP ;                     : 6* 2* 2* 2* 2* 2* 2* ;                                                                                                        : ?POP  DUP @ 00FFBFFF AND 0000B000 =                                   IF DUP @ F0000000 AND  IF 0 ELSE 1 THEN                          ELSE 0 THEN ;                                          : ?PUSH DUP @ 00FFBFFF AND 0000B000 =                                  IF DUP @ F0000000 AND  IF 1 ELSE 0 THEN                          ELSE 0 THEN ;                                               -->                                                                                                                         ( #21 BR tabel kontroll ja parandamine               08/31/90 ) ( algus pikkus  -->  algus pikkus )  VARIABLE OPAB1             : CHECKBR OPTBRAND   BEGIN  0 OPAB1 !                                      DUP >R @  ?DUP                                           IF  2 PICK > IF DUP OPAB1 ! R@ @ OVER + ( kas BR nihkunud )                DUP R@ ! ELSE R@ @ THEN  ( algus lqpp BRaddr )                DUP H@ >H< DUP 8000 AND IF FFFF0000 OR THEN                   4 * OVER + 2- 0 OPAB ! 2DUP >  IF SWAP 1 OPAB ! THEN   3 PICK OPAB1 @ + ( 3 PICK + SWAP 4 + SWAP 04.12.1990. ) ?OKAY               IF DROP 4 + OPAB @ IF SWAP THEN OVER - 4 /                       2 PICK 4 / OPAB @ IF - 2+ SWAP 4 - SWAP                         ELSE + THEN >H< SWAP H!                                         ELSE 2DROP DROP  THEN                                         R> 4 + 0                                                        ELSE R>                                                        THEN  UNTIL ;                    -->                ( #22 optimiseerimise tulemusel kokkusurumine        08/31/90 ) ( bloki algus  lopp  bloki lopp --> uus algus  uus lopp )       : SETOPTF                                                                  2DUP - >R   ( tagasi tostetava bloki pikkus )                   2 PICK - DUP OPAB ! -  ( uus lopp )                          OVER DUP OPAB @ + SWAP  R@ CMOVE ( sai kokku tommatud )            OVER DUP OPTC @ + R> CMOVE>                                     OVER OPTF SWAP OPTC @ CMOVE ( kompu )                           OPTC @ +   ( vana algus   uus lopp )                            SWAP OPTC @ OPAB @ -                                            ?DUP                                                             IF CHECKBR DROP THEN                                           OPTC @ + SWAP  ;                                                                                                                                                                                     -->                                             ( #23 POP'ide ellimineerimine                        08/31/90 ) ( algus lopp  --> uusalgus uuslopp )                            : POPEL  CLROPTF OVER DUP @ >< 7 AND                                     Rn1<-Rn2 OR >< OPT,                                             4 + ?POP                                                        IF DUP @ >< 7 AND Rn1<-Rn2 OR 40 OR >< OPT,                      4 + BEGIN                                                        ?POP IF DUP @ >< 7 AND 2* 2* 2* 2*                               Rn1<-(-A6) OR OPT, 4 + 0                                        ELSE 1                                                         THEN UNTIL                                                     Rn1<-(-A6) OPT, Rn1<-(-A6) 10 OR OPT,                           ELSE                                                             Rn1<-Rn2 40 OR >< OPT, Rn1<-(-A6) 10 OR OPT,                  THEN                                                          SETOPTF ; -->                                            ( #24                                                12/02/90 ) : SETREGS 8 0 DO I 5 * REGTAB +                                        DUP C@ IF DUP 1+ @ I <>  IF                                           REGTAB  BEGIN                                                    DUP REGTAB - 5 / 8 <> IF DUP C@ IF                               DUP 1+ @ I = IF 1 1 ELSE 5 + 0 THEN                             ELSE 5 + 0 THEN ELSE DROP 0 1 THEN UNTIL                       IF 0 OVER C! 7 BEGIN DUP 5 * REGTAB + C@                         IF 1- 0 ELSE DUP Rn1<-Rn2 OR                                     I  6* OR >< OPT, SWAP REGTAB - 5 /                      5 * REGTAB + 1 OVER C! 1+ ! 1 THEN                                      UNTIL                                                          THEN                                               0 OVER C! 1+ @  6* Rn1<-Rn2 OR                                      I OR >< OPT, ELSE 0 SWAP ! THEN                                ELSE DROP THEN LOOP  ;         -->                         ( #25 paneb magasini info opt. va"ljale              09/01/90 ) : SETPUSH OPTSP @ ?DUP                                                     IF Rn1->(A6+) 10 OR OPT,                                        DUP 1 =                                                         IF DROP Rn1<-Rn2 1 OR >< OPT,                                      Rn1<-Rn2 OPTS 1+ @ 6* OR >< OPT,                              ELSE  Rn1->(A6+) OPT, 2-                                        BEGIN  ?DUP                                                      IF OPTSP @ 2- OVER - 5 * 1+ OPTS + @                             2* 2* 2* 2* Rn1->(A6+) OR OPT, 1- 0                             ELSE 1 THEN UNTIL                                  Rn1<-Rn2 OPTSP @ 2- 5 * 1+ OPTS + @ 6* OR 1 OR >< OPT,          Rn1<-Rn2 OPTSP @ 1- 5 * 1+ OPTS + @ 6*  OR >< OPT, THEN THEN    8 0 DO I 5 * REGTAB + DUP C@ 3 = IF 0 SWAP C!                                                     ELSE DROP THEN   LOOP            SETREGS              ;         -->                          ( #25 PUSH'ide ellimineerimine                       09/01/90 ) ( algus lopp --> uusalgus uuslopp )                                                                                             : PUSHEL  0 INDIK ! OVER BEGIN  2DUP <> IF ?PUSH                           IF 1 INDIK !                                                     OPTSP @ 5 * OPTS + 1 OVER C! ( lipp=register )                  1+ OVER @ >< 7 AND                                              DUP 5 * REGTAB + DUP C@                                         IF 3 OVER C! 1+ @ SWAP THEN  DROP                               SWAP ! ( registri nr. paika )                                   OPTSP @ 1+ OPTSP ! 4 + 0                                        ELSE                                                                                                                                                                                                                                                            -->                                                 ( #26 jatkuu  uurib POP'i                            09/07/90 )                                                                              ?POP                                                            IF  INDIK @ 1 = IF CLROPTAB 0 INDIK ! THEN ?BR>                  IF  ( kontrollib, kas suunamine sellesse solme )                OPTSP @ IF  OPTSP @ 1- DUP OPTSP !                               5 * OPTS + DUP C@ 2 PICK @ >< 7 AND                             5 * REGTAB +                                                    DUP >R C! 1+ @ R> 1+ ! 4 + 0                                    ELSE 1 THEN   ELSE 1 THEN                                      ELSE 1 THEN  THEN  ELSE 1 THEN                                UNTIL  SETPUSH                                                   SETOPTF  ;  -->                                                                                                                                                                                                                                    ( #27  OPTIMISEERIMINE                               09/01/90 ) HEX                                                             ( algus, lo~pp/+1/ -> uus lo~pp )                               : FW->OPTFW  ( Forth Word -> OPTimization Forth Word   )                   [COMPILE] HEX                                                   BEGIN  0 OPTSP ! CLROPTAB 0 OPTC !                               OVER ?POP                                                       IF DROP  POPEL                                                   ELSE ?PUSH                                                      IF DROP  PUSHEL                                                  ELSE DROP SWAP 4 + SWAP                                       THEN  THEN                                                      2DUP =                                                          IF SWAP DROP 1 ELSE 0 THEN                                     UNTIL ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              