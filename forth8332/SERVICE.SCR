( TTS "Tartu" teenindusprogrammid                    11/12/87 ) ;S                                                                                                                              Copyright (c) 1987                                              Viljo Soo                                                       Programmeerimise kateeder                                       Tartu Riiklik Ylikool                                           Liivi 2                                                         Tartu, 202400                                                                                                                   fail on loodud 12 Nov 1987                                                                                                                                                                                                                                                                                                                                                                      ( WGR PARMOUT GETS#                                  04/20/88 ) : WGR LIT" GRA" ATFILE MKEXT                                     0 PRVIIT PRODARV @ PRVIIT OVER - ATFILE LWRITE                         ATFILE CLOSE-FILE ?DISCERR ;                            : PARMOUT LIT" PAR" ATFILE MKEXT                                0 %PARM %PARML @ ATFILE LWRITE ATFILE CLOSE-FILE ?DISCERR ;     : SALVGRA WGR PARMOUT ;                                         : GETS# ( --- n )                                               BL WORD DUP @ 1-                                                        IF NUMBER DROP DUP DIMCONST <                                      IF DUP 1+ SYMBARV @ MAX                                            DUP SYMBARV ! TERMARV @ - NTARV !                            ELSE 7 EMIT CR . ." Liiga suur symboli nr." ABORT               THEN ELSE DROP 0                                             THEN ;                                                  -->                                                             ( ER                                                 04/16/88 ) : ER ( prodnr --- )                                                     CR DUP GRAMCONST <                                              IF DUP 1+ PRODARV @ >                                              IF DUP 1+ PRODARV ! ASCII N EMIT THEN                        ELSE 7 EMIT CR . ." Liiga suur reegli nr." ABORT                THEN ASCII P EMIT DUP . QUERY                                   PRVIIT GETS# OVER PV! BL WORD DROP 0 >R                         BEGIN GETS# ?DUP                                                WHILE OVER R> 1+ DUP >R PI!                                     REPEAT R> 1+ SWAP P#! 0 TIB ! 0 >IN ! ;                 : PR PRVIIT .RULE ;                                             : ED DUP PR ER ;                                                                                                                                                                                                                                                (                                                    04/15/88 ) : CONSTR23 INITMEM SYMBARV @ %OSYMBARV !                                   LIT" CONSTRF2BIN" PHEXEC                                        LIT" CONSTRF3BIN" PHEXEC ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( System messages )                                             empty stack                                                     dictionary full                                                 has incorrect address mode                                      is redefined                                                    is undefined                                                    disk address out of range                                       stack overflow                                                  disk error                                                                                                                                                                                                                                                                                                                      BASE must be DECIMAL                                            missing decimal point                                           PC/FORTH 2.0                             Laboratory Microsystems( System messages )                                             compilation only, use in definition                             execution only                                                  conditionals not paired                                         definition not finished                                         in protected dictionary                                         use only when loading                                           off current editing screen                                      declare vocabulary                                                                                                                                                                                                                                              illegal dimension in array definition                           negative array index                                            array index too large                                                                                                           ( 8086 Assembler messages )                                     16 bit register not allowed                                     8 bit register not allowed                                      address out of range                                            immediate data value not allowed                                missing source register                                         missing destination register                                    illegal operation                                               illegal operand                                                 instruction not implemented                                     illegal destination register                                    illegal source register                                         illegal condition code                                          register mismatch                                               destination address missing                                                                                                     \ #7 Service: BAAS LANGFILE FILELEN SBAAS CTAB RCNAME11/25/87 ) HERE CONSTANT OVERLAY                                           : LANGFILE CR ." Enter Translator Name: "                               ATFILE INPUT-FILENAME                                           ATFILE DROP 4 + DUP COUNT + ASCII . SWAP C!                     DUP C@ 4 + SWAP C! ;                                    : FILELEN ( --- len )                                                   ATFILE ?FILESIZE D>S 0 ATFILE INITSA ;                  : OK? ." OK? (Y/N) :" KEY DUP EMIT ASCII Y = 0= IF ABORT THEN ; VAR SBAAS  VAR SLQPP                                            DIMCONST ARRAY CTAB                                             : RCNAME LIT" CDE" ATFILE OPEXT                                         0 CTAB FILELEN ATFILE LREAD DROP                                LIT" SYM" ATFILE OPEXT                                          HERE DUP SBAAS ! FILELEN DUP ?ALLOT ATFILE LREAD DROP           HERE SLQPP ! ; -->                                      \ #8 Service: EMITFILE UEMIT UTYPE HEMIT HTYPE       11/25/87 ) HANDLE EMITFILE                                                 HEX 0140 CONSTANT UEMIT                                             0146 CONSTANT UTYPE DECIMAL                                 : HEMIT ( c --- )                                                       DUP (EMIT)                                                      SP@ >R EMITFILE 1 R> WRITE ?DISCERR 2DROP ;             : HTYPE ( addr l --- )                                                  2DUP type                                                       EMITFILE 2SWAP SWAP WRITE ?DISCERR DROP ;               VAR 'HEMIT ' HEMIT OVERLAY - 'HEMIT !                           VAR 'HTYPE ' HTYPE OVERLAY - 'HTYPE !                           : ?ECHO ( --- flag )                                                    EMITFILE SWAP DROP ;                                    : RGR LIT" GRA" ATFILE OPEXT                                            GRAMMAR FILELEN ATFILE LREAD DROP ; -->                 \ #9 Service: PARMIN INITSERV EMKEY ?KEY ERALIN PAGE?11/25/87 ) : PARMIN LIT" PAR" ATFILE OPEXT                                         0 %PARM %PARML @ ATFILE LREAD DROP ;                    22 CONSTANT PGLEN   VAR #ROW                                    : EMKEY BEGIN ?TERMINAL WHILE KEY DROP REPEAT ;                 : ?KEY ( c --- )                                                 EMKEY BEGIN KEY OVER = UNTIL DROP ;                            : ERALIN 13 EMIT 80 SPACES 13 EMIT ;                            : PAGE? ?ECHO 0=                                                        IF #ROW @ 1+ PGLEN >                                               IF CR ." Press Enter to proceed..."                                13 ?KEY ERALIN -1 #ROW ! CR                                  THEN                                                         THEN 1 #ROW +! ;                                        : UUSRIDA PAGE? CR 0 OUT ! ;                                                             -->                                    \ #10 Service: UUSRIDA INTERVAL .SYMB                11/25/87 ) : INTERVAL ( max --- end beg )                                          QUERY BL WORD DUP 1+ C@ ASCII * =                               IF DROP 0                                                       ELSE 0 0 ROT CONVERT SWAP DROP ( max beg addr )                    DUP C@ ASCII - =                                                IF 0 0 ROT CONVERT 2DROP 1+ ( max beg end )                     ELSE DROP OVER MIN DUP 1+                                       THEN 2DUP <                                                     IF ROT MIN SWAP                                                 ELSE 3DROP 0 0                                                  THEN                                                         THEN ;                                                  : NIMEAADR ( kood --- naadr )                                           CTAB @ SBAAS @ + ;                                      : NCOUNT ( naadr --- taadr l ) COUNT 127 AND ;     -->          \ #11 Service: CD->SYM HTAB ?JATK PRODLQPP STEXT     11/25/87 ) VAR RPIKK C/L RPIKK ! 5 CONSTANT VALG   31 CONSTANT VPIKK        16 CONSTANT NALG    20 CONSTANT PARALG 31 CONSTANT SPIKK       : HTAB  ( pos --- )                                                     OUT @ - DUP 0> IF SPACES ELSE DROP THEN ;               : ?JATK ( l --- )                                                       OUT @ + RPIKK @ < 0=                                            IF UUSRIDA PARALG HTAB THEN ;                           : PRODLQPP 1 ?JATK ASCII ; EMIT ;                               : STEXT ( kood pikkus --- )                                             >R DUP CTAB @                                                   IF NIMEAADR NCOUNT R> MIN                                          DUP 1+ ?JATK TYPE                                            ELSE 5 ?JATK ." #" . R> DROP                                    THEN SPACE ; -->                                                                                                        \ #12 Service: PRNR PRNOOL VASAK PARSYMB .RULE       11/25/87 ) : PRNR ( rnum --- ) ASCII P EMIT . ;                            : PRNOOL NALG HTAB ." ==> " ;                                   : VASAK ( praddr --- )                                                  VALG HTAB PV VPIKK STEXT ;                              : PARSYMB ( praddr i --- )                                              PI SPIKK STEXT ;                                        : .RULE ( praddr --- )                                                  DUP VASAK PRNOOL PARALG HTAB DUP P# 1                           DO DUP I PARSYMB                                                LOOP DROP PRODLQPP ;                                    : S, HERE SYMBCONST ?ALLOT S! ;                                 -->                                                                                                                                                                                                                                                             \ #13 Service: LEFT RIGHT ADDREF ADDLEFT ADDRIGHT    11/25/87 ) DIMCONST ARRAY LEFT DIMCONST ARRAY RIGHT                        VAR FIKT 0 FIKT ! -1 ,                                          ( rule addr --- )                                               : ADDREF DUP @ FIKT ! SWAP FIKT                                         BEGIN ( addr rule addr1 )                                          2DUP 2+ @ > OVER @ AND                                       WHILE @                                                         REPEAT 2DUP 2+ @ -                                              IF HERE OVER @ , SWAP ! ,                                       ELSE 2DROP                                                      THEN FIKT @ SWAP ! ;                                    ( symb rule --- )                                               : ADDLEFT  SWAP LEFT  ADDREF ;                                  : ADDRIGHT SWAP RIGHT ADDREF ;                                          -->                                                     \ #14 Service: BUILDXREF                             11/25/87 ) : BUILDXREF 0 LEFT  DIMCONST 2* ERASE                                       0 RIGHT DIMCONST 2* ERASE                                   PRODARV @ 0                                                     DO I PRVIIT DUP PV I ADDLEFT                                       DUP P# 1                                                        DO DUP I PI J ADDRIGHT                                          LOOP DROP                                                    LOOP ;                                                  : INITSERV LANGFILE PARMIN RGR BUILDXREF RCNAME ;               : .SYMBOL ( symb --- )                                                  DUP 4 .R ." ) " SPIKK STEXT ;                           : J@RGMNIMI ( naadr1 --- naadr2 )                                       NCOUNT + SYMBCONST + ;                                    -->                                                                                                                           \ #15 Service: .REF XREF                             11/17/87 ) : .REF ( addr --- )                                                     BEGIN DUP @                                                     WHILE @ DUP 2+ @ 4 ?JATK 4 .R                                   REPEAT DROP ;                                           : XREF 0 RIGHT @ 0=                                                     IF BUILDXREF THEN                                               UUSRIDA ." Enter Symbol Code(s) [* for ALL]: "                  SYMBARV @ INTERVAL                                              ?DO UUSRIDA I .SYMBOL                                               NALG HTAB I LEFT @                                              IF ." L: " I LEFT .REF UUSRIDA                                  THEN NALG HTAB ." R: " I RIGHT .REF                         LOOP ;                                                     -->                                                                                                                          \ #16 Service: CD->SYM RULELIST SYM->CD              11/14/87 ) : CD->SYM UUSRIDA ." Enter Symbol Code(s) [* for ALL]: "                SYMBARV @ INTERVAL                                              ?DO UUSRIDA .SYMBOL                                             LOOP CR ;                                               : RULELIST UUSRIDA ." Enter Rule Number(s) [* for ALL]: "               PRODARV @ INTERVAL                                              DO UUSRIDA I PRNR I PRVIIT .RULE                                LOOP ;                                                  : SYM->CD UUSRIDA ." Enter Symbol Name: " QUERY BL WORD                 SBAAS @ 1+                                                      BEGIN 2DUP OVER C@ 1+ S= 0=                                     WHILE J@RGMNIMI DUP SLQPP @ U>                                        IF 7 EMIT 2DROP EXIT THEN                                 REPEAT COUNT + S@ 5 .R DROP ; -->                                                                                       \ #17 Service: NIMEAADR KUSTUNIMI NIMILQPPU UUSNIMI  10/30/88 ) : KUSTUNIMI ( kood --- )                                                NIMEAADR DUP C@ 128 OR SWAP C! ;                        : NIMILQPPU ( aadr --- naadr )                                          HERE >R COUNT 31 MIN                                            DUP C, DUP ?ALLOT                                               R@ 1+ SWAP CMOVE R> ;                                   : UUSNIMI ( kood --- ; nimi loetakse sisendvoost )                      DUP SYMBARV @ < OVER TERMARV @ >= AND                           IF BL WORD NIMILQPPU                                               OVER DUP S, KUSTUNIMI SBAAS @ - SWAP CTAB !                  ELSE ." Symbol code" . ." out of range"                            TERMARV @ . ." .." SYMBARV @ 1- . ASCII ! EMIT                  SHOW-ERROR                                                   THEN ; -->                                                                                                              \ #18 Service: RN TQMBANIMI MITTEKUSTU               10/30/88 ) : RN ( kood --- ; kasut. kujul <kood> RN XXXX )                         UUSRIDA DUP .SYMBOL DUP UUSNIMI                                 ." replaced by " SPIKK STEXT ;                          : TQMBANIMI ( vaadr1 uaadr1 --- vaadr2 uaadr2 )                         2DUP U>                                                         IF 2DUP OVER C@ 127 AND 1+ SYMBCONST + DUP >R CMOVE                DUP SBAAS @ - OVER NCOUNT + S@ CTAB !                           R@ + SWAP R> + SWAP                                          ELSE DROP J@RGMNIMI DUP                                         THEN ;                                                  : MITTEKUSTU ( naadr1 --- naadr2 ; esimene mittekustutatud )            BEGIN DUP C@ 128 AND                                            WHILE J@RGMNIMI DUP HERE U>                                        IF EXIT THEN                                                 REPEAT ; -->                                            \ #19 Service: PAKINIMED WSTAB                       10/30/88 ) : PAKINIMED SBAAS @ 1+ DUP                                              BEGIN ( vaadr uaadr ; vaadr>=uaadr )                               SWAP MITTEKUSTU                                                 DUP HERE U<                                                  WHILE SWAP TQMBANIMI                                            REPEAT J@RGMNIMI DP ! DROP ;                            : WSTAB ( Symbolite tabel faili )                                LIT" CDE" ATFILE MKEXT 0 CTAB SYMBARV @ 2* ATFILE LWRITE        LIT" SYM" ATFILE MKEXT SBAAS @ HERE OVER - ATFILE LWRITE        ATFILE CLOSE-FILE ?DISCERR ;                                      -->                                                                                                                                                                                                                                                                                                                          \ #20 Service: ECHO ECHO-OFF SERVICE                 11/25/87 ) : ECHO ?ECHO 0=                                                        IF CR ." Enter File Name for echo: "                               EMITFILE INPUT-FILENAME                                         EMITFILE OPEN-FILE 0=                                           IF CR ." File " EMITFILE .FILENAME ." already exists!"             OK?                                                          ELSE EMITFILE MAKE-FILE ?DISCERR                                THEN                                                         THEN 'HEMIT @ OVERLAY + UEMIT !                                 'HTYPE @ OVERLAY + UTYPE ! ;                             : ECHO-OFF ['] (EMIT) UEMIT ! ['] type UTYPE ! ?ECHO                    IF EMITFILE CLOSE-FILE ?DISCERR THEN ;                  : SERVICE INITSERV                                                      CR ." Type RULELIST , XREF , CD->SYM or SYM->CD " ;                            ;S                                       \ #21 BIN-faili moodustamine                         11/25/87 ) HANDLE BINFILE  VAR PAR 126 ALLOT PAR 128 ERASE                 : OK? ." OK? (Y/N) :" KEY DUP EMIT ASCII Y = 0= IF ABORT THEN ; : BSAVE CR ." Enter binary file name: " BINFILE INPUT-FILENAME          CR ." Enter first FORTH-word to save: " QUERY '                 >NAME HERE OVER - 127 + 128 / 128 * PAR !                       DUP PAR 4 + !                                                   LATEST N>LINK SWAP - PAR 2+ ! VOC-LINK @ PAR 6 + !              CR ." Enter first visible FORTH-word: " QUERY '                 >LINK PAR 4 + @ - PAR 8 + !                                     CR CR ." Size                    = " PAR @ U.                      CR ." Last LFA displacement   = " PAR 2+ @ U.                   CR ." First NFA               = " PAR 4 + @ U.                  CR ." Voc-link                = " PAR 6 + @ U.                  CR ." Visibility displacement = " PAR 8 + @ U.       -->                                                             ( #22 BIN-faili moodustamine  <j@rg>                 11/25/87 )         BINFILE OPEN-FILE 0=                                            IF CR ." File " BINFILE .FILENAME ."  already exists!"          THEN CR OK? BINFILE MAKE-FILE                                   IF ." Can't create " BINFILE .FILENAME                          THEN BINFILE PAR @ ( 127 + 128 / 128 * ) PAR 4 + @              WRITE 8 ?ERROR BINFILE 128 PAR WRITE 8 ?ERROR                   BINFILE CLOSE-FILE 8 ?ERROR ."  Saved" CR ;             ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              \ #23 Service: loading binary file                   11/23/87 ) : SETBIN  HIDDEN LIT" SERVICE BIN" 1+                                   BINFILE SET-FCB ;                                       : SERVICE HERE ( first new NFA )                                        SETBIN HIDDEN                                                   HERE BGET HERE 8 + @ OVER + !                                   DUP NAME> >BODY !                                               FORTH LATEST NAME> EXECUTE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            