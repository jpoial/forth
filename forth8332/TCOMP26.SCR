                                                                Forth TCOMPilator to Forth-83 /nr.2 comilation/                 V. 1.0.                                                                                                                         Tartu University                                                01.09.1990.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( #1 ) -->                                                                                                                                                                                                                                                      *****************************************************************                                                              **               Siit algab kompilaatori osa                    **                                                              *****************************************************************                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( #2  programs to work with  OBJ & PROG areas        08/30/90 )  DECIMAL                                                        : DC, DDP @ C! DDP @ 1+ DDP ! ;                                 : DH, DDP @ H! DDP @ 2+ DDP ! ;                                 : D,  DDP @ !  DDP @ 4 + DDP ! ;                                : OC,  ODP @ C! ODP @ 1+ ODP ! ;  ( byte -> OBJ area )          : OH,  ODP @ H! ODP @ 2+ ODP ! ;  ( 2 bytes -> OBJ area )       : O,   ODP @ !  ODP @ 4 + ODP ! ; ( 4 bytes -> OBJ area )       : PC,  PDP @ C! PDP @ 1+ PDP ! ;  ( byte -> PROG area )         : PH,  PDP @ H! PDP @ 2+ PDP ! ;  ( 2 bytes -> PROG area )      : P,   PDP @ !  PDP @ 4 + PDP ! ; ( 4 bytes -> PROG area )      : !OLD SWAP ! ;         : @OLD @ ;        ( R/W vana alguse )   : !NEWB SWAP 4 + ! ;    : @NEWB 4 + @ ;   ( uue algus )         : !NEWE SWAP 8 + ! ;    : @NEWE 8 + @ ;   ( uue lo~pp )         : !FLAG SWAP 12 + C! ;  : @FLAG 12 + C@ ; ( so~na tunnus )      -->                                                             ( #3                                                 08/30/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #4 otsib tabelist etteantud aadressi ja"rgi        08/30/90 ) 10 ALLOT     DECIMAL                                            ( FIND WORD    word addr. -> table addr OR zero /cannot found/ ): FINDTAB                                                                   OPTABLE 1 >R   ( counter -> RS )                                BEGIN                                                            R@     TABSIZE @ =       ( ? counter=table size )               IF R> 2DROP DROP 0 1          ( cannot find )                    ELSE                                                             2DUP @ =                                                        IF SWAP DROP R>    ( OK! addr->S )                               ELSE R> 1+ >R 13 + 0       ( next word )                       THEN                                                          THEN                                                           UNTIL  ;                                                -->                                                         ( #5 kontrollib, millega on tegemist CFA va"ljal     08/30/90 )                                                                 ( this is COLON   IR RWA <RWA> -> flag  )                       : ?COLON DUP  CCOLON = ;                                        ( this is SEMI    IR RWA <RWA> -> flag )                        : ?SEMI OVER   CSEMI = ;                                        ( this is ASM program  IR RWA <RWA> -> IR RWA flag )            : ?ASM  DUP 4 + @ CASM   =  ;                                                                                                                                                                   -->                                                                                                                                                                                                                                                                                                                                                                                             ( #6  taastab rekursiooni aadressi | MOV->OBJ        08/30/90 )  ( taastab so^nastikku 4 baiti )                                : RESTADR CRESTORE  @ ?DUP IF                                              CRESTOREAD @ ! 0 CRESTORE !                                     THEN  ;                                                                                                                                                                                                        DECIMAL                                ( baas , nihe  -> #   paneb adr MOV'imise objekti )            : MOV->OBJ R2<-() OH, >H< OH,                                              PUSHR2  O,                                                       ;                                                                                                                   : MOV->OBJ# R2<-# OH, >H< OH,                                              PUSHR2  O,  ;                                        -->                                                             ( #7 vaatab, millist lippu panna | uus so~na tab'sse 08/30/90 ) (  table addr -> 0:comp  OR  4:set call  )                      : ?COMPWORD DUP  @NEWE OVER @NEWB - OPTSIZE @ >                             IF 3 !FLAG 1                                             ELSE 0 !FLAG 0  THEN                                                ;                                                                                                                                                                                      (  so~na addr. -> tabeli addr   paneb so~na tabelisse )         : SETNEW  DUP FINDTAB ?DUP IF SWAP DROP ELSE                              TABSIZE @ 1- 13 * OPTABLE +  ( tabeli addr )                    TABSIZE @ 1+ TABSIZE ! ( tabelis u"ks rohkem )                  SWAP OVER ! DUP 255 !FLAG DUP 0 !NEWB DUP 0 !NEWE               THEN ; -->                                                                                                                                                                            ( #8 assembler programmi to~stmine so~nastikust      08/30/90 )                                                                 ( kust , kuhu -> kuhuni  kompileerib kuni JMP NEXT'ini )        : COMPMOV     BEGIN                                                          OVER @  DUP JMPA <>                                          IF OVER  ! 4 + SWAP 4 + SWAP 0                                      ELSE      ( oli JMP )                                            DROP SWAP DROP 1   ( jo~udis JMP'ini )                        THEN                                                           UNTIL   ;                                           -->                                                                                                                                                                                                                                                                                                                                                                                             ( #9     lu"litab ['] aadressid ma"llu               08/30/90 )  ( tabel, [']tabeli adr )                                       : SETING OVER DUP @NEWB SWAP @FLAG 4 = IF 2- THEN                        OVER @ ODP ! BPDP @ -                                           2/ 2/ MOV->OBJ#  ;                                      ( tabeli adr,mille kompileerimine lo~petati )                  : SET[]AD [']ADR BEGIN                                                      DUP @ ?DUP IF @ 2 PICK @OLD = IF                               SETING  -1 OVER  ! THEN 4 + 0                                    ELSE 2DROP 1  THEN                                             UNTIL   ;                                                                                                                                                                            -->                                                                                                                                                                                             ( #10  operatsioonid po~hi BR tabeliga               08/30/90 )                                                                 : MOVBRADR  ( jada addr, algus, lopp, uue piirk algus )                     >R BRANDY >R BEGIN                                              R@ @ ?DUP IF DUP 0 < IF DROP R> 4 + >R 0                        ELSE ?OKAY IF 2 PICK - R> R@ SWAP 4 + >R                         + 3 PICK BRANDSET 0 ELSE DROP R> 4 + >R 0 THEN                 THEN                                                            ELSE R> R> 2DROP 2DROP DROP 1 THEN                              UNTIL   ;                                                   -->                                                                                                                                                                                                                                                                                                                                                                                     ( #11                                                08/30/90 ) ( tabeli addr. , kuhu -> kuhuni   so~na on juba to~stetud tab. )                                                                : OBJMOV OVER BRANDY SWAP DUP @NEWB SWAP @NEWE                           3 PICK MOVBRADR  ( kopeerib BR addr )                            DUP >R  SWAP DUP @NEWB ( kust to~sta )                          DUP ROT @NEWE SWAP - ( pikkus )                                 >R SWAP R@ CMOVE  R> R> + ;                                                                                           : ERABRADR  BRANDY >R  ( algus, lopp - koristab liigsed adr )                BEGIN                                                            R@ @ ?DUP IF DUP 0 < IF DROP R> 4 + >R 0 ELSE                    ?OKAY IF -1 R@ ! THEN DROP R> 4 + >R 0 THEN                    ELSE 2DROP R> THEN                                              UNTIL  ;       -->                                                                                                ( #12                                                08/30/90 )                                                                                                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #13 abiks alamprogrammi moodustamisel              08/30/90 ) : OADP  DUP ABI ! DUP @NEWB SWAP @NEWE 1 >R                             BEGIN    ( otsib so~nad, mis vaja abi piirk> kanda )        TABSIZE @ R@  = IF  R> 2DROP DROP 1 ELSE                              R@ 1- 13 * OPTABLE + R>  1 + >R DUP ABI @ =                     IF DROP 0 ELSE                                                   DUP @FLAG  0 =                                                  IF DUP >R @NEWB ?OKAY                                            IF DROP   R>   (  tabadr )                             EDP @ 2DUP OBJMOV DUP EDP ! 2 PICK SWAP !NEWE  !NEWB                    0 ELSE R> 2DROP 0 THEN                                          ELSE DROP 0 THEN                                               THEN THEN  UNTIL                                      0 OPTBRAND !  OPTBRAND ABI @ DUP @NEWB SWAP @NEWE PDP @ MOVBRADR   IF ABI @ DUP @NEWB SWAP @NEWE ERABRADR THEN ; -->                                                                            ( #14  lu"litab so~na OBJ -> PROG. area              08/30/90 )                                                                 ( tabelis kood 4 - programm on OBJ'ktis -> PROG, 4->3 )         : SETOBJCALL  [COMPILE] HEX                                                  DUP  3 !FLAG    ( flag:=3 )                                      PDP @ >R                                           DUP DUP 1 SWAP  OADP  PDP @ OBJMOV                              R@ SWAP FW->OPTFW PDP !  CRTN P, NOP P, NOP P,                  DUP @NEWB  ( OBJ'kti CALL )                                     CALLA OVER H! 2+  R@ BPDP @ - 4 / >H< OVER H! 2+ NOP OVER !                  4 + OVER @NEWE 2DUP SWAP - >R                                   ODP @ OVER - >R SWAP R>  CMOVE                                  ODP @ R@ - ODP ! ( tekst kokku to~mmatud ja ODP )   R> OVER  R@ !NEWB R> + !NEWE                                                                      ; ( PROG addr tabelisse )   -->                                                             ( #15 kontrollib, kas oli teksti konstant            08/30/90 ) : ?."ORLIT"  DUP C(LIT") = OVER C(.") = OR OVER C(MLIT") = OR                IF                                                               DROP 4 + DUP C@ + 3 - 0 0                                       ELSE                                                             1                                                             THEN ;                                                                                                             : [']SETOBJCALL                                                               PDP @ >R                                           DUP DUP 0 SWAP OADP  PDP @ OBJMOV ( to~stis sealt a"ra )        R@ SWAP FW->OPTFW   PDP !   CRTN  P, NOP P,                     DUP @NEWE OVER @NEWB - R@ + 2+ OVER SWAP !NEWE                                 DUP R> 2+ !NEWB 4 !FLAG                                          ;       ( PROG addr tabelisse )                -->                                                             ( #16  lu"litab antud so~na BR tabelisse             08/30/90 )                                                                 : SETBRTBL  -1 NLOOP !  DUP BEGIN                                              4 + DUP @                                                        ?."ORLIT" IF CSEMI <> IF    ( otsib SEMIni )                    DUP @ DUP CBRANCH = OVER C?BRANCH = OR SWAP                     DUP C(LOOP) = SWAP C(+LOOP) = OR OR                             IF  ( reageerib, kui oli BR | ?BR )                              BRTBLSZ @ 8 * BRTBL + 2DUP  !                                   OVER DUP 4 + @ + 4 + SWAP 4 + !                                 BRTBLSZ @ 1+ BRTBLSZ !                                          DUP @ DUP C(LOOP) = SWAP C(+LOOP) = OR                          IF NLOOP @ 1- NLOOP ! THEN                                      4 + ( suurendab u"le BR aadressi ) -->                                                                                                                                         ( #17 jatkuu                                         08/30/90 )             ELSE DUP @ CLEAVE =                                              IF BRTBLSZ @ 8 * BRTBL + 2DUP !                                    NLOOP @ 4 * LOOPAR + @ SWAP 4 + !                               BRTBLSZ @ 1+ BRTBLSZ !                                        THEN DUP @ DUP C(?DO) = SWAP C(DO) = OR                        IF NLOOP @ 1+ DUP NLOOP ! 4 * LOOPAR +                             OVER 4 + @ SWAP !                                            THEN  DUP @ C(?DO) =                                            IF BRTBLSZ @ 8 * BRTBL + 2DUP !                                    OVER  4 + @ SWAP 4 + !                                          BRTBLSZ @ 1+ BRTBLSZ !                                       THEN   THEN                                                       0     ( kui lo~pp siis la"heb UNTILile adr'iga )                THEN  THEN                                                      UNTIL   ;    -->                                 ( #18 so~na transleerimine la"bi ja u"hendatakse BR  08/30/90 )                                                                 : BRTABLSET DUP @NEWB OVER @NEWE  BRTBLSZ @                                 BEGIN                                                            DUP IF 1- DUP >R 8 * BRTBL  +  DUP >R                           @      ?OKAY                                                    IF R@ 4 + @  ( BR u"hendatud )                                    OVER - 2+ 4 / >H< SWAP H!                                       R> @ BRANDY BRANDSET R> 0 ELSE                                   R> 2DROP R> 1 THEN                                            ELSE 1-  1  THEN                                                UNTIL  1+ BRTBLSZ !  2DROP  ;                                                                                                                      -->                                                                                                                                                            ( #19   so~nad, mis toimivad vastavalt tabeli lipuva"08/30/90 ) (  tab.addr -> #  )    DECIMAL                                  ( tabelis kood 1 - igal juhul kompileeritakse 1->0 )            : WCOMPILE DUP @ 12 + OVER  ODP @ !NEWB                                    ODP @ COMPMOV DUP ODP ! !NEWE ;                                                                                      ( tabelis kood 0 - kompileeritakse OBJ piirkonnast  )           : OBJCOMPILE  ODP @ OBJMOV ODP !  ;                                                                                             ( tabelis kood 2 - panna CALL, programm SOURCE piirkonnas )                                                                      -->                                                                                                                                                                                                                                                                                                                            ( #20                                                08/30/90 ) ( tabelis kood 3 - programm on PROG piirkonnas panna sinna CALL): OVERCALL  CALLA OH,                                                       @NEWB BPDP @ - 4 / >H< OH,    NOP O, ;                                                                              : [']OVERCALL DUP 4 !FLAG                                                     @NEWB BPDP @ -  2/ 2/ MOV->OBJ#  ;                : ['][']CALL @NEWB 2- BPDP @ - 2/ 2/ MOV->OBJ#  ;                ( peale so~na to~stmist )                                      : AFTSW  OVER SETOBJCALL OVER 4 !FLAG                                    OVER @NEWB + 2+ OVER SWAP !NEWE                                 DUP @NEWB 2+ !NEWB ODP @ 9 - ODP ! ;                    ( enne so~na to~stmist )                                       : TFASW DUP @NEWE OVER @NEWB - OVER ;                                                                                                -->                                                        ( #21 rekursiooni paigaldamine ja kontroll           08/30/90 )                                                                 : SETRECURS DUP @OLD GET 4 - @ =                                            IF  2 !FLAG                                                      CALLA   OH,                                                     ODP @ RECURS BRANDSET 0 OH, NOP O,                               ELSE  ABORT" vigane rekursioon "                              THEN                                                        PRF @ IF PRINTER ." rekursioon " GET 4 - @ >NAME                        .NAME CONSOLE   THEN ;                                                                                                                                                                              -->                                                                                                                                                                                                                                         ( #22                                                08/30/90 )                                                                 : ?RECURS  RECURS BEGIN                                                     DUP @ ?DUP                                                      IF PDP @ BPDP @ - 4 / >H< SWAP H!                                0 OVER ! 4 + 0                                                 THEN                                                           UNTIL   ;                                                                                                                                                                                                                                                                                                                       -->                                                                                                                                                                                                                                                  ( #23 vana so~na tabelist                            08/30/90 ) ( midagi on koodis ma"da )                                      : XWORD DROP >NAME .NAME HEX DUP U. 30 - 100 DUMP                       ABORT" BREAK !!!  X-word " ;                            : COMF  ODP @ [']ADR BRANDSET 8 ODP @ + ODP ! @OLD 1 ;          ( see so~na on juba tabelis IR TWA TAD -> IR )                  : OLDWORD  SWAP DROP PRF @ IF PRINTER DUP @OLD >NAME                   .NAME  SPACE CONSOLE THEN                                       DUP @OLD GET 4 - @ <> IF                                        DUP @FLAG   CASE  ( IR TAD )                                    0 OF OBJCOMPILE 4 + 0 1 CINC ENDOF                              1 OF @OLD 1    ENDOF                                            2 OF @OLD 1    ENDOF                                            3 OF OVERCALL 4 + 0    3 CINC ENDOF                             4 OF OBJCOMPILE 4 + 0    0 CINC 1 CINC  ENDOF            -->                                                             ( #24 jatkuu                                         08/30/90 )                                                                        6 OF COMF   ENDOF                                               7 OF DUP [']SETOBJCALL ['][']CALL 4 + 0 ENDOF                    8 OF COMF   ENDOF                                               9 OF COMF   ENDOF                                              10 OF [']OVERCALL 4 + 0 ENDOF                                   11 OF ['][']CALL 4 + 0 ENDOF                              COLOL CLEARSCREEN ABORT" bad flag in opt. table" ENDCASE            ELSE SETRECURS 4 + 0 THEN ;                                                                                                : ?WOR   DUP ?COMPWORD       ( lipp paika )                            IF SETOBJCALL 2 CINC 3 CINC ELSE DROP 0 CINC 1 CINC THEN                    ;                                                                                   -->                                                                                      ( #25  JATKUU                                        08/30/90 )                                                                 : FLAGCONT DUP DUP @FLAG CASE                                        1 OF 0 !FLAG 0    0 CINC 1 CINC ENDOF                           2 OF DUP 3 !FLAG ?RECURS SETOBJCALL 0 2 CINC 3 CINC ENDOF       9 OF DUP 3 !FLAG SETOBJCALL ODP @ 9 - ODP ! 0                        2 CINC 3 CINC                            ENDOF             8 OF TFASW SETOBJCALL AFTSW 0   2 CINC 3 CINC  ENDOF            6 OF TFASW ?WOR OVER @FLAG 0 =                                          IF  AFTSW                                                        ELSE 2DROP ODP @ 9 - ODP !                                     THEN  0     ENDOF                                           1 SWAP ENDCASE                                              IF ?WOR      THEN                                               SET[]AD  ;         -->                                                                                                     ( #26 PSEMI & PCOLON                                 08/30/90 ) ( leidis so~na COLON IR RWA <RWA> )                             : PCOLON  DROP SETBRTBL                                                   PRF @ IF PRINTER  DUP >NAME CR  3 SPACES                        ." (B col " .NAME 7 SPACES CONSOLE THEN                         DUP SETNEW ODP @ !NEWB   ( ALGUS TABELISSE )                    4 + SWAP 4 + PUSH          ;                                                                                          ( leidis so~na SEMI )                                           : PSEMI  2DROP GET 4 - @   FINDTAB DUP ODP @ !NEWE                       PRF @ IF PRINTER                                                DUP @ >NAME CR 3 SPACES .NAME ." sem E) " CONSOLE THEN          BRTABLSET  FLAGCONT   ( lipp paika )                              DROP POP ;                                                   -->                                                                                                                     ( #27 PASM                                           08/30/90 )                                                                 ( oli assembler programm )                                      : PASM   PRF @ IF PRINTER                                                       ." (B asm " DUP >NAME .NAME CONSOLE THEN                 SETNEW DUP   WCOMPILE                                           FLAGCONT    4 +                                                PRF @ IF PRINTER ." asm E) " CONSOLE THEN  ;                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( #28 BRANCH lu"litamine objektprogrammi             08/30/90 )                                                                 : SETBRANCH  OVER  BRTBL BEGIN                                                2DUP @ =       ( otsitakse tabelist vastav BR )                 IF  ODP @ 2+ SWAP !  ELSE 8 + 0 THEN                            UNTIL                                                         JMPR OH, 0 OH, NOP O, ;  ( OBJ. <- JMP 0                        adr. ma"a"ratakse so~na transleerimise lo~pus )                                                                     : SET?BRANCH  POPR2 O, R2<-R2!R2  O, CHECKZ O,                                SETBRANCH ;                                                     ( OBJ. <-  POP ax  POP bx  OR ax,bx  jnz 3 )                                                                                                                                                                                                         -->                                                          ( #29 loendajaga tsu"klid                            08/30/90 )                                                                 :  SET(LEAVE) DPOPR2   O,                                                     DPOPR2   O,                                                     SETBRANCH ;                                                                                                       : SET(DO) POPR2 O,                                                        POPR3 O,                                                        DPUSHR3 O,                                                      DPUSHR2 O,                                                       ; -->                                                                                                                                                                                                                                                                                                                                                                                ( #30 loendajaga tsu"kli komponendid                 08/30/90 )                                                                 : SET(?DO) POPR2 O,                                                        POPR3 O,                                                        R3?R2  O,                                                       CHECKNZ  O,                                                     JMPR OH, 4 >H< OH,                                              NOP O,                                                          SETBRANCH                                                       DPUSHR3 O,                                                      DPUSHR2 O,  ; -->                                                                                                                                                                                                                                                                                                                                                                    ( #31 loendajaga tsu"kli komponendid                 08/30/90 )                                                                 : SET(LOOP)1 DPOPR3 O,                                                       DPOPR4 O,                                                       R3<-R3+R2 O,                                                    R3?R4 O,                                                        CHECKNN O,                                                      JMPR   OH,  6 >H< OH,                                           NOP O,                                                          DPUSHR4 O,                                                      DPUSHR3 O,                                                      SETBRANCH ;                                                                                                        : SET(LOOP)   R2<-# OH,  1 >H< OH,  SET(LOOP)1 ;                -->                                                                                                                             ( #32                                                08/30/90 )                                                                 : SET(+LOOP) POPR2  O,                                                       SET(LOOP)1 ;                                                                                                                                                                                                                                                                                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( #33  tsu"kli loendajad                             08/30/90 )   HEX                                                           : SETI   D4<-# OH, 100 OH,                                               R2<-(A4-D) O,                                                   A4<-A4+D O,                                                     PUSHR2 O, ;                                                                                                                                                                            : SETJ  D4<-# OH, 300 OH,                                                R2<-(A4-D) O,                                                   A4<-A4+D O,                                                     PUSHR2 O, ;                                                                                                                                        -->                                                                                                                                                                 ( #34 konstandi ja tekstikonstandi lu"litamine       08/30/90 )  (  aendab ka'su LIT )                                          : SETLIT OVER 4 + @ DUP FFFF0000 AND IF >< D, DDP @ 1- BDDP              - 2/ 2/ DFB + MOV->OBJ ELSE MOV->OBJ# THEN ;           : SETEXIT CRTN O, ;                                                                                                             : AMOVE  0 ?DO 2DUP SWAP C@ >< SWAP ! 4 + SWAP 1+ SWAP LOOP              2DROP ;                                                                                                                DECIMAL                                                          ( asendab ka"su LIT" )                                         : SET(LIT")  DDP  @ >R                                                      OVER 4 + DUP C@ 1+ DUP >R DDP @ SWAP AMOVE                      DDP @ R@ 4 * + DDP ! DROP 4 + R> + R> BDDP  -                   2/ 2/ DFB + MOV->OBJ#  ;                                -->                                                         ( #35                                                08/30/90 ) : SET(MLIT")  DDP  @ >R                                                     OVER 4 + DUP C@ 1+ DUP >R PDP @ SWAP AMOVE                      DDP @ R@ + DDP ! DROP 4 + R> + R> BDDP @ -                      2/ 2/ DFB + 1+ MOV->OBJ#  ;                                                  DECIMAL                                 ( asendab ka"su ." )                                           : SET(.") RESTADR OVER 4 + C@ >R                                   ( siin arvutab aadressi )    PDP  @ >R                                   OVER 5 + DUP 1- C@  DUP >R DDP @ SWAP CMOVE                     DDP @ R@ + DDP ! DROP 4 + R> + 1+ R> BDDP @ -                   MOV->OBJ#                                                     R>   MOV->OBJ#                                           4 - DUP @ CRESTORE ! DUP CRESTOREAD ! CTYPE OVER ! CTYPE ;           ( ^ paneb so~na TYPE so~nastikku ^ )                    -->                                                             ( #36  SETEXECUTE                                    08/30/90 ) ( asendab ka"su EXECUTE ) HEX                                   : SETEXECUTE POPR2   O,                                                      R3<-#B8  O,  R3<-SLA(R3,16) O,                                  R2<-R2!R3  O,  R3<-PC O,                                        R4<-5 O,  R3<-R3+R4 O,                                          A3<-R3 O, R2->(A3) O, NOP O, CALLA OH, 0 OH,                    NOP O,                                                             ;            DECIMAL                                                                                            : SET[']  OVER 4 + @ DUP ODP @ ! DUP FINDTAB ?DUP                         IF SWAP DROP DUP @FLAG 7 + !FLAG                                 ELSE SETNEW 6 !FLAG                                            THEN  DROP 4 + DUP @ ;                                                                                                -->                                                             ( #37 vahetult ta"idetavade so~nade kontroll         08/30/90 )                                                                  ( IR TWA -> IR TWA 1  or  IR 0 )                               : ?IMWORD1  DUP CASE                                              CBRANCH  OF SETBRANCH DROP 8 + 0 ENDOF                          C?BRANCH OF SET?BRANCH DROP 8 + 0 ENDOF                         CLIT     OF SETLIT DROP 8 + 0 ENDOF                             CRLIT     OF SETLIT DROP 8 + 0 ENDOF                            CGLIT     OF SETLIT DROP 8 + 0 ENDOF                            C(LIT")  OF SET(LIT") 0 ENDOF                                   C(MLIT")  OF SET(MLIT") 0 ENDOF                                 C(.")    OF SET(.")   1 ENDOF                                   CEXECUTE OF SETEXECUTE DROP 4 + 0 ENDOF                         C[']     OF SET['] 1 ENDOF                                      C(DO)    OF SET(DO) DROP 8 + 0 ENDOF                          -->                                                             ( #38    jatkuu                                      08/30/90 )                                                                   C(?DO) OF SET(?DO) DROP 8 + 0 ENDOF                             C(+LOOP) OF SET(+LOOP) DROP 8 + 0 ENDOF                         CJ     OF SETJ DROP 4 + 0 ENDOF                                 CEXIT  OF SETEXIT DROP 4 + 0 ENDOF                                                                                                                                                                                                                              CLEAVE   OF SET(LEAVE)  DROP 4 + 0 ENDOF                        C(LOOP)  OF SET(LOOP) DROP 8 + 0 ENDOF                          CI       OF SETI DROP 4 + 0 ENDOF                                          1 SWAP ENDCASE    ;   -->                                                                                                                                                                                                                          ( #39  konstandi lu"litamine                         08/30/90 )                                                                 ( asendab konstanndi )                                          : SETCONST SETLIT 8 CINC ;                                                                                                      ( leiab muutuja pikkuse )                                       : CFIND LATEST BEGIN                                                     DUP N>LINK @ NAME> 2 PICK OVER =                                IF >BODY - 1                                                     ELSE >NAME SWAP DROP 0                                         THEN                                                           UNTIL ;                                                                                                                 -->                                                                                                                                                                                             ( #40  muutuja lu"litamine                           08/30/90 )                                   DECIMAL                       ( asendab muutuja )                                             : SETVAR  PRF @ IF PRINTER OVER >NAME .NAME CONSOLE THEN 4 CINC          OVER 4 + FINDTAB ?DUP                                            IF  @NEWB                                                        ELSE OVER 4 + SETNEW                                             DDP @ BDDP  -                                                   DUP  >R OVER 14 !FLAG !NEWB                          (  DDP @ >R OVER CFIND  ." muutuja "                                                           SWAP 4 + SWAP R> SWAP DUP >R                CMOVE R> DDP @ + DDP !  )                                       OVER 4 +  @ >< D, R>                                          THEN                                                            2/ 2/  DFB + MOV->OBJ#  ;                             -->                                                             ( #41 mooduli ja sysmuutuja lu"litamine              08/30/90 )                             DECIMAL                             : SETMODUL PRF @ IF PRINTER ." moodul " CONSOLE THEN                    DDP @ BDDP  -    >R                                             DDP @ >R OVER CFIND 4 + SWAP 8 + SWAP R> SWAP DUP >R            CMOVE R> DDP @ + DDP ! R>                                   ODP @ >R  2/ 2/ DFB + MOV->OBJ#  DROP DUP >R                        4 + @ 4 -  SETBRTBL 4 + R>    SETNEW DUP 15 !FLAG                  R> !NEWB SWAP 4 + PUSH 5 CINC ;                      ( asendab su"steemi muutuja )                                   : SETUSER 4 CINC OVER 4 + FINDTAB ?DUP                                    IF @NEWB                                                         ELSE                                                             OVER  EXECUTE  @ >< D,                                                             -->                                                                                              ( #42 vahetult taidetavade sonade kontroll IR WA <WA> 08/30/90 )                                                                       OVER 4 + SETNEW                                                 DDP @ 4 - BDDP  -                                                  DUP >R OVER 13 !FLAG !NEWB R>                                   THEN   2/ 2/  DFB + MOV->OBJ# ;                                                                                       ( IR WA <WA> -> IR WA <WA> 1  OR  IR 0 )                        : ?IMWORD2 DUP CASE                                                CVARCFA    OF SETVAR 2DROP 4 + 0 ENDOF                          CCONSTCFA  OF SETCONST 2DROP 4 + 0 ENDOF                        CUSERCFA   OF SETUSER  2DROP 4  + 0 ENDOF                       CDOES>     OF  SETMODUL 0 ENDOF                                            1 SWAP ENDCASE  ;                                  -->                                                                                                                            ( #43 kontroll, kas antud so~lm on seotud BR'iga     08/30/90 )                                                                 : BRCNTRL 0  BEGIN                                                             BRTBLSZ @ OVER = IF DROP 1 ELSE                                  2DUP 8 * 4 + BRTBL + SWAP OVER @ =                              IF  ODP @ SWAP !                                                 ELSE DROP                                                      THEN                                                            1+ 0                                                           THEN  UNTIL ;                                         -->                                                                                                                                                                                                                                                                                                                                                                                        ( #44 siia tuleb kompilaator ise         DECIMAL     08/30/90 ) VARIABLE THELP  4 ALLOT    DECIMAL                              ( word addr. -> #   )                                           : FINIT 0 BRANDY !  CONTEXT @  [COMPILE] FORTH  DEFINITIONS          CONTEXT !  0 CRESTORE !   0 RS ! 0 BRTBLSZ ! 0 [']ADR !           CARV 40 ERASE ;                                          : WORD->OBJ  FINIT THELP ! THELP BEGIN   [COMPILE] HEX                        BRCNTRL  ( kontrollib, kas antud addr seotud BR )               DUP @                                                           ?IMWORD1                ( kas on otseso~na )                    IF                                                              DUP                                                             FINDTAB  ?DUP ( kas so~na trans. tabelis )                      IF     OLDWORD                                                   ELSE 1 THEN                                                     IF       -->                                     ( #45 JATKUU WORD->OBJ                               08/30/90 )               ?ASM                                                            IF  PASM                                                         ELSE                                                            DUP @                   ?IMWORD2                                IF ?COLON                                                        IF     PCOLON                                                    ELSE ?SEMI                                                       IF     PSEMI                                                     ELSE XWORD THEN                                             THEN THEN THEN  THEN THEN                                       ?RS 0= IF 1 ELSE 0 THEN                                        UNTIL RESTADR DROP                                    THELP @ FINDTAB DUP @FLAG  0 = IF                               DUP SETOBJCALL THEN                                             @NEWB 2 CINC 3 CINC  ;      -->                             ( #46 passide tabeli kompileerimine                  12/06/90 ) ( PASSTAB . -----                                                               |-> | addr . -|------> |nr1|cfa1|   | ... | 0 |                     | addr . -|------> |nr2|cfa1|   | ... | 0 |                        ...                                                          |    0    |                                                                       )                         VARIABLE PIK                                                    : SETPASS  PASSTAB  @ ( PRINTER ) 0 >R BEGIN ( CR )                         DUP @ ?DUP                                                      IF R> 1+ >R                                                        4 + @ DUP C[']  , ,                                          (  DUP >NAME ." NIMI-" .NAME ) SETNEW 2 !FLAG 4 + 0              ELSE DROP 1 ( ." koik" )  R> ( DUP . ) PIK !                   THEN                                                           UNTIL  CONSOLE  ;   -->                              ( #47 cfa'de  asendamine                             12/06/90 ) : MOVPASS                                                                 ['] PASSTAB 4 + FINDTAB ?DUP                                     IF  @NEWB BDDP +                                                 DDP @ BDDP - 4 / DFB + >< SWAP ( 2DUP U. U. ) !                 DDP @ PASSTAB @ PIK @                                          DDP @ OVER 4 * + DDP !                                          0 ?DO SWAP DDP @ BDDP - 4 / DFB + ><                            OVER ! 4 + SWAP  DUP  @                                          DUP @ >< D, 4 +                                                 DUP @                                                           PRF @ IF PRINTER CR DUP                                                ." pass: " >NAME .NAME CONSOLE THEN                            FINDTAB ?DUP IF ELSE ABORT" passerror " THEN                                                                       -->                                                        ( #48                                                12/14/90 )                                                                             @NEWB BPDP @ - 4 /  >< D, 4 +                                   BEGIN  DUP @ ?DUP                                                IF >< ( DUP U. ) D, 4 + 0  ELSE DROP 1 THEN                    UNTIL                                                           4 +                                                            LOOP  2DROP                                                    THEN  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               