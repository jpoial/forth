( Modula-2 menu                                      10/14/89 ) (                                                                     This file contains source for Modula-2 system menu.                                                                               Copyright (c), 1990, Viljo Soo                                          Tartu University, Estonia                                                                                         Modified by Ain Isotamm, 1991: blocked work for Modula-2Base                                                                  )                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( INTENS_EMIT CAP ENV_SEG ADRUN ?DISCERR             10/14/89 ) HEX                                                             : ENV_SEG ENV_ADDR @ 10 / ?fs: + ;                              : ADRUN ( cstr1 cstr2 --- )                                     HIDDEN PGM_NAME 40 ERASE CMD_LINE 40 ERASE                              DUP C@ 1+ CMD_LINE SWAP CMOVE                                   COUNT PGM_NAME SWAP CMOVE ENV_SEG exec-run                      FORTH ;                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Filenames and pathes                               10/14/89 ) HANDLE WFILE WFILE DROP 45 ERASE                                HANDLE MFILE MFILE DROP 45 ERASE                                HANDLE RFILE RFILE DROP 45 ERASE HANDLE TEMPOUT                 HANDLE ERRFILE ERRFILE FILENAME M2ERR.TMP                       DIRECTORY EDITOR_NAME EDITOR_NAME DIRNAME NE.COM                DIRECTORY COMPILER_NAME COMPILER_NAME DIRNAME M2COMP.COM        DIRECTORY LOADLIST_NAME LOADLIST_NAME DIRNAME LOADLIST.COM      DIRECTORY LOADER_NAME LOADER_NAME DIRNAME LOADF.COM             DIRECTORY LINKER_NAME LINKER_NAME DIRNAME M2LINK.COM            DIRECTORY DBASE_NAME DBASE_NAME DIRNAME SHOWREC.COM             DIRECTORY CROSS_LINKER_NAME CROSS_LINKER_NAME DIRNAME CROSS.COM DIRECTORY RUNNER_NAME RUNNER_NAME DIRNAME  M2LINK.COM           DIRECTORY MODPATH MODPATH 40 ERASE                              DIRECTORY SOURCEPATH SOURCEPATH 40 ERASE                        -->                                                             ( Error processing                                   04/19/90 ) VARIABLE #LINE                       VARIABLE PARAMADDR         : HANDNAME DROP 4 + ;                                           : READERR ERRFILE OPEN-FILE-R/O ?DISCERR                                ERRFILE 4 #LINE READ IF 0 #LINE !                                                    ELSE  DROP THEN                            ERRFILE CLOSE-FILE ?DISCERR                                     ERRFILE KILL-FILE ?DISCERR ;                            : U>PSTR ( u --- addr l )                                               DECIMAL 0 <# #S ASCII + HOLD #> ;                       : EDITERR #LINE @ U>PSTR                                                HERE PARAMADDR ! DUP C, STR,                                    PARAMADDR @ DUP LIT"  " DEST|SOUR                               WFILE HANDNAME DEST|SOUR                                        EDITOR_NAME PARAMADDR @ ADRUN PARAMADDR @ DP ! ;        -->                                                             ( READ_LINKERR ?XCODE FILE_EXISTS?                   04/23/90 ) HANDLE SOURFILE                                                 : READ_LINKERR ERRFILE OPEN-FILE ?DISCERR                               ERRFILE 1 SOURFILE HANDNAME DUP >R                              READ ?DISCERR DROP                                              ERRFILE R> COUNT SWAP READ ?DISCERR DROP                        ERRFILE 4 LOC# READ ?DISCERR DROP                               ERRFILE CLOSE-FILE ?DISCERR                                     ERRFILE KILL-FILE ?DISCERR ;                            : ?XCODE ( --- c )                                                      4D 0 FDOS DROP 0FF AND ;                                : FILE_EXISTS? ( handle_pars --- flag )                                 2DUP OPEN-FILE                                                  IF CR ." File " .FILENAME  ."  not found" 0                     ELSE DROP DUP H@ CLOSE-FILE DROP -1                             THEN ; -->                                              ( CHANGE_WFILE U>STR SET_LOCOPT                      04/23/90 ) : CHANGE_WFILE WFILE DROP 40 ERASE                                      SOURFILE HANDNAME DUP C@ 1+                                     WFILE HANDNAME SWAP CMOVE                                       CR ." Work file changed to " WFILE .FILENAME ;          VARIABLE LOCOPT 10 ALLOT                                        : U>STR ( u --- addr l )                                                DECIMAL 0 <# #S #> ;                                    : SET_LOCOPT                                                            0 LOCOPT ! LOCOPT LIT"  /E" DEST|SOUR                           LOC# @ U>STR DUP 3 + LOCOPT C!                                  LOCOPT 4 + SWAP CMOVE ;                                 DIRECTORY DBP_NAME DBP_NAME DIRNAME MF.COM                      DIRECTORY BRUNNER_NAME BRUNNER_NAME DIRNAME MF.COM              DIRECTORY DRUNNER_NAME DRUNNER_NAME DIRNAME  SHOWREC.COM        -->                                                             ( PATHEND                                            05/07/90 ) : PATHEND ( addr1 --- addr2 )                                           BEGIN ASCII \ SCAN                                              WHILE 1+ REPEAT ;                                       : LOAD&EX ( cstr1 cstr2 handle_pars --- )                               HANDNAME >R >R >R HERE PARAMADDR ! 0 C,                         PARAMADDR @ DUP R> DEST|SOUR                                    DUP LIT"  " DEST|SOUR R> OVER R> DEST|SOUR                      DEST|SOUR HERE C@ ALLOT                                 LOADER_NAME PARAMADDR @ ADRUN PARAMADDR @ DP ! ;                VARIABLE NULSTR                                                 -->                                                                                                                                                                                                                                                                                                                             ( File settings: SET_WORKFILE SET_MAINFILE           05/11/91 ) : SET_WORKFILE ( A[l;name] --- )                                COUNT DUP WFILE DROP 4 + C! WFILE DROP 5 + SWAP CMOVE           WFILE ?FILE-EXT SWAP DROP 0=                                      IF WFILE HANDNAME LIT" .MOD" DEST|SOUR THEN                   WFILE DROP 5 + ASCII \ SCAN 0=                                    IF SOURCEPATH WFILE HANDNAME SOUR|DEST THEN DROP ;            : SET_MAINFILE ( A[l;name] --- )                                COUNT DUP MFILE DROP 4 + C! MFILE DROP 5 + SWAP CMOVE           MFILE ?FILE-EXT SWAP DROP 0=                                      IF MFILE HANDNAME LIT" .OBM" DEST|SOUR THEN                   MFILE DROP 5 + ASCII \ SCAN 0=                                    IF OBJECTPATH MFILE HANDNAME SOUR|DEST THEN DROP ;            : SET_WFILE SET_WORKFILE ;                                      : SET_MFILE SET_MAINFILE ;                                      -->                                                             ( Environment: HEREPARA CREATE_ENV INIT_ENV ...      10/22/89 ) : HEREPARA ( --- addr )                                                    HERE 0F + FFFF0 AND DUP DP ! ;                       : CREATE_ENV HEREPARA ENV_ADDR ! ;                              : INIT_ENV ENV_ADDR @ DP ! ;                                    : ENV_END 0 C, ;                                                : SET_ENV ( addr1 addr2 --- )                                           SWAP COUNT STR, ASCII = C, COUNT STR, 0 C, ;            : MODIFY_ENV INIT_ENV                                                   LIT" SOURCE" SOURCEPATH SET_ENV                                 LIT" OBJECT" OBJECTPATH SET_ENV                                 LIT" LIBRARY" LIBPATH SET_ENV                                   ENV_END ;                                               : ENV! CREATE_ENV MODIFY_ENV ;                                  -->                                                                                                                             ( EMPTY_NAME WFILE_SET? MFILE_SET?                   12/04/90 ) : EMPTY_NAME ( handle_pars --- flag )                                   DROP 4 + C@ 0= ;                                        : WFILE_SET?                                                            WFILE EMPTY_NAME                                                IF                                                                 SET_WORKFILE                                                 THEN                                                    ;                                                               : MFILE_SET?                                                            MFILE EMPTY_NAME                                                IF                                                                 SET_MAINFILE                                                 THEN                                                    ;                                                               -->                                                             ( Executing utilites: IMPORTLIST M2EDIT              12/04/90 ) : IMPORTLIST LOADLIST_NAME MFILE HANDNAME ADRUN ;               : M2EDIT WFILE_SET? ?MODE 7 <> IF 4 FOREGROUND THEN                     ." Edit" CR                                                     EDITOR_NAME WFILE HANDNAME                                      ?MODE 7 <> IF 3 MODE 2 FOREGROUND THEN ADRUN                    ?MODE 7 <> IF B/W THEN ;                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Executing utilites: OPTCOMP M2COMPILE COMPLOC      04/23/90 ) : OPTCOMP ( cstr --- )                                                  COMPILER_NAME SWAP WFILE LOAD&EX ?XCODE  8 =                    IF READERR                                                         ." Press ENTER to edit errorneus program" CR                    ." or any other key to continue."                               KEY ASCII_CR = IF EDITERR THEN                               THEN ;                                                  : M2COMPILE  ." Compile " WFILE .FILENAME WFILE FILE_EXISTS? CR         IF LIT"  /E0" OPTCOMP                                           THEN ;                                                  : COMPLOC SOURFILE FILE_EXISTS?                                         IF CHANGE_WFILE SET_LOCOPT                                         LOCOPT OPTCOMP                                               THEN ;                                                  -->                                                             ( Executing utilites: M2LINK                         04/23/90 ) : M2LINK MFILE_SET? ." Link" MFILE FILE_EXISTS? CR                      IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME LINKER_NAME ADRUN                                   ?XCODE 8 =                                                      IF READ_LINKERR                                                   ." Press ENTER to find error position in souce"                  CR ." or any other key to continue."                            KEY ASCII_CR =                                                  IF COMPLOC                                                      THEN                                                         THEN                                                         THEN                                                         THEN ;                                                  -->                                                                                                                             ( Executing utilites: CROSS                          12/04/90 ) : CROSS MFILE_SET? ." Cross link" MFILE FILE_EXISTS? CR                 IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME CROSS_LINKER_NAME ADRUN                             ?XCODE 8 =                                                      IF READ_LINKERR                                                   ." Press ENTER to find error position in souce"                  CR ." or any other key to continue."                            KEY ASCII_CR =                                                  IF COMPLOC                                                      THEN                                                         THEN                                                         THEN                                                         THEN ;                                                  -->                                                                                                                             ( Executing utilites: M2RUN                          05/07/90 ) : M2RUN MFILE_SET? ." Run" CR RFILE DROP 40 ERASE               MFILE HANDNAME RFILE HANDNAME OVER C@ 1+ CMOVE RFILE ?FILE-EXT   IF LIT" BIN" 1+ SWAP 3 CMOVE                                    ELSE RFILE HANDNAME LIT" .BIN" DEST|SOUR THEN                  0 RFILE HANDNAME COUNT + C! RFILE FILE_EXISTS?                          IF RUNNER_NAME NULSTR RFILE LOAD&EX THEN ;                                                                              : M2BRUN MFILE_SET? ." Run " RFILE DROP 40 ERASE                MFILE HANDNAME RFILE HANDNAME OVER C@ 1+ CMOVE RFILE ?FILE-EXT   IF LIT" BIN" 1+ SWAP 3 CMOVE                                    ELSE RFILE HANDNAME LIT" .BIN" DEST|SOUR THEN                  0 RFILE HANDNAME COUNT + C! RFILE .FILENAME RFILE FILE_EXISTS?  CR      IF BRUNNER_NAME NULSTR RFILE LOAD&EX THEN ;             -->                                                                                                                             ( Executing utilites: M2BASE                         01/21/91 ) : M2BASE MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN         ." Base " MFILE .FILENAME MFILE FILE_EXISTS? CR                   IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBASE_NAME                                         ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;                           : M2BP MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN           ." Report " MFILE .FILENAME MFILE FILE_EXISTS? CR                 IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBP_NAME                                           ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;             DECIMAL       ;S                                                              ( Executing utilites: M2BASE                         01/21/91 ) : M2BASE MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN         ." Base" MFILE FILE_EXISTS? CR                                    IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBASE_NAME                                         ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;                           : M2BP MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN           ." Report" MFILE FILE_EXISTS? CR                                  IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBP_NAME                                           ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;                           ;S                                                              ( Executing utilites: M2BASE                         01/21/91 ) : M2BASE MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN         ." Base" MFILE FILE_EXISTS? CR                                    IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBASE_NAME                                         ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;                           : M2BP MFILE_SET? ?MODE 7 <> IF 4 FOREGROUND INTENSITY THEN           ." Report" MFILE FILE_EXISTS? CR                                  IF IMPORTLIST ?XCODE 0=                                            IF LOADER_NAME DBP_NAME                                           ?MODE 7 <> IF B/W THEN ADRUN                                  THEN                                                         THEN ?MODE 7 <> IF B/W THEN ;                           ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              