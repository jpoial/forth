 MODULA-2                                                       Teeb MASTER-R & MASTER_RECORDi.                                                                                                                                                                                                                                                                                                 Rippmen parameetrite v„li:                                                                                                      0: el-pikkus, 4,12: #read, 8: #veerud, 16..27 WindowParm,       28: massiiv, 32: jooksev indeks                                                                                                                                                                                                                                                                                                                                                                                                                               ( #1                                                 08/15/91 ) VARIABLE #VABA VARIABLE I-ATOM VARIABLE I-TEXT                  VARIABLE ETTE/TAHA 0 ETTE/TAHA !                                VARIABLE FT.ARRAY VARIABLE FA.ARRAY VARIABLE TAB.ARRAY          VARIABLE KEY-W 36 DECL KEY-W ! VARIABLE PRC-W 36 DECL PRC-W !   VARIABLE FTX-W 36 DECL FTX-W ! VARIABLE FAT-W 36 DECL FAT-W !   VARIABLE TAB-W 36 DECL TAB-W !                                  VARIABLE I.RIPP VARIABLE X.RIPP VARIABLE Y.RIPP                 : MAKE-WP ( --- )                                               34 ScP @ DUP 8  + @ SWAP @ * - 6            ( xul, yul )        256 * + ScP @ 20 + !                                            34 ScP @ 12 + @  6 +                        ( xlr, ylr )        256 * + ScP @ 16 + !                                            1012 ScP @ 24 + ! ;                                             : W.LENGTH ( n --- )                                            1+ DUP 15 > IF DROP 15 THEN ScP @ 12 + ! ;             -->      ( #2                                                 08/15/91 ) : M_LENGTH ( --- )                                              87 64 +                      ( fix=87 + kirjeld.nimi )          #ATOMS @  24 * +             ( vaba-aatomite parm )             #VABA @  256 * +             ( vabatextide parm )               #KOMPLEKT @ 12 * +           ( KEY.ARRAY + inst. p„ised )       KEY-INDEX @ 4 * +            ( instruktsioonid )                MASTERS_LENGTH ! ;                                                                                                              : TEXT-LENGTH? ( A --- n )                                      DUP >R BEGIN DUP C@ 0= IF R> - -1 ELSE 1+ 0 THEN UNTIL ;        -->                                                                                                                                                                                                                                                                                                                             ( #3 Create master record                            08/15/91 ) : DECL-MASTERS ( --- )                                          0 KEY-INDEX ! #KOMPLEKT @ 0 > IF KEYNUMBER THEN                 M_LENGTH f-WINDOW W-CLEAR                                       MASTERS_LENGTH @ DECL MASTER-R ! ;                              : !KIRPIK ( --- n )                                             MASTER_RECORD @ DUP KIRPIK ! PURE-LENGTH PURELENGTH ! ;         : MAKE-FT.ARRAY ( --- )                                         MASTER_RECORD 56 + C@ 0 >                                        IF #VABA @ 4 * DECL FT.ARRAY ! MASTER_RECORD >R R@ 38 + H@ R> +    MASTER_RECORD 56 + C@ 0                                         DO DUP FT.ARRAY @ I 4 * + ! @ MASTER_RECORD + LOOP DROP      THEN ;                                                         -->                                                                                                                                                                                             ( #4 Description checking                            08/15/91 ) ( VARIABLE DEFNAME )                                            0 DEFNAME !                                                     : SET_DEFNAME ( --- )                                           DEFNAME @ DUP 0=                                                 IF 7 EMIT ." The name of definition module is lack" KEY            DROP BYE                                                     ELSE DUP TEXT-LENGTH? DUP DUP >R 4 + MASTER_RECORD 60 + C!           MASTER_RECORD 61 + SWAP CMOVE                                   LIT" .DEF" 1+ MASTER_RECORD 61 + R> + 4 CMOVE              THEN ;                                                         -->                                                                                                                                                                                                                                                                                                                             ( #5  Make Master Record                             08/15/91 ) : MakeMaster ( --- )                                            DECL-MASTERS                                                    -1 MASTER-R @ ! -1 MASTER-R @ 4 + !    ( last & first rec-nr. ) #TABL @ MASTER-R @ 11 + C!                     ( tabelite arv ) 40 MASTER_RECORD 4 + H!                  ( kirje p„ise pikkus ) KIRJETYYP @ 8 + @ MASTER_RECORD 4 + H@ + DUP KIRPIK !           MASTER_RECORD !                                                 MASTERS_LENGTH @ MASTER_RECORD 8 + H!                           -1 MASTER_RECORD 10 + H!              ( tyhi kustutatute ahel ) 0 MASTER_RECORD 12 + !                          ( kirjete arv ) SET_DEFNAME                                       ( l,legname ) @DATE MASTER_RECORD 16 + ! MASTER_RECORD 20 + !     ( kuup„ev ) @TIME MASTER_RECORD 24 + ! MASTER_RECORD 28 + !    ( kellaaeg ) DROP                                                            -->                                                             ( #6 MakeMaster continue                             08/15/91 ) 119 MASTER_RECORD 36 + H!               ( vabaridade ahela SA ) #VABA @ MASTER_RECORD 56 + C!              ( vabatekstide arv ) #ATOMS @ DUP MASTER_RECORD 55 + C!      ( vabade aatomite arv ) 24 * 119 + DUP MASTER_RECORD 38 + H!  ( vabatekstide ahela SA ) #VABA @ 256 * + DUP MASTER_RECORD 32 + H!      ( > v“tmetabel ) A-KEY-INST ! #KOMPLEKT @ MASTER_RECORD 34 + H!                  #KOMPLEKT @ 0 >                                                  IF A-KEY-INST @ MASTER_RECORD + KEY-INST                        ELSE 0 A-KEY-INST !                                             THEN ;                                                         -->                                                                                                                                                                                                                                                                                                                             ( #7 Key & procedure support                         09/07/91 ) : TYPE.X ( --- )                                                X.RIPP @ CASE 0 OF ." indeks"            ENDOF                                1 OF ." k“ik protseduurid" ENDOF                            ( else ) ." k“ik elemendid j„rjest"                            ENDCASE ;                                              : ACT.NULL ( --- )                                              1 ScRida ! S-GOTOXY REVERSE TYPE.X                              X.RIPP @ CASE 0 OF 26 ENDOF                                                   1 OF 15 ENDOF                                               ( else ) 10                                                    ENDCASE                                                0 DO 32 EMIT LOOP REVERSE-OFF ;                                 -->                                                                                                                                                                                             ( #8 Key & procedure support                         09/07/91 ) : TYPE.SISU ( A --- )                                           X.RIPP @ CASE 0 OF >NAME .NAME           ENDOF                                1 OF >NAME .NAME           ENDOF                                2 OF 19 + 31 TYPE          ENDOF                                3 OF 4 - BODY> >NAME .NAME ENDOF                           ENDCASE ;                                              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #9 Key & procedure support                         09/07/91 ) : MAKE-KW ( --- )                                               KEY-W @ ScP !                                                   32 ScP @ ! #KOMPLEKT @ DUP ScP @ 4 + ! 1+ ScP @ 12 + !           1 ScP @ 8 + ! KEY.ARRAY @ ScP @ 28 + !                         MAKE-WP MASTER_RECORD 6 + H@ ScP @ 32 + ! ;                     : MAKE-PW ( --- )                                               PRC-W @ ScP !                                                   32 ScP @ ! #PROTS @ DUP ScP @ 4 + ! W.LENGTH                     1 ScP @ 8 + ! PROCED.ARRAY @ ScP @ 28 + !                      MAKE-WP 0 ScP @ 32 + ! ;                                        : MAKE-TW ( --- )                                               FTX-W @ ScP !                                                   32 ScP @ ! #VABA @ DUP ScP @ 4 + ! W.LENGTH                      1 ScP @ 8 + ! FT.ARRAY @ ScP @ 28 + !                          MAKE-WP 0 ScP @ 32 + ! ;                             -->        ( #10                                                09/07/91 ) : I.ACT@ ScP @ 32 + @ ;                                         : I.ACT! ScP @ 32 + ! ;                                         : I.SOAP ( --- )                                                I.RIPP @ 1+ ScRida ! S-GOTOXY 32 0 DO 32 EMIT LOOP S-GOTOXY ;   : I.OFF ( --- )                                                 I.SOAP I.RIPP @ 1+ ScRida !                                     I.ACT@ 0 >                                                        IF ScP @ 28 + @ I.ACT@ 1 - 4 * + @ TYPE.SISU                    ELSE TYPE.X THEN ;                                            : I.ON ( --- )                                                  I.RIPP @ 1+ ScRida ! I.ACT@ 0 >                                   IF   S-GOTOXY ScP @ 28 + @ I.ACT@ 1 - 4 * + @                        REVERSE TYPE.SISU REVERSE-OFF                              ELSE ACT.NULL                                                   THEN ;                -->                                     ( #11                                                09/07/91 ) : >MENYY ( --- )                                                1 ScVeerg !                                                     ScP @ 12 + @ ScP @ 4 + @ 15 > IF 1+ THEN 0                       DO I DUP I.RIPP ! I.ACT! I.OFF LOOP ;                          : <MENYY ( --- )                                                ScP @ 4 + @ 15 >                                                IF 1 ScVeerg !                                                     ScP @ 12 + @ ScP @ 4 + @ 15 > IF 1+ THEN 0                      DO ScP @ 12 + @ I - I.RIPP !                                     ScP @  4 + @ I - I.ACT! I.OFF                                  LOOP                                                         THEN ;                                                          -->                                                                                                                                                                                             ( #12                                                09/07/91 ) : R-ALLA (  --- )                                               I.OFF I.RIPP @ ScP @ 12 + @ ScP @ 4 + @ 16 < IF 1 - THEN =        IF ScP @ 4 + @ 15 >                                               IF ScP @ 4 + @ I.ACT@ =                                           IF   >MENYY 0 I.ACT! 0 I.RIPP !                                 ELSE ScP @ 16 + W-UP ScP @ 16 + W-LLC I.ACT@ 1+ I.ACT!          THEN                                                          ELSE 0 I.RIPP ! 0 I.ACT!                                        THEN                                                          ELSE 1 I.RIPP +! I.ACT@ 1+ I.ACT!                               THEN I.ON ;                                                   -->                                                                                                                                                                                                                                                             ( #13                                                09/07/91 ) : R-YLES ( --- )                                                I.OFF I.RIPP @ 0=                                                 IF I.ACT@ 0=                                                      IF   ScP @ 4 + @ 15 > IF <MENYY ELSE ScP @ 12 + @ 1 -                                    DUP I.RIPP ! I.ACT! THEN               ELSE I.ACT@ 1- I.ACT! ScP @ 16 + W-DOWN ScP @ 16 + W-HOME       THEN                                                          ELSE 1 I.RIPP -! I.ACT@ 1- I.ACT!                               THEN I.ON ;                                                   : R-TIPP ( --- )                                                I.OFF >MENYY 0 I.RIPP ! 0 I.ACT! I.ON ;                         : R-OTS ( --- )                                                 I.OFF ScP @ 4 + @ 15 > IF <MENYY ELSE ScP @ 12 + @ 1 -                                    DUP I.RIPP ! I.ACT! THEN I.ON ;       -->                                                             ( #14                                                09/07/91 ) : R-FUNC ( --- )                                                CASE                                                            DOWNARROW   OF R-ALLA      ENDOF                                UPARROW     OF R-YLES      ENDOF                                HOMEKEY     OF R-TIPP      ENDOF                                ENDKEY      OF R-OTS       ENDOF                                ALT-P       OF WriteScr    ENDOF                                 ( Else )     7 EMIT ENDCASE ;                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #15                                                09/07/91 ) : EDIT-RIPP ( --- index f )                                     I.ACT@ Y.RIPP !                                                 BEGIN KELL PCKEY CASE                                           0   OF R-FUNC                            ENDOF                  13  OF I.ACT@                    -1 EXIT ENDOF  ( Enter  )      27  OF Y.RIPP @ DUP I.ACT!        0 EXIT ENDOF  ( Escape )       ( Else )         7 EMIT                                        ENDCASE AGAIN ;                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #16                                                09/07/91 ) : RIPP-KEY ( --- i )                                            >vPUHVER 1 1 H-WINDOW W-GOTOXY ." V“tmekomplektid"              MAKE-KW ScP @ 16 + W-BORDER ScP @ 16 + W-CLEAR 0 X.RIPP !       >MENYY MASTER_RECORD 6 + H@ DUP I.ACT! I.RIPP ! I.ON            EDIT-RIPP DROP                                                  <vPUHVER ;                                                      : RIPP-PRC ( --- i f )                                          >vPUHVER 1 1 H-WINDOW W-GOTOXY ." Protseduurid"                 MAKE-PW ScP @ 16 + W-BORDER ScP @ 16 + W-CLEAR 1 X.RIPP !       >MENYY ScP @ 32 + @ I.RIPP ! I.ON                               EDIT-RIPP                                                       <vPUHVER ;                                                      -->                                                             : NExT-ATOM                                                     NEXT-ATOM DROP ?Array IF MYSELF THEN ;                          ( #17                                                09/13/91 ) : EDIT-FTX NOOP ;                                               : RIPP-FTX ( --- i f )                                          >vPUHVER 1 1 H-WINDOW W-GOTOXY ." Vabad tekstid"                MAKE-TW ScP @ 16 + W-BORDER ScP @ 16 + W-CLEAR 2 X.RIPP !       >MENYY 0 DUP I.ACT! I.RIPP ! I.ON                               EDIT-FTX                                                        <vPUHVER ;                                                      : MAKE-FA.ARRAY ( --- )                                         MASTER_RECORD 55 + C@ 0 >                                        IF MASTER_RECORD 55 + C@ DUP 4 * DECL FA.ARRAY !                   JUURIK @ AIT ! 0                                                DO AIT @ @ FA.ARRAY @ I 4 * + ! NEXT-ATOM DROP LOOP          THEN ;                                                         -->                                                                                                                             ( #18                                                09/15/91 ) : EDIT-FA NOOP ;                                                : MAKE-AW ( --- )                                               FAT-W @ ScP !                                                   32 ScP @ ! MASTER_RECORD 55 + C@ DUP ScP @ 4 + ! W.LENGTH        1 ScP @ 8 + ! FA.ARRAY @ ScP @ 28 + !                          MAKE-WP 0 ScP @ 32 + ! ;                                        : RIPP-FA ( --- i f )                                           >vPUHVER 1 1 H-WINDOW W-GOTOXY ." Vabad aatomid ja tabelid"     MAKE-AW ScP @ 16 + W-BORDER ScP @ 16 + W-CLEAR 3 X.RIPP !       >MENYY 0 DUP I.ACT! I.RIPP ! I.ON                               EDIT-FA                                                         <vPUHVER ;                                                      : @TL MASTER-R @ 16 + @ ;                                       : @TT MASTER-R @ 11 + C@ ;                                      ;S                                                              ( #19                                                09/15/91 ) : EDIT-TAB NOOP ;                                               : MAKE-TABW ( --- )                                             TAB-W @ ScP !                                                   32 ScP @ ! MASTER-R @ 11 + C@ DUP ScP @ 4 + ! W.LENGTH           1 ScP @ 8 + ! TAB.ARRAY @ ScP @ 28 + !                         MAKE-WP 0 ScP @ 32 + ! ;                                        : RIPP-TAB ( --- i f )                                          >vPUHVER 1 1 H-WINDOW W-GOTOXY ." Tabelid"                      MAKE-TABW ScP @ 16 + W-BORDER ScP @ 16 + W-CLEAR 4 X.RIPP !     >MENYY 0 DUP I.ACT! I.RIPP ! I.ON                               EDIT-TAB                                                        <vPUHVER ;                                                      ;S                                                                                                                                                                                              (                                                    09/20/91 ) : MAKE-TAB.ARRAY ( --- )                                        MASTER_RECORD 55 + C@ 0 >                                        IF MASTER_RECORD 55 + C@ DUP 4 * DECL FA.ARRAY !                   JUURIK @ AIT ! 0                                                DO AIT @ @ FA.ARRAY @ I 4 * + ! NExT-ATOM LOOP               THEN ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         