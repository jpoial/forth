(                                                    10/18/89 )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( Area for CODE                                      12/09/89 ) : \ ?EXEC OUT @ 15 > IF CR THEN [COMPILE] .( CR ;  IMMEDIATE    : VAR VARIABLE ;                                                HEX 1000 CONSTANT ASIZE                                         VAR ASTART  ASIZE 10000 HERE - ABS MIN DUP ' ASIZE 4 + ! ALLOT  HERE CONSTANT ALIMIT                                            DECIMAL                                                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( # 2 File interface  PC-DOS 2.0: D>S ?DISCERR INITSA10/27/87 ) : +C! ( N ADR --- )                                                SWAP OVER C@ + SWAP C! ;                                     : ?DISCERR ( errcode --- )                                       ?DUP IF CR .STATUS ABORT THEN ;                                : INITSA ( sa handle_pars --- )                                   ROT SEEK-ABS ?DISCERR ;                                       : CURRSA ( handle_pars --- sa )                                   2DUP ?OFFSET DUP >R SEEK-ABS ?DISCERR R> ;                    (             HANDLE ATFILE )                                   ( : FILELEN ( --- len ) ( ATFILE ?FILESIZE 0 ATFILE INITSA ; )  -->                                                                                                                                                                                                                                                                                                                             ( # 3 File interface  PC-DOS 2.0: LREAD LWITE TOBYTE 10/22/87 ) : LREAD ( addr len handle_pars --- eof )                          2SWAP SWAP READ DUP                                             CASE 0 OF SWAP DROP ENDOF                                           -1 OF ENDOF                                                 ( ELSE ) ?DISCERR                                               ENDCASE ;                                                     : LWRITE ( addr len handle_pars --- )                            2SWAP SWAP WRITE ?DISCERR DROP ;                               -->                                                             : TOBYTE ( addr1 c --- addr2 )                                   ENCLOSE DROP SWAP DROP + ;                                       -->                                                                                                                                                                                                                                                           ( # 4 File intrface   PC-DOS 2.0: CHEXT MKEXT OPEXT  10/22/87 ) -->                                                             : CHEXT ( eaddr handle_pars --- \ replace file extension )       IF ( avatud ) DUP DUP @ CLOSE-FILE ?DISCERR                     THEN 4 + COUNT ASCII . TOBYTE 1+                                SWAP 1+ OVER 3 CMOVE 0 SWAP 3 + C! ;                           : OPEXT ( eaddr handle_pars --- )                                       ( replace extension & open file )                        2DUP >R >R CHEXT R> R> OPEN-FILE ?DISCERR ;                    : MKEXT ( eaddr handle_pars --- )                                       ( replace extensiom & make file )                        2DUP >R >R CHEXT R> R> MAKE-FILE ?DISCERR ;                    -->                                                                                                                                                                                                                                                             ( # 5 KONEC                                          05/04/90 ) : KONEC ( --- addr )                                            2 H@ ?fs: - 16 * 20000 - ;                                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( # 6 Memory: ?ALLOT,ARRAY,DYNAR,ALLOC,BARRAY        02/07/89 ) : ?ALLOT ( n --- )                                                      HERE + DUP KONEC U< 0= 2 ?ERROR DP ! ;                  : ARRAY <BUILDS 4 * HERE SWAP DUP ?ALLOT ERASE                          DOES> SWAP 2 <-L + ;                                    ( : HARRAY <BUILDS 2 * HERE SWAP DUP ?ALLOT ERASE                       DOES> SWAP 2 * + ;  )                                   ( : DYNAR )                                                     (   <BUILDS  0 , DOES> @ SWAP 2 <-L + ; )                       ( : ALLOC ( N CFA ---  ;   NB! ['] ANNAB CFA )                  (   >BODY 4 + ( <BUILDS !!! ) ( HERE SWAP ! 4 * ?ALLOT ; )      : BARRAY <BUILDS  DUP , 1 + DUP HERE SWAP                          BLANK ALLOT DOES> SWAP OVER @ OVER                              - 0 < 27 ?ERROR + 4 + ;                                      -->                                                                                                                             ( # 7 .MSG                                           12/09/89 ) HANDLE MESSFILE MESSFILE FILENAME MOD2VI.MSG                    : ?MESSERR ( f n --- )                                                  SWAP                                                            IF CR 7 EMIT ." .MSG: can't read message # " .                  ELSE DROP                                                       THEN ;                                                  : .MSG ( n --- )        ( type message from .MSG-file )                 DUP >R                                                          MESSFILE OPEN-FILE-R/O R@ ?MESSERR                              64 * MESSFILE INITSA                                            HERE 64 MESSFILE LREAD DUP R@ ?MESSERR 0=                       IF HERE 64 -TRAILING TYPE                                       THEN MESSFILE CLOSE-FILE R> 2DROP ;                     -->                                                                                                                             ( # 8 CSTR, STR, DEST|SOUR SOUR|DEST                 10/15/89 ) HEX                                                             : CSTR, ( addr --- )                                                    DUP C@ 1+ HERE SWAP DUP ?ALLOT CMOVE ;                  : STR, ( addr --- )                                                     COUNT HERE SWAP DUP ?ALLOT CMOVE ;                      : DEST|SOUR ( destad sourad --- )                                       ( concatenates two counted strings dest|sour -> dest )          SWAP >R DUP COUNT R@ COUNT + SWAP CMOVE                         C@ R@ C@ + R> C! ;                                      : SOUR|DEST ( sourad destad --- )                                       ( concatenates two counted strings sour|dest -> dest )          DUP >R 1+ OVER C@ ( s da sl )                                   OVER + R@ C@ CMOVE> ( s )                                       DUP C@ R@ C@ + R@ C! ( s )                                      COUNT R> 1+ SWAP CMOVE ; -->                            ( # 9 HEREPARA COPY_ENV COUNTZ                       10/23/89 ) : HEREPARA HERE 0F + 0FFFF0 AND DUP DP ! ;                      VARIABLE ENV_ADDR                                               : COPY_ENV 2C H@ 0 HEREPARA DUP ENV_ADDR ! ADDR>S&O                     DUP 10 ->L SWAP 0FFFF AND                                       COUNT_ENV DUP ALLOT CMOVEL ;                            : COUNTZ ( addr --- addr l )                                            DUP 0 SCAN DROP OVER - ;                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( #10 GET_ENV MOVE_ENV INIT_OBJ                      10/15/89 ) : GET_ENV ( addr1 --- addr2 )                                           ENV_ADDR @                                                      BEGIN 2DUP SWAP COUNT S= OVER C@ 0= OR 0=                       WHILE 0 SCAN DROP 1+                                            REPEAT DUP C@ IF SWAP C@ +                                                    ELSE SWAP DROP THEN ;                     : MOVE_ENV ( toaddr cname --- )                                         SWAP >R GET_ENV COUNTZ DUP R@ C!                                R> 1+ SWAP CMOVE ;                                      DIRECTORY OBJECTPATH OBJECTPATH 40 ERASE                        DIRECTORY LIBPATH LIBPATH 40 ERASE                              : INIT_OBJ COPY_ENV                                                     OBJECTPATH LIT" OBJECT=" MOVE_ENV                               LIBPATH LIT" LIBRARY=" MOVE_ENV ENV_ADDR @ DP ! ;       -->                                                             ( #11 OPEN_OBJ                                       10/23/89 ) VARIABLE OBJNAME 0C ALLOT                                       HANDLE OBJFILE                                                  : OPEN_OBJ OBJFILE DROP 44 ERASE                                        OBJFILE DROP 4 + DUP >R                                         OBJECTPATH DEST|SOUR R@ OBJNAME DEST|SOUR                       OBJFILE OPEN-FILE-R/O                                           IF R@ 40 ERASE                                                     R@ LIBPATH DEST|SOUR R@ OBJNAME DEST|SOUR                       OBJFILE OPEN-FILE-R/O DUP                                       IF ." Module " OBJNAME COUNT TYPE                                  ."  cannot be opened"                                        THEN ?DISCERR                                                THEN R> DROP ;                                          -->                                                                                                                             ( #12 F-WORD                                         07/22/88 ) VARIABLE LOC#                                                   : F-WORD ( CHAR --- ADDR )                                          HERE 1+ 0  0 HERE C!                                            BEGIN 1 LOC# +! OVER 1 OBJFILE LREAD                              IF DROP -1                                                      ELSE OVER C@                                                      IF OVER C@  DUP BL < IF DROP BL DUP 3 PICK C! THEN                3 PICK =                                                        IF HERE C@ IF DROP -1 THEN                                      ELSE SWAP 1+ SWAP  HERE C@ 1+ HERE C!                           THEN                                                          ELSE DROP -1                                                    THEN                                                          THEN  DUP UNTIL                                            -->                                                            ( #13 F-WORD <end>  FLOAD                            04/23/90 )     DROP DROP DROP  HERE C@ 0=                                      IF 1 HERE C! 0 HERE 1+ C!                                       THEN                                                            BL HERE DUP C@ + 1+ C!                                          HERE ;                                                      : NEW-WORD ( --- ) ['] F-WORD UWORD ! ;                         : OLD-WORD ( --- ) 0 UWORD ! ;                                  : FLOAD ( ---  ; load file - not screen file )                      OPEN_OBJ 0 LOC# !                                               ( NEW-ABORT ) NEW-WORD INTERPRET OLD-WORD                       OBJFILE CLOSE-FILE ?DISCERR ;                                -->                                                                                                                                                                                                                                                            ( #14 SOURCE$ NOSOURCE SET_SOUR                      04/06/88 ) DIRECTORY SOURNAME                                              : SOURCE$ SOURNAME [COMPILE] DIRNAME ;                          : NOSOURCE SOURNAME 40 ERASE ;                                  NOSOURCE                                                        : SET_SOUR SOURNAME C@ 0=                                               IF SOURNAME LIT" SOURCE=" MOVE_ENV                                 SOURNAME OBJNAME DEST|SOUR                                      OBJNAME COUNT + 1- C@ ASCII D =                                 IF   LIT" DEF"                                                  ELSE LIT" MOD" THEN                                             1+ SOURNAME COUNT + 3 - 3 CMOVE                              THEN ;                                                  -->                                                                                                                                                                                             ( WRITE_ERR ERR_EXIT                                 04/23/90 )                                                                 HANDLE ERRFILE ERRFILE FILENAME M2ERR.TMP                                                                                       : WRITE_ERR CR 1C .MSG SPACE OBJFILE .FILENAME SPACE                    1D .MSG SPACE HEX LOC# @ . DECIMAL                              ERRFILE MAKE-FILE ?DISCERR                                      SET_SOUR SOURNAME DUP C@ 1+ ERRFILE LWRITE                      LOC# 4 ERRFILE LWRITE                                           ERRFILE CLOSE-FILE ?DISCERR ;                                                                                           : ERR_EXIT WRITE_ERR 8 XCODE ! EXIT_FORTH ;                     DECIMAL                                                          -->                                                                                                                                                                                            ( #16 lengths                                        01/13/88 )                                                                 32 CONSTANT M.R.MAX#EL                                          64 CONSTANT M.R.ELLEN                                           M.R.MAX#EL M.R.ELLEN * 4 + CONSTANT M.R.TABLEN                  256 CONSTANT #RCFA                                              4096 M.R.TABLEN + CONSTANT MBOOTLEN                              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( #17  BOOT                                          01/16/91 ) VARIABLE MBOOT MBOOTLEN 4 - ALLOT                               HERE CONSTANT SB-END                                            : ADP    MBOOT ;                                                : MCODELEN MBOOT  4 + ;                                         : ST-FFL MBOOT  8 + ;                                           : BIN-BASE-AD MBOOT 12 + ;                                      : LATEST-AD MBOOT 16 + ;                                        : SETTABLE-DP MBOOT 20 + ;                                      : #PROC  ( global proc.number / 0 for ext.modules )                MBOOT 24 + ;                                                 : EXT-CHAIN MBOOT 28 + ;   0 EXT-CHAIN !                        : PASSBUF MBOOT 32 + ;                                          : M.R.OUTTABLE MBOOT 32 + #RCFA 4 * + ;                         : SETTABLE-BUFFER MBOOT 32 + #RCFA 4 * + M.R.TABLEN + ;          ;S                                                             ( #18                                                01/16/91 )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 