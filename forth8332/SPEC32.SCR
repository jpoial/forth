( SPEC32.SCR                                         10/26/90 )  -->                                                                                                                                       Formal specifications of Forth-words                                                                                                    Jaanus  Po"ial                                                                                                           Tartu University, Dept.Comput.Sci.                                                                                                 202400 Tartu, Estonia                                                                                                                                                                        Forth-83/32 for IBM-PC/XT/AT                                                                                                                                                                                                                        ( #1 - Portability words                             10/26/90 )                                                                 4 CONSTANT CELL                                                 : CELL+ CELL + ;                                                : CELL* 2 <-L ;                                                 : CELL- CELL - ;                                                : CELLS 2 <-L ;                                                 : -CELL CELL NEGATE ;                                                                                                           : >DATA ( cfa --- doesad )                                          >BODY CELL+ ;     ( in Forth-83/32 <BUILDS ... DOES> !!! )  : DATA> ( doesad --- cfa )                                          CELL- BODY> ;     ( vice versa )                            ' DECIMAL @ CONSTANT COLDEF.CFCONT  ( usual colon-definitions )                                                                  -->                                                            ( #2 System extensions                               10/26/90 )                                                                 : \ ?EXEC OUT @ 15 > IF CR THEN [COMPILE] .( CR ;  IMMEDIATE                                                                    : ?DISCERR ( errcode --- )                                          ?DUP IF CR .STATUS ABORT THEN ;                                                                                             : INITSA ( sa handle_pars --- )                                     ROT SEEK-ABS ?DISCERR ;                                                                                                     : CURRSA ( handle_pars --- sa )                                     2DUP ?OFFSET DUP >R SEEK-ABS ?DISCERR R> ;                                                                                   -->                                                                                                                                                                                            \ #3 System extensions                               10/26/90 )                                                                 : LREAD ( addr len handle_pars --- eof )                            2SWAP SWAP READ DUP                                             CASE 0 OF SWAP DROP ENDOF                                           -1 OF ENDOF                                                 ( ELSE ) ?DISCERR                                               ENDCASE ;                                                                                                                   : LWRITE ( addr len handle_pars --- )                               2SWAP SWAP WRITE ?DISCERR DROP ;                                                                                             -->                                                                                                                                                                                                                                                            \ #4 System extensions                               10/26/90 )                                                                 : TOBYTE ( addr1 maxlen c --- addr2 )                               ENCLOSE DROP SWAP DROP + ;                                                                                                  : CHEXT ( eaddr handle_pars --- \ replace file extension )          IF ( open ) DUP DUP @ CLOSE-FILE ?DISCERR                       THEN 4 + COUNT ASCII . TOBYTE 1+                                SWAP 1+ OVER 3 CMOVE 0 SWAP 3 + C! ;                                                                                        : OPEXT ( eaddr handle_pars --- )                                       ( replace extension & open file )                           2DUP >R >R CHEXT R> R> OPEN-FILE ?DISCERR ;                                                                                  -->                                                                                                                            \ #5 System extensions                               10/26/90 )                                                                 : MKEXT ( eaddr handle_pars --- )                                       ( replace extensiom & make file )                           2DUP >R >R CHEXT R> R> MAKE-FILE ?DISCERR ;                                                                                 : hbound ( --- addr )                                               2 H@ ?fs: - 16 * 20000 - ;                                                                                                  : ?ALLOT ( n --- )                                                  HERE + DUP hbound U< 0= 2 ?ERROR DP ! ;                                                                                      -->                                                                                                                                                                                                                                                            \ #6 Data structures                                 10/26/90 )                                                                 : ARRAY   <BUILDS CELL * HERE SWAP DUP ?ALLOT ERASE                       DOES> SWAP CELL* + ;                                                                                                   -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ # 7 - Additions to the bottom                      10/29/90 )                                                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (                                                    10/29/90 ) -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ # 14  Specification handling                       04/25/88 ) DECIMAL                                                                                                                         ( Words to operate with symbols )                                                                                               VARIABLE #SYMB   0 #SYMB !  ( Number of symbols in use )                                                                        : SSCONS  ( Def:  code  SSCONS  XXX ;  Use:  --- code  )            DUP 128 U<                                                      IF <BUILDS ,                                                    ELSE CR ." Impossible code " U. ABORT                           THEN                                                            DOES> @ ;                                                                                                                   0 SSCONS SSPATT  ( Pattern )                                     -->                                                            \ # 15 - continues                                   04/25/88 )                                                                 : SSYMB? ( cfa --- flag )                                           >BODY @ ['] SSPATT >BODY @ = ;                                                                                              128 ARRAY SSNFAS   ( name field addresses )                                                                                     ASCII * CONSTANT WLD    ( "wild" character code )                                                                               : SSINIT ( ---  ; users word to start )                             128 0 DO                                                                  0  I SSNFAS  !                                              LOOP                                                      0 #SYMB ! ;                                                 SSINIT                                                           -->                                                            \ # 16 - continues                                   04/25/88 ) ( Users level to operate with symbols )                                                                                         : SSYMB  ( Def: SSYMB XXX ; Use:  --- code  )                            ( Main word to create symbols /type names/ )               #SYMB @ 1+ DUP SSCONS #SYMB !                                   LATEST #SYMB @ SSNFAS ! ;                                                                                                   : AUXSYMB ( Def: code AUXSYMB XXX ;  Use:  --- code )                     ( Word to define synonyms for the symbol input )          DUP 128 U<  OVER SSNFAS @ 0= NOT AND                            IF  SSCONS                                                      ELSE CR ." Can't define AUXSYMB " U. ABORT                      THEN ;                                                       -->                                                                                                                            \ # 17 - continues                                   04/25/88 ) : EXALTSYMB  ( In form:  EXALTSYMB  XXX )                                    ( AUXSYMB XXX  replaces the main code for output )     BL WORD FIND                                                    IF DUP SSYMB?                                                       IF DUP >NAME SWAP EXECUTE SSNFAS !                              ELSE CR >NAME .NAME ."  is not a symbol" ABORT                  THEN                                                        ELSE CR COUNT TYPE ."  ??" ABORT                                THEN ;                                                       -->                                                                                                                                                                                                                                                                                                                                                                                            \ # 18 - continues                                   04/25/88 ) : SS. ( code --- ; symbol output )                                  DUP 0 > OVER 128 U< AND                                         IF SSNFAS @ DUP                                                     IF .NAME                                                        ELSE DROP CR ." Symbol has no image for SS. " ABORT             THEN                                                        ELSE  DUP 128 > OVER 160 < AND                                      IF 31 AND DUP 3 > OVER 10 < AND                                     IF WLD EMIT 1 .R WLD EMIT                                       ELSE DUP 9 >                                                        IF WLD EMIT 2 .R WLD EMIT                                       ELSE 0 DO WLD EMIT LOOP                                     THEN THEN SPACE                                             ELSE CR ." Illegal code " U. ABORT THEN                     THEN ; -->                                                  \ # 19 - continues                                   04/25/88 ) ( Words to operate with specifications )                                                                                        16 CONSTANT SSIZE   ( Max size of the specification in bytes )                                                                  : SCOUNTS ( ad --- ad+2 L1 L2 )                                     DUP 2+ SWAP C@ OVER 1 - C@ ;                                                                                                : SZERO= ( ad --- flag )                                            SCOUNTS + 2+ SWAP DROP SSIZE > ;                             -->                                                                                                                                                                                                                                                                                                                                                                                            \ # 20 - continues                                   04/25/88 ) : S. ( ad --- ; specification output )                              DUP SZERO=                                                      IF DROP ." SZERO "                                              ELSE SCOUNTS ." S[ " ROT ROT DUP                                    IF 0 DO                                                                 DUP C@ SS. 1+                                                LOOP                                                       ELSE DROP                                                       THEN  ." --- " SWAP DUP                                         IF 0 DO                                                                 DUP C@ SS. 1+                                                LOOP                                                       ELSE DROP                                                       THEN DROP ." ] "                                            THEN ;                             -->                      \ # 21 - continues                                   04/25/88 ) VARIABLE SRSTFLAG  0 SRSTFLAG !                                                                                                 : SRSTEST ( ad --- )                                                DUP SCOUNTS >R + R> DUP                                         IF 0 DO                                                                 DUP C@ 128 >                                                    IF -1 SRSTFLAG ! OVER SCOUNTS DROP DUP                              IF 0 DO                                                                 OVER C@ OVER C@ =                                               IF 0 SRSTFLAG ! LEAVE                                           THEN 1+                                                      LOOP                                                       ELSE DROP                                                       THEN                                             -->                                                            ( # 22 - continues                                   04/25/88 )                 DROP SRSTFLAG @                                                 IF DROP CR S. ." is not correct " ABORT                         THEN                                                        THEN 1+                                                      LOOP                                                       ELSE DROP                                                       THEN DROP DROP ;                                                                                                            HERE 255 C, 255 C, CONSTANT SZERO                                -->                                                                                                                                                                                                                                                                                                                                                                                            \ # 23 - continues                                   04/25/88 ) : SWINCR? ( ad --- flag )                                           0 SWAP SCOUNTS + DUP                                            IF 0 DO                                                                 DUP C@ 128 >                                                    IF SWAP DROP -1 SWAP DUP C@ 32 + OVER C!                        THEN  1+                                                     LOOP                                                       ELSE DROP                                                       THEN DROP ;                                                                                                                 VARIABLE SWRENOLD  0 SWRENOLD !                                                                                                 VARIABLE SWRENNEW  0 SWRENNEW !                                  -->                                                                                                                            \ # 24 - continues                                   04/25/88 ) : SWRENAME ( ad --- )                                               129 SWRENNEW !  DUP SCOUNTS DROP DUP >R + R> 0                  DO 1 - DUP C@ 160 >                                                 IF DUP C@ SWRENOLD ! OVER SCOUNTS + 0                               DO DUP C@ SWRENOLD @ =                                              IF SWRENNEW @ OVER C!                                           THEN 1+                                                     LOOP DROP 1 SWRENNEW +!                                     THEN                                                        LOOP DROP DROP ;                                             -->                                                                                                                                                                                                                                                                                                                            \ # 25 - continues                                   04/25/88 ) : SWNORM ( ad --- )                                                 DUP SZERO=                                                      IF SZERO SWAP 2 CMOVE                                           ELSE DUP SRSTEST DUP SWINCR?                                        IF SWRENAME                                                     ELSE DROP                                                       THEN                                                        THEN ;                                                                                                                      : LONG= ( ad1 ad2 len --- flag )                                    S= ;                                                                                                                        VARIABLE SLDIFF  0 SLDIFF !                                      -->                                                                                                                            \ # 26 - continues                                   04/25/88 ) : SLESS? ( ad1 ad2 --- flag )                                       OVER C@ OVER C@ - SLDIFF !                                      OVER DUP C@ SWAP 2+ DUP ROT + SLDIFF @ LONG=                    IF OVER 2+ SLDIFF @ + OVER DUP C@ SWAP 2+ SWAP LONG=                IF OVER DUP C@ + 2+ SLDIFF @ +                                      OVER DUP DUP C@ + 2+ SWAP 1+ C@ LONG=                           IF DROP DROP -1                                                 ELSE DROP DROP 0                                                THEN                                                        ELSE DROP DROP 0                                                THEN                                                        ELSE DROP DROP 0                                                THEN ;                                                       -->                                                                                                                            \ # 27 - continues                                   04/25/88 ) : NZSREL  ( ad1 ad2 --- rel )                                       OVER C@ OVER C@ =                                               IF DUP C@ OVER 1+ C@ + 2+ LONG=                                     IF 4 ELSE 0                                                     THEN                                                        ELSE OVER C@ OVER C@ >                                              IF SLESS?                                                           IF 1 ELSE 0                                                     THEN                                                        ELSE SWAP SLESS?                                                    IF 2 ELSE 0                                                     THEN                                                        THEN                                                        THEN ;                                                       -->                                                            \ # 28 - continues                                   04/25/88 ) : NOWILD? ( ad --- flag )                                           -1 SWAP SCOUNTS + DUP                                           IF 0 DO                                                                  DUP C@ 128 >                                                    IF >R DROP 0 R> LEAVE                                           THEN  1+                                                    LOOP                                                       ELSE DROP                                                       THEN DROP ;                                                                                                                  -->                                                                                                                                                                                                                                                                                                                            \ # 29 - continues                                   04/28/88 ) : SREL ( ad1 ad2 --- rel )                                          OVER SZERO=                                                     IF DUP SZERO=                                                       IF DROP DROP 4                                                  ELSE DROP DROP 1                                                THEN                                                        ELSE DUP SZERO=                                                     IF DROP DROP 2                                                  ELSE OVER C@ OVER C@ - >R OVER 1+ C@ OVER 1+ C@ - R> =              IF OVER C@ OVER C@ <                                                IF OVER NOWILD?                                                 ELSE DUP NOWILD?                                                THEN                                             -->                                                                                                                            ( # 30 - continues                                   04/28/88 )                 IF NZSREL                                                       ELSE DROP DROP 0                                                THEN                                                        ELSE DROP DROP 0                                                THEN                                                        THEN                                                        THEN ;                                                                                                                      : SPTOHERE ( ad --- )                                               DUP SZERO=                                                      IF DROP SZERO HERE 2 ?ALLOT 2 CMOVE                             ELSE HERE OVER DUP C@ SWAP 1+ C@ + 2+ DUP ?ALLOT CMOVE          THEN ;                                                       -->                                                                                                                            \ # 31 - continues                                   04/28/88 ) : SCONSTANT                                                         <BUILDS SPTOHERE                                                DOES> ;                                                                                                                     : SVARIABLE                                                         <BUILDS HERE CELL+ , SSIZE ?ALLOT                               DOES> ;                                                                                                                     : SARRAY                                                            <BUILDS 0 DO                                                                 HERE CELL+ , SSIZE ?ALLOT                                    LOOP                                                  DOES> SWAP SSIZE CELL+ * + ;                                 -->                                                                                                                            \ # 32 - continues                                   04/28/88 ) 32 CONSTANT #AUXSP                                                                                                              : SPARRAY                                                           <BUILDS SSIZE * ?ALLOT                                          DOES> SWAP SSIZE * + ;                                                                                                      #AUXSP SPARRAY SPAREA                                                                                                           VARIABLE SPUSED  0 SPUSED !                                                                                                     : SPMEM ( --- ad )                                                  SPUSED @ #AUXSP MOD SPAREA   1 SPUSED +! ;                                                                                  VARIABLE SPCUR  0 SPCUR !                                        -->                                                            \ # 33 - continues                                   04/28/88 ) VARIABLE SCANAREA 32 ?ALLOT                                     VARIABLE SCPTR  0 SCPTR !                                       VARIABLE SCCEIL  0 SCCEIL !                                     VARIABLE SPMOFFSET  0 SPMOFFSET !                               VARIABLE SPLRFLAG  0 SPLRFLAG !                                                                                                 : SSFIND ( --- cfa/0 )                                              SCANAREA FIND NOT                                               IF DROP 0                                                       ELSE DUP SSYMB? NOT                                                 IF DROP 0                                                       THEN                                                        THEN ;                                                       -->                                                                                                                            \ # 34 - continues                                   04/28/88 ) : MAKESMB ( code --- )                                              SPCUR @ SPMOFFSET @                                             DUP SSIZE <                                                     IF + C!  1 SPMOFFSET +!                                             SPCUR @ SPLRFLAG @ - DUP C@ 1+ SWAP C!  ( true = -1 )       ELSE DROP DROP DROP CR ." Too many spec. symbols " ABORT        THEN ;                                                                                                                      : MAKEWLD ( --- )                                                   SCANAREA C@ 31 AND 128 + MAKESMB ;                                                                                          : MAKESS ( cfa --- )                                                EXECUTE MAKESMB ;                                            -->                                                                                                                            \ # 35 - continues                                   04/28/88 ) : WLD? ( --- )                                                      SCANAREA DUP C@ DUP                                             IF 0 DO                                                                  1+ DUP C@ WLD = NOT                                             IF DROP CR ." Illegal symbol "                                      SCANAREA COUNT TYPE ABORT                                   THEN                                                        LOOP DROP                                                  ELSE DROP DROP                                                  THEN ;                                                       -->                                                                                                                                                                                                                                                                                                                            \ # 36 - continues                                   04/28/88 ) : WLDORSEP ( --- )                                                  SPLRFLAG @                                                      IF WLD? MAKEWLD                                                 ELSE SCANAREA 1+ C@ ASCII - =                                       IF -1 SPLRFLAG !                                                ELSE WLD? MAKEWLD                                               THEN                                                        THEN ;                                                                                                                      : SPMAKE ( --- )                                                    ASCII ] WORD DUP 1+ SCPTR ! DUP C@ + 1+ SCCEIL !                SCCEIL @ BL OVER C! 1+ ASCII ] OVER C! 1+ BL SWAP C!            SPMEM SPCUR !  2 SPMOFFSET !  0 SPCUR @ C!                      0 SPCUR @ 1+ C!  0 SPLRFLAG !                                -->                                                            ( # 37 - continues                                   05/02/88 )     BEGIN                                                               SCPTR @ 255 BL ENCLOSE  SCPTR +! OVER - 31 AND >R               R@ SCANAREA C!   + DUP SCCEIL @ < SWAP                          SCANAREA 1+   R> 1+  CMOVE                                  WHILE                                                               SSFIND DUP                                                      IF MAKESS                                                       ELSE DROP WLDORSEP                                              THEN                                                        REPEAT                                                          SPLRFLAG @                                                      IF SPCUR @ SWNORM                                               ELSE CR ." Right part not found " ABORT                         THEN ;                                                       -->                                                            \ # 38 - continues                                   04/28/88 ) : (S[)                                                              R@ 2+ R> @ >R ;                                                                                                             : S[                                                                SPMAKE  STATE @                                                 IF COMPILE (S[) HERE 0 , SPCUR @ SPTOHERE HERE SWAP !           ELSE SPCUR @                                                    THEN ; IMMEDIATE                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ # 39 - continues                                   04/28/88 ) : SUBSTI ( ad ---  ; uses SWRENOLD SWRENNEW )                       SCOUNTS + DUP                                                   IF 0 DO DUP C@ SWRENOLD @ =                                              IF SWRENNEW @ OVER C!                                           THEN  1+                                                    LOOP                                                       ELSE DROP                                                       THEN DROP ;                                                                                                                 : MPREN ( Sourcead Destad --- )                                     129 SWRENNEW !  OVER OVER SSIZE CMOVE                           OVER SCOUNTS DROP DUP >R + R> DUP                               IF 0 DO 1 - DUP C@ 128 >                                                 IF DUP C@ SWRENOLD ! OVER SUBSTI SWRENNEW @         -->                                                            ( # 40 - continues                                   05/02/88 )                  0 SWRENNEW ! >R >R >R DUP SUBSTI R> R> R>                       1+ SWRENNEW !                                               THEN                                                        LOOP                                                       ELSE DROP                                                       THEN  DROP DROP DROP ;                                                                                                      : MPSS ( Op1ad Op2ad Destad --- )                                   >R OVER 1+ C@ OVER C@ >                                         IF OVER C@ R@ C! OVER SCOUNTS DROP R@ 2+ SWAP CMOVE                 OVER SCOUNTS >R + OVER C@ R> SWAP - DUP R@ 1+ C!                R@ SCOUNTS DROP + SWAP CMOVE                                    SWAP DROP SCOUNTS >R + R> R@ SCOUNTS + + OVER R@ 1+             DUP C@ ROT + DUP R@ C@ + SSIZE >                         -->                                                            ( # 41 - continues                                   05/04/88 )         IF DROP DROP DROP DROP DROP R> DROP                                 CR ." Product too long " ABORT                              THEN                                                            SWAP C! SWAP CMOVE                                          ELSE OVER OVER C@ SWAP 1+ C@ - R@ C!                                DUP 1+ C@ R@ 1+ C!  DUP 2+ R@ 2+ R@ C@ CMOVE                    OVER SCOUNTS DROP R@ SCOUNTS DROP + SWAP DUP                    R@ C@ + DUP R@ 1+ C@ + SSIZE >                                  IF DROP DROP DROP DROP DROP DROP R> DROP                            CR ." Product too long " ABORT                              THEN                                                            R@ C! CMOVE SWAP DROP SCOUNTS DROP +                            R@ SCOUNTS >R + R> CMOVE                                    THEN  R> DROP ;                                              -->                                                            \ # 42 - continues                                   04/28/88 ) : S* ( ad1 ad2 --- ad3 )                                            OVER SZERO=                                                     IF DROP DROP SZERO                                              ELSE DUP SZERO=                                                     IF DROP DROP SZERO                                              ELSE >R SPMEM DUP >R SSIZE CMOVE R> R>                              SPMEM DUP >R SSIZE CMOVE R> DUP SWINCR? DROP                    0 SPLRFLAG ! OVER 1+ C@ OVER C@ MIN DUP                         IF >R OVER SCOUNTS + + OVER SCOUNTS DROP +                          R> 0 DO 1 - SWAP 1 - SWAP DUP C@ 128 <                                   IF OVER C@ 128 <                                                    IF OVER C@ OVER C@ = NOT                                            IF -1 SPLRFLAG ! LEAVE                                          THEN                            -->                                                            ( # 43 - continues                                   05/04/88 )                              ELSE OVER C@ SWRENOLD !                                             DUP C@ SWRENNEW !                                               >R >R >R DUP SUBSTI R> R> R>                                THEN                                                        ELSE OVER C@ SWRENNEW !                                             DUP C@ SWRENOLD !                                               >R >R DUP SUBSTI R> R>                                      THEN                                                        LOOP DROP DROP                                         ELSE DROP                                                       THEN  SPLRFLAG @                                                IF DROP DROP SZERO                                              ELSE OVER OVER SPMEM DUP SPCUR ! MPSS DROP                          DUP SPCUR @ SWAP MPREN                           -->                                                            ( # 44 - continues                                   05/04/88 )             THEN                                                        THEN                                                        THEN DUP SWNORM ;                                                                                                           : S@ ( ad --- spec )                                                @ ;                                                         : S! ( spec ad --- )                                                @ SSIZE CMOVE ;                                             : S= ( spec spec --- flag )                                         SREL 4 = ;                                                  : SGR= ( spec spec --- flag )                                       NZSREL 4 = ;                                                 -->                                                                                                                                                                                            \ #45 Operations with the sets                       10/31/90 )                                                                 : MAKE-CHAINHEAD ( --- addr )                                       HERE 0 , ( first ) 0 , ( last ) 0 , ( current ) ;                                                                           : DEF-CHAIN ( builds: --- ; in the form DEF-CHAIN XXX                        does: --- addr ; 3 fields - first, last, current )     <BUILDS MAKE-CHAINHEAD DROP                                     DOES> ;                                                                                                                     : MAKE-CHAINELEM ( --- addr )                                       HERE 0 , ( specif. ) 0 , ( next ) ;                                                                                         : TAKE-NEXT ( elem --- elem / 0 )                                   DUP IF CELL+ @ THEN ;                                        -->                                                            \ #46 Operations with the sets                       10/31/90 )                                                                 : CHAIN-EMPTY? ( chain --- flag )                                   @ 0= ;                                                                                                                      : FIRST-ELEM ( chain --- elem / 0 )                                 DUP CHAIN-EMPTY?                                                IF DROP 0                                                       ELSE DUP @ DUP ROT CELL+ CELL+ !                                THEN ;                                                                                                                      : NEXT-ELEM  ( chain --- elem / 0 )                                 CELL+ CELL+ DUP @ TAKE-NEXT                                     DUP ROT ! ;                                                                                                                  -->                                                            \ #47 Operations with the sets                       10/31/90 )                                                                 : IN-CHAIN? ( spec chain --- spec / 0 )                             DUP CHAIN-EMPTY?                                                IF DROP DROP 0                                                  ELSE @ 0                                                            BEGIN                                                               OVER @ DUP 4 PICK SGR=                                          IF SWAP DROP                                                    ELSE DROP                                                       THEN                                                            >R TAKE-NEXT R>                                                 OVER 0= OVER 0= 0= OR                                       UNTIL ROT DROP SWAP DROP                                    THEN ;                                                       -->                                                            \ #48 Operations with the sets                       10/31/90 )                                                                 : LAST-LINK ( chain --- addr )                                      DUP CHAIN-EMPTY?                                                IF ( first )                                                    ELSE @                                                             BEGIN                                                               DUP TAKE-NEXT DUP 0=                                            IF DROP -1                                                      ELSE SWAP DROP 0                                                THEN                                                        UNTIL CELL+                                                  THEN ;                                                                                                                       -->                                                                                                                            \ #49 Operations with the sets                       10/31/90 )                                                                 : SHORTADD-TO-CHAIN ( spec chain --- )                              OVER OVER IN-CHAIN? 2 PICK SZERO= OR                            IF DROP DROP                                                    ELSE                                                                DUP LAST-LINK                                                   MAKE-CHAINELEM                                                  DUP ROT !                ( link )                               DUP ROT CELL+ !          ( last )                               !                                                           THEN ;                                                                                                                       -->                                                                                                                                                                                            \ #50 Operations with the sets                       10/31/90 ) : DEL-FROM-CHAIN ( spec chain --- )                                 OVER OVER IN-CHAIN?                                             IF  DUP @ DUP @ 3 PICK SGR=                                         IF TAKE-NEXT SWAP ! DROP                                        ELSE  SWAP DROP                                                       BEGIN                                                               DUP TAKE-NEXT DUP @ 3 PICK SGR=                                 IF TAKE-NEXT OVER CELL+ ! -1                                    ELSE SWAP DROP 0                                                THEN                                                        UNTIL                                                     THEN                                                        ELSE DROP DROP                                                  THEN ;                                                       -->                                                            \ #51 Operations with the sets                       10/31/90 )                                                                 : DISPLAY-CHAIN ( chain --- )                                       DUP FIRST-ELEM 0                                                BEGIN                                                               OVER                                                        WHILE                                                               1+ CR DUP 2 .R ." . " SWAP @ S. OVER NEXT-ELEM SWAP         REPEAT                                                          DROP DROP DROP CR ." { No more element(s). }" ;                                                                             : CH1->CH2 ( chain1 chain2 --- )                                    3 CELLS CMOVE ;                                                                                                              -->                                                                                                                            \ #52 Operations with the sets                       10/31/90 )                                                                 : COPY-TO-CHAIN ( chainfrom chainto --- )                           SWAP DUP FIRST-ELEM                                             BEGIN                                                               DUP                                                         WHILE                                                               @ 2 PICK SHORTADD-TO-CHAIN DUP NEXT-ELEM                    REPEAT                                                          DROP DROP DROP ;                                                                                                            : ADD-CHAINS ( chain1 chain2 --- reschain )                         MAKE-CHAINHEAD                                                  ROT OVER COPY-TO-CHAIN                                          DUP >R COPY-TO-CHAIN R> ;                                    -->                                                            \ #53 Operations with the sets                       10/31/90 )                                                                 : ADD-TO-CHAIN ( spec chain --- )                                   OVER OVER IN-CHAIN? 2 PICK SZERO= OR                            IF DROP DROP                                                    ELSE                                                                DUP LAST-LINK                                                   MAKE-CHAINELEM                                                  DUP ROT !                ( link )                               DUP ROT CELL+ !          ( last )                               SWAP HERE SWAP SPTOHERE  ( copy )                               SWAP !                                                      THEN ;                                                                                                                       -->                                                                                                                            \ #54 Operations with the sets                       10/31/90 )                                                                 : MULT-CHAINS ( chain1 chain2 --- reschain )                        MAKE-CHAINHEAD 2 PICK CHAIN-EMPTY? 2 PICK CHAIN-EMPTY? OR       IF ROT DROP SWAP DROP                                           ELSE                                                                ROT MAKE-CHAINHEAD DUP >R COPY-TO-CHAIN R> ROT ROT              2 PICK FIRST-ELEM                                               BEGIN                                                               2 PICK FIRST-ELEM                                               BEGIN                                                               OVER @ OVER @ S* 3 PICK ADD-TO-CHAIN                            DROP 2 PICK NEXT-ELEM DUP 0=                                UNTIL DROP DROP 2 PICK NEXT-ELEM DUP 0=                     UNTIL DROP ROT DROP SWAP DROP                               THEN SZERO OVER DEL-FROM-CHAIN ; -->                        \ #55 Operations with the sets                       10/31/90 )                                                                 SSIZE 2 - CONSTANT MAX#STEPS                                                                                                    : CLOSURE-TRACE ( chain --- )                                       DUP DUP                                                         MAX#STEPS 1+ 1 DO                                                   CR ." Step " I . ."  HERE = " HERE U.                           OVER DISPLAY-CHAIN                                              2 PICK MULT-CHAINS DUP >R ADD-CHAINS R>                         CR ." Press a key " KEY DROP                                LOOP DROP DROP DROP ;                                                                                                        -->                                                                                                                                                                                            \ #56 Operations with the sets                       10/31/90 )                                                                 : TRANS-CLOSURE? ( chain --- reschain flag )                        DUP DUP 0                                                       BEGIN                                                               1+ DUP MAX#STEPS < 2 PICK CHAIN-EMPTY? 0= AND               WHILE                                                               >R 2 PICK MULT-CHAINS DUP >R ADD-CHAINS R> R>               REPEAT MAX#STEPS < SWAP DROP ROT DROP ;                                                                                     : CLEAR-CHAIN ( chain --- )                                         DUP CELL+ DUP CELL+ 0 SWAP ! 0 SWAP ! 0 SWAP ! ;                                                                             -->                                                                                                                                                                                            \ #57 Operations with the sets                       10/31/90 )                                                                 DEF-CHAIN CCC                                                   : TEST ( --- )                                                      CR ." Closure of:" CCC DISPLAY-CHAIN                            CCC TRANS-CLOSURE?                                              IF CR ." Exists." DISPLAY-CHAIN                                 ELSE CR ." Failure." DISPLAY-CHAIN                              THEN ;                                                                                                                       ;S                                                                                                                                                                                                                                                                                                                                                                                             \ #58 Operations with the sets                       10/31/90 ) CCC CLEAR-CHAIN                                                 S[ * --- ] CCC ADD-TO-CHAIN                   ( DROP )          S[ * --- * * ] CCC ADD-TO-CHAIN               ( DUP )           S[ ** * --- * ** ] CCC ADD-TO-CHAIN           ( SWAP )          ( S[ ** * --- ** * ** ] CCC ADD-TO-CHAIN        ( OVER )        ( S[ *** ** * --- ** * *** ] CCC ADD-TO-CHAIN   ( ROT )         ;S                                                              CCC CLEAR-CHAIN                                                 SSYMB T                                                         SSYMB F                                                         S[ T T --- T F ] CCC ADD-TO-CHAIN                               S[ F T --- T T ] CCC ADD-TO-CHAIN                               TEST                                                            ;S                                                                                                                              M                    -5   NIT    SRC           P-7  EERR!  TMP           P-O   EYMAP  ME            P-(  EXT    ZIP           _/@ 13     TRG           X_4  IO     MOD           }j!F  NOUT   MOD           {/  O      MOD           5  ERMS   MOD           '6  IEVE   MOD           EWj  ROG1   MOD           LicT~   ROG2   MOD           35\  ROG4   MOD           Lic]i  TR     MOD           m4  IMES10 MOD           Yx  ROG5   MOD           QhY  1      MOD           Ti2   13     MOD           U\   2      MOD           i2   4      MOD           wm2V  5      MOD           y2  6      MOD           `d2   7      MOD           z4	  8      MOD           z2
  3      MOD           2z   9      MOD           3  10     MOD           4  11     MOD           4  12     MOD           ^B   DL     EXE           ! OM     ZIP           #^#~ (                                                    01/31/91 ) : TEST ( --- )                                                      BEGIN                                                               ?TERMINAL                                                       IF                                                                  BASE @ HEX                                                      PCKEY DUP                                                       IF   CR ." Normal : " DUP 4 .R SPACE EMIT                       ELSE DROP CR ." Control: " 4 .R                                 THEN                                                            BASE !                                                      THEN                                                        AGAIN ;                                                                                                                      ;S                                                                                                                             (                                                    01/31/91 ) : TAB ( --- )                                                       BASE @ HEX CR 16 2                                              DO                                                                  CR I 16 0                                                       DO                                                                  DUP 16 * I + EMIT SPACE                                     LOOP DROP                                                   LOOP BASE ! ;                                               ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( Video services                                     02/07/91 ) BASE @ HEX                                                                                                                      : INT10H00H ( mode --- )                                            0 0 ROT 0 SWAP                                                  video-io DROP DROP DROP DROP ;                                                                                              : INT10H01H ( end start --- )                                       8 <-L OR 0 SWAP 0 0100                                          video-io DROP DROP DROP DROP ;                                                                                              : INT10H02H ( page col row --- )                                    8 <-L OR 0 ROT 8 <-L 0200                                       video-io DROP DROP DROP DROP ;                               -->                                                                                                                            ( Video services                                     02/07/91 )                                                                 : INT10H03H ( page --- col row end start )                          8 <-L 0 0 ROT 0300 video-io                                     DROP DROP DUP FF AND SWAP 8 ->L FF AND >R >R                    DUP FF AND SWAP 8 ->L FF AND R> R> ;                                                                                        : INT10H05H ( page --- )                                            0500 OR >R 0 0 0 R>                                             video-io DROP DROP DROP DROP ;                                                                                              : INT10H06H ( attrib col2 row2 col1 row1 n --- )                    0600 OR >R 8 <-L OR >R 8 <-L OR SWAP R> SWAP 8 <-L              R> video-io DROP DROP DROP DROP ;                            -->                                                                                                                            ( Video services                                     02/07/91 )                                                                 : INT10H07H ( attrib col2 row2 col1 row1 n --- )                    0700 OR >R 8 <-L OR >R 8 <-L OR SWAP R> SWAP 8 <-L              R> video-io DROP DROP DROP DROP ;                                                                                           : INT10H08H ( page --- attrib char )                                8 <-L 0 0 ROT 0800 video-io                                     DUP FF AND >R 8 ->L FF AND >R DROP DROP DROP R> R> ;                                                                        : INT10H09H ( page attrib char count --- )                          >R 0900 OR >R SWAP 8 <-L OR 0 SWAP R> R> ROT ROT                video-io DROP DROP DROP DROP ;                                                                                               -->                                                                                                                            ( Video services                                     02/07/91 )                                                                 : INT10H0AH ( page char count --- )                                 ROT 8 <-L ROT 0A00 OR >R >R >R 0 R> R> R>                       video-io DROP DROP DROP DROP ;                                                                                              : INT10H0BH ( bl bh --- )                                           8 <-L OR >R 0 0 R> 0B00                                         video-io DROP DROP DROP DROP ;                                                                                              : INT10H0EH ( color char --- )                                      0E00 OR >R >R 0 0 R> R>                                         video-io DROP DROP DROP DROP ;                               -->                                                                                                                                                                                            ( Video services                                     02/07/91 )                                                                 : INT10H0FH ( --- page width mode )                                 0 0 0 0F00 video-io                                             DUP FF AND >R 8 ->L FF AND >R 8 ->L >R DROP DROP R> R> R> ;                                                                 : SAVEPAGE ( pagenr addr --- )                                  2DROP ;                                                                                                                                                                                                                                                         BASE !                                                                                                                           ;S                                                                                                                                                                                             (                                                    02/07/91 ) : TEST                                                              INT10H0FH INT10H00H . DUP INT10H05H                             ( page ) DUP INT10H03H ( page col row end start )               INT10H01H INT10H02H                                             ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           (                                                    02/08/91 ) : FILL-SCR                                                         666 0 DO ." 012" LOOP ." 1" ;                                ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              