 Modula-DataBase: MAKETT ( Ain Isotamm, Tartu University )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ #1 Variables                                       01/15/90 ) VARIABLE JUURIK VARIABLE KUVAR VARIABLE AIT                     VARIABLE NihE VARIABLE TREPP 0 TREPP !                          VARIABLE PICT VARIABLE PIKKV@LI VARIABLE PikkuS                 VARIABLE PATS                                                   VARIABLE BaastyyP VARIABLE LopptyyP                             VARIABLE ScP    ( scopeparm ) VARIABLE ArrP   ( arrayparm )     VARIABLE #ATOMS ( aatomite arv )       0 #ATOMS !               VARIABLE #TABL  ( alamtab. arv )       0 #TABL  !               VARIABLE 0..0POINT   ( kirje nextviida sa )  -1 0..0POINT !     : GET-MKT ( --- >makett )                                       AIT @ 4 + @ ;                                                   : ?Array ( --- f )                                              AIT @ @ ?TYPE DUP ?T 12 =                                        IF ?ELTYPE ?T 6 <> ELSE DROP 0 THEN ;                          -->                                                             \ #2 Pict                                            12/22/89 ) : ARRAY+T  ( >type --- n )                                      DUP 12 + @ ( elem.type )                                        DUP ?L 11 = IF ?T 6 =                                                          IF 16 + @  ( indextype )                                           12 + @  ( # of elem. )                                       ELSE DROP 0  THEN                                             ELSE 2DROP 0  THEN ;                               : ENN ( >const --- #symb )                                      DUP ?T 6 = IF DROP 1                                                       ELSE 12 + @ 1000000000 10 0                                       DO 2DUP / 0 <> IF 2DROP 10 I - LEAVE                                           ELSE 10 /                                                       THEN                                             LOOP                                                          THEN ;            -->                                \ #3 Pict                                            12/22/89 ) : ENUM+T ( >type --- n )                                        DUP 0 PICT ! 16 + @ SWAP 12 + @ 0                               DO DUP 4 - BODY> >NAME C@ 31 AND DUP PICT @ >                      IF PICT ! ELSE DROP THEN                                        16 + @                                                       LOOP DROP PICT @ ;                                                                                                              : SUBRAN+T ( >type --- n )                                      DUP 16 + @ ( basetype )                                             ?L 11 = IF 24 + @ ENN                                                   ELSE DUP ?T 10 = IF SWAP DROP ENUM+T THEN                       THEN ;                                              -->                                                                                                                                                                                             \ #4 Pict                                            12/22/89 ) : USER+T ( >type --- n )                                        DUP ?T CASE 8 OF DROP  0              ENDOF                                 9 OF 12 + @ MYSELF        ENDOF                                10 OF ENUM+T               ENDOF                                11 OF SUBRAN+T             ENDOF                                12 OF ARRAY+T              ENDOF                                15 OF 12 + @ MYSELF        ENDOF                            ENDCASE ;                                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #5 Pict                                            12/22/89 ) : SUBRC+T ( >type --- n )                                       DUP 24 + @ 10 =                                                   IF 8 + @ ENUM+T                                                 ELSE 20 + @ ENN                                                 THEN ;                                                        : STAND+T ( >type --- n )                                        ?T CASE 1 OF 10   ENDOF                                                 2 OF 10   ENDOF                                                 3 OF 10   ENDOF                                                 6 OF 1    ENDOF                                                 7 OF 256  ENDOF                                                 8 OF 0    ENDOF                                            ENDCASE ;                                                   -->                                                                                                                             \ #6 Get T of standardtype                           12/13/89 ) : SUBR+T ( >type --- n )                                        DUP 8 + @ ( basetype )                                              ?L 11 = IF 24 + @ ENN                                                   ELSE DUP ?T 10 = IF SWAP DROP ENUM+T THEN                       THEN ;                                              : CONT+T ( >consttype --- n )                                   DUP ?T CASE 6 OF DROP 1               ENDOF                                 7 OF 12 + @ C@            ENDOF                                 9 OF 8 + @ DUP @L 11 = IF STAND+T ELSE USER+T THEN                                        ENDOF                                10 OF 8 + @ ENUM+T         ENDOF                                11 OF 8 + @ SUBRC+T        ENDOF                                15 OF 12 + @ MYSELF        ENDOF                            ENDCASE ;                                                -->                                                             \ #7 Pict                                            12/22/89 ) : #SYMB? ( >type --- n )                                        DUP ?L CASE 5 OF CONT+T  ENDOF                                              8 OF USER+T  ENDOF                                              9 OF USER+T  ENDOF                                             11 OF STAND+T ENDOF                                         ENDCASE ;                                                : C-POINTS ( --- )                                              KUVAR @ 0 <>                                                         IF AIT @ KUVAR @ 12 + !   ( 12-next )                           ELSE AIT @ JUURIK !                                             THEN AIT @ KUVAR ! ;                                       -->                                                                                                                                                                                                                                                             \ #8 Get T of standardtype                           12/13/89 ) : ENM+T ENUM+T 1 > IF 7 ELSE 6 THEN ;                           : KAS+T ( >usertype --- >standtype T )                          DUP ?T CASE 8 OF 4 POINTER DUP ?T ENDOF                                     9 OF 4 POINTER DUP ?T ENDOF                                    10 OF DUP ENM+T        ENDOF                                    11 OF 8 POINTER DUP ?T ENDOF                                    12 OF 4 POINTER DUP ?T ENDOF                                ENDCASE ;                                                : ??TYPE ( >type --- >standtype T )                             DUP ?L CASE 8 OF KAS+T     ENDOF                                            9 OF KAS+T     ENDOF                                           11 OF DUP ?T    ENDOF                                       ENDCASE ;                                                -->                                                                                                                             \ #9 Make scope                                      02/10/90 ) : R-V-ARV                                                       ScP @ DUP @ SWAP 12 + @ * 60 <=             ( kogupikkus )        IF 1 ScP @ 4  + !                         ( 1 rida )               ScP @ DUP 12 + @ SWAP 8  + !           ( el-arv veergu )     ELSE 60 ScP @ @ / DUP ScP @ 8 + !         ( # veerud )               ScP @ 12 + @ SWAP /MOD SWAP 0 <>                                      IF 1 + THEN ScP @ 4  + !       ( # read )            THEN ;                                                        : MAKE-WPB ( --- )                                              74 ScP @ DUP 8  + @ SWAP @ * - 8            ( xul, yul )        256 * + ScP @ 20 + !                                            74 ScP @ 4  + @ 8 +                         ( xlr, ylr )        256 * + ScP @ 16 + !                                            4 Farbe ScP @ 24 + ! ;                                          -->                                                             \ #10 Make scope, Make chain                         02/10/90 ) : MAKESCOPE ( --- )                                             36 DECL ScP !                                                   BaastyyP @ #SYMB? 1+ ScP @ !          ( elemendi pikkus +1 )    BaastyyP @ 12 + @ ScP @ 12 + !        ( elementide arv )        R-V-ARV MAKE-WPB                                                BaastyyP @ 16 + @ ScP @ 28 + ! ;      ( 1. elemendi pass )      : MAKE-CHAIN ( >makett >field --- )                             DUP >R HERE AIT ! , , KUVAR @ , 0 , BaastyyP @ , LopptyyP @ ,   R> DUP 0 > IF 4 + @ NihE @ + , ELSE , THEN 0 , 0 , 0 , 0 ,      AIT @ @ 0 <> IF BaastyyP @ ?T 10 =                                              IF MAKESCOPE ScP @ AIT @ 36 + !                                 ELSE ?Array IF 1 #TABL +! THEN                                  THEN                                                         THEN C-POINTS ;                                    -->                                                             \ #11 Make chain                                     12/13/89 ) : DUMMY-CHAIN ( --- tf )                                        HERE >R 0 , GET-MKT 4 + @ , 1 ,                                 PikkuS @ PATS @ >                                                IF GET-MKT 4 + @ PATS @ + 1- ,                                     PATS @ , PIKKV@LI @ , 0 , R> 0 MAKE-CHAIN -1                 ELSE GET-MKT 4 + @ PikkuS @ + 1- ,                                   PikkuS @ , PIKKV@LI @ , PATS @ ,                                R> 0 MAKE-CHAIN PikkuS @ PIKKV@LI +! PikkuS @ PATS -! 0    THEN ;                                                         -->                                                                                                                                                                                                                                                                                                                                                                                             \ #12 Make display                                   12/13/89 ) : LONGLINE ( --- )                                              GET-MKT 8 + @ 1 >                                                 IF GET-MKT DUP DUP 16 + @ PATS ! 4 + @                             75 SWAP - DUP PikkuS ! SWAP 16 + !                              GET-MKT 20 + @ PikkuS @ + PIKKV@LI !    ( ffl )                 74 GET-MKT 12 + !    ( limes )                                  PATS @ GET-MKT 24 + !                                           PATS @ PikkuS @ - PATS !                                            BEGIN DUMMY-CHAIN                                               UNTIL                                                    ELSE GET-MKT DUP 16 + @ SWAP 24 + !                             THEN ;                                                        -->                                                                                                                                                                                             \ #13 Make display                                   12/13/89 ) : R-MAKETT ( >field --- >field )                                DUP HERE SWAP                                                   12 ALLOT OVER 12 ERASE                                          OVER TREPP @ SWAP ! OVER 8 + 1 SWAP !  ( nihe => 0, #r:=1 )     1 #ATOMS +!                                                     MAKE-CHAIN ;                                                    -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #14 Make display                                   12/13/89 ) : MAKETT ( >field --- >field )                                  DUP HERE  DUP >R SWAP    1 #ATOMS +!                            DUP ?TYPE DUP BaastyyP ! DUP ??TYPE LopptyyP ! DROP             #SYMB? DUP 30 + DUP ALLOT 3 PICK SWAP ERASE                     2 PICK DUP TREPP @ SWAP !   ( nihe => 0 )                       2DUP 16 + !                 ( l.value => 16 )                   2 PICK 4 - BODY> >NAME C@ 31 AND TREPP @ + 3 + DUP              2 PICK 4 + !                ( nihe.value => 4 )                 ROT + 2DUP 1- SWAP 12 + !   ( limes => 12 )                     DUP 75 <=                                                         IF DROP 8 + 1 SWAP !      ( # read := 1 => 8 )                  ELSE 75 /MOD SWAP  0 <> IF 1 + THEN                                  SWAP 8 + !           ( # read      => 8 )                  THEN MAKE-CHAIN R> DUP 28 + SWAP 20 + ! LONGLINE ;            -->                                                             \ #15 Make display                                   12/13/89 ) : MakeDISPLAY ( >D-type --- >D-type )                           DUP DUP 24 + @ SWAP 12 + @   ( first field, # of fields )       0 DO DUP ?T CASE                                                     1 OF MAKETT                                          ENDOF      2 OF DUP MAKETT 3 TREPP +! 28 + @                                       BEGIN DUP 12 + @ DUP 0 <> IF MYSELF THEN DROP                         16 + @ DUP 0=                                                     IF DROP -1 ELSE 0 THEN                                  UNTIL 3 TREPP -!                             ENDOF      3 OF NihE @ >R DUP 4 + @ NihE +! R-MAKETT DUP 8 + @ 12 + @           3 TREPP +! MYSELF 3 TREPP -! DROP R> NihE !     ENDOF             ENDCASE                                                16 + @ DUP 0 = IF LEAVE THEN ( next )                          LOOP DROP ;                                                   -->                                                             \ #16 Make display                                   12/13/89 ) : PLATE_POINTS                                                  JUURIK @ BEGIN AIT !                                                       AIT @ DUP 8 + @ SWAP 28 + !                                     AIT @ DUP 12 + @ DUP >R SWAP 32 + !                             R> DUP 0=                                                     UNTIL DROP ;                                           -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #17 Line-record                                    09/30/90 ) VARIABLE LIBARAJAD                                              VARIABLE LIBAFIELD                                              : MAKELIBA ( --- )                                              0 I/C BENUM 0 I/C BENUM CRROOT RANGE-TAB LIBARAJAD !            45 DECL LIBAFIELD !                                             132 LIBAFIELD @ C!      ( 84h )                                 ASCII F LIBAFIELD @ 1 + C!  ASCII I LIBAFIELD @ 2 + C!          ASCII L LIBAFIELD @ 3 + C!  ASCII E LIBAFIELD @ 4 + C!                                              LIBAFIELD @ 4 + 128 TOGGLE  3 LIBAFIELD @ 17 + C! 1 LIBAFIELD @ 18 + C!                     4 LIBAFIELD @ 20 + C! ;                                         : LIBA ( --- >arraytype )                                       MAKELIBA LIBARAJAD @ KIRJETYYP @ ARRAY-TAB ;                    -->                                                                                                                             \ #18 Line-record                                    09/30/90 ) : MYSELF? ( >pass --- >pass f )                                 DUP ?TYPE DUP ?T 8 =                                                IF 12 + @ DUP 0=                                                   IF DROP 0                                                       ELSE 12 + @ OVER 20 + @ =                                       THEN                                                         ELSE DROP 0                                                     THEN ;                                                      : JUDGE ( >D-type --- >D-type )                                 -1 0..0POINT ! DUP DUP 24 + @ SWAP 12 + @                       0 DO MYSELF? IF DUP 4 + @ 0..0POINT !                                        THEN 16 + @ DUP 0= IF LEAVE THEN                     LOOP DROP ;                                                   -->                                                                                                                             \ #19 Line-record                                    09/30/90 ) -->                                                             : MAKEDISPLAY ( >D-type --- >D-type )                             DUP 0 =                                                        IF DROP MASTER_RECORD 60 + DUP DUP C@ 4 - SWAP C! FIND             MASTER_RECORD 60 + DUP C@ 4 + SWAP C!                           0 = IF ABORT ELSE  EXECUTE MOD-iD THEN                          MASTER-R @ 8 + FIND 0 =                                         IF ABORT                                                        ELSE >BODY 16 + @ DUP KIRJETYYP ! RES-cONTEXT                   THEN                                                         THEN                                                           JUDGE 0..0POINT @ -1 <>                                            IF LIBA LIBAFIELD @ 25 + ! LIBAFIELD @ 17 + MAKETT 0 #ATOMS !   ELSE MakeDISPLAY                                                THEN ;                                                       \ #20 Formats                                        12/13/89 ) -->                                                             Iga ekraanirea jaoks on 1 ahelalyli j@rgmise formaadiga:        0) >pass | 0 - kui rida on mitmerealise v@@rtuse j-s rida (j>0) 4) >makett; 8) >prior; 12) >next; 16) >baastyyp; 20) T;         24) sa kirjes; 28) alt-prior; 32) alt-next; 36)>ScP; 40)>ArrP    Kui aatomil on v@@rtusvaru, siis ScP=                          0) elem. pikkus+1; 4) #read; 8) #veerud; 12) #elemendid;        16..27 window-parm; 28) 1. elemendi pass; 32) jooksev pass.     MAKETT:                                                         0) "trepp"; 4) v@@rtusv@lja alguse SA (kursor-1); 8) ridade arv 12) v@@rtusv@lja lo~pu SA (kursor-N); 16) rea pikkus;           20) >text-value; 24) v@@rtusv@lja pikkus (self..end);           P@risrea puhul v@@rtusv@li algab MAKETT+28, jatkurea >text-     -value viitab p@risrea v@@rtusv@lja sisse.                        Alamkirje juure maketis on ainult 3 esimest v@lja.            \ #21 Variables                                      06/03/90 ) : MAKEDISPLAY ( >D-type --- >D-type )                           JUDGE 0..0POINT @ -1 <>                                            IF LIBA LIBAFIELD @ 25 + ! LIBAFIELD @ 17 + MAKETT 0 #ATOMS !   ELSE MakeDISPLAY                                                THEN ;                                                                                                                       VARIABLE RIDA          VARIABLE IndeX     VARIABLE dFLAG        VARIABLE KUULUTUS  ( 0-pole, 1-v@ljas )   VARIABLE ElTyyp       VARIABLE ESIMENE       VARIABLE VIIMANE   VARIABLE tABEL        VARIABLE YLARIDA       VARIABLE ALARIDA   VARIABLE SAHVER       VARIABLE KURSV         VARIABLE inSert                          VARIABLE Reevers                                                VARIABLE Kurss         VARIABLE Ridda     VARIABLE Aits         -->                                                                                                                             \ #22 File & print support                           06/03/90 ) VARIABLE RiX  0 RiX !                                           ( VARIABLE Avatud )                                             ( HANDLE DBFILE )                                               (  HANDLE DBIX  )                                               0 KEY_LENGTH !                                                  DIRECTORY DB-PATH DB-PATH 40 ERASE                              ( VARIABLE K-NIHE )  ( Kirje nihe failis )                      ( VARIABLE REC-NR )  ( Kirje index failis )                     VARIABLE R_J@RG   ( Freeprint )                                 VARIABLE N_J@@K   ( Freeprint )                                 VARIABLE MEMM$    ( Free memory address )                       VARIABLE STOREHOUSE   100 DECL STOREHOUSE !                     ( VARIABLE KEYDEPOT ) ( V“tmestruktuuri juur )                  VARIABLE KEYKIRJE ( "V“tmekirje" )                              -->                                                             \ #23 Storehouse                                     10/12/90 ) : >ST ( n i --- )                                               STOREHOUSE @ + ! ;                                              : ST> ( i --- n )                                               STOREHOUSE @ + @ ;                                              : >STOREHOUSE ( --- )                                           JUURIK @ 0 >ST    KUVAR @ 4 >ST   AIT @ 8 >ST  RIDA @ 12 >ST    IndeX @ 16 >ST dFLAG @ 20 >ST KUULUTUS @ 24 >ST ElTyyp @ 28 >ST ESIMENE @ 32 >ST VIIMANE @ 36 >ST tABEL @ 40 >ST                YLARIDA @ 44 >ST ALARIDA @ 48 >ST SAHVER @ 52 >ST               KURSV @ 56 >ST inSert @ 60 >ST Reevers @ 64 >ST                 KIRJE @ 68 >ST ORIGINAAL @ 72 >ST Kurss @ 76 >ST                Ridda @ 80 >ST Aits @ 84 >ST ReWri @ 88 >ST 1 ReWri !           #ATOMS @ 92 >ST 0..0POINT @ 96 >ST                              KonkA @ DUP 1+ KIRJE ! KEY_LENGTH @ 1 - SWAP C! ;               -->                                                             \ #24 Storehouse                                     10/12/90 ) : STOREHOUSE> ( --- )                                           0 ST> JUURIK ! 4 ST> KUVAR ! 8 ST> AIT ! 12 ST> RIDA !          16 ST> IndeX ! 20 ST> dFLAG ! 24 ST> KUULUTUS ! 28 ST> ElTyyp ! 32 ST> ESIMENE ! 36 ST> VIIMANE ! 40 ST> tABEL !                44 ST> YLARIDA ! 48 ST> ALARIDA ! 52 ST> SAHVER !               56 ST> KURSV ! 60 ST> inSert ! 64 ST> Reevers !                 68 ST> KIRJE ! 72 ST> ORIGINAAL ! 76 ST> Kurss !                80 ST> Ridda ! 84 ST> Aits ! 88 ST> ReWri !                     92 ST> #ATOMS ! 96 ST> 0..0POINT ! ;                            ;S                                                                                                                                                                                                                                                                                                                                                                                              