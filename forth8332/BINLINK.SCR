( Bin-files for Forth-83/32                          05/07/90 ) 1 LOAD                                                          ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( Binary overlay                                     01/28/91 ) FORTH DEFINITIONS                                                                                                                                                                                                                                               ' LIT              CONSTANT  LIT.CFA    ( runtime words )       ' RLIT             CONSTANT  RLIT.CFA   ( runtime words )       ' GLIT             CONSTANT  GLIT.CFA   ( runtime words )       ' PLIT             CONSTANT  PLIT.CFA   ( runtime words )       ' rLIT             CONSTANT  rLIT.CFA   ( runtime words )       ' gLIT             CONSTANT  gLIT.CFA   ( runtime words )       ' pLIT             CONSTANT  pLIT.CFA   ( runtime words )        -->                                                                                                                                                                                                                                                            ( Binary overlay, continued                          11/14/83 ) ' DECIMAL        @ CONSTANT  COL.CFA    ( CFA of 'docol' )      ' ;S               CONSTANT  SEMI.CFA   ( ;S or EXIT mark)      ' (.")             CONSTANT  DOTQ.CFA   ( various string )      ' (ASCIIZ")        CONSTANT  ASCQ.CFA   ( various string )      ' (LIT")           CONSTANT  LITQ.CFA   ( runtime words)        ' (ABORT")         CONSTANT  ABORTQ.CFA                         ' BRANCH           CONSTANT  BRANCH.CFA ( runtime BRANCH )      ' ?BRANCH          CONSTANT  ?BRANCH.CFA ( runtime BRANCH if 0) ' (LOOP)           CONSTANT  LOOP.CFA                           ' (+LOOP)          CONSTANT  +LOOP.CFA                          HEX  A081  DECIMAL CONSTANT  END.VOC                            ' FORTH @          CONSTANT  DOES.CFA                           ' FORTH >BODY @    CONSTANT  VOC.PFA                             -->                                                                                                                            ( Binary overlay, continued                          11/14/83 )                                                                 DECIMAL                                                                                                                         -->                                                                                                                                                                                                                                                                                                                                                                                             VARIABLE  OFFSET     ( between read & comp )                    VARIABLE  FIRST.NFA  ( first NFA in module )                    DECIMAL                                                          -->                                                                                                                                                                                            ( Binary overlay, continued                          11/13/83 )                                                                  -->                                                                                                                            : glit-cont ( ad --- ad )                                           DUP @ DROP ;                                                                                                                : plit-cont ( ad --- ad )                                           DUP @ DROP ;                                                                                                                 -->                                                                                                                                                                                                                                                                                                                                                                                            ( Binary overlay, continued                          11/13/83 )                                                                 VARIABLE R-BIN-BASE-AD                                                                                                           -->                                                                                                                            : IN-DICT? ( nfa --- flag )                                         R-BIN-BASE-AD @ U< NOT ;                                                                                                    : IN-SETTAB? ( nfa --- flag )                                       DUP SETTABLE-BUFFER U< NOT SWAP SB-END U< AND ;                                                                             : IN-ASM? ( nfa --- flag )                                          DUP ASTART U< NOT SWAP ADP @ U< AND ;                        -->                                                                                                                            ( Binary overlay, continued                          11/13/83 )                                                                 : ALL? ( nfa --- flag ; all is re-linked? )                         DUP IN-DICT?                                                    IF DROP 0                                                       ELSE DUP IN-SETTAB?                                                 IF DROP 0                                                       ELSE IN-ASM? NOT                                                THEN                                                        THEN ;                                                                                                                       -->                                                                                                                            : W->R ( writead --- readad )                                       DUP FIRST.NFA @ U< NOT IF OFFSET @ + THEN ;                  -->                                                            ( Binary overlay, continued                          11/14/83 ) DECIMAL                                                         : OF@ ( ad --- offsetcontent )                                      @ W->R ;                                                    : offset-cont ( ad --- ad )                                         DUP OF@ OVER ! ;                                             -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( Binary overlay, continued                          11/14/83 ) ( relocate the contents of colon def's parameter field )        : COL.DEF DUP   ( lfa  ---  lfa )                                 BEGIN  4 +   DUP @ SEMI.CFA = NOT                               WHILE  DUP @ CASE             ( offset the word if needed)          DOTQ.CFA OF 4 + DUP C@ + 3 - ENDOF ( skip text strings )        ABORTQ.CFA OF 4 + DUP C@ + 3 - ENDOF                            ASCQ.CFA OF 4 + DUP C@ + 3 - ENDOF                              LITQ.CFA OF 4 + DUP C@ + 3 - ENDOF                              RLIT.CFA  OF 4 + offset-cont ENDOF ( literal addrconst )        GLIT.CFA OF 4 + glit-cont ENDOF                                 PLIT.CFA OF 4 + plit-cont ENDOF                                 rLIT.CFA  OF 8 + offset-cont ENDOF ( literal addrconst )        gLIT.CFA OF 8 + glit-cont ENDOF                                 pLIT.CFA OF 8 + plit-cont ENDOF                            -->                                                            ( Binary overlay, continued                          11/13/83 )                                                                       LIT.CFA  OF 4 + ENDOF      ( skip literal constants)            BRANCH.CFA OF 4 + ENDOF    ( skip offsets of branches)          ?BRANCH.CFA OF 4 + ENDOF   ( since they are relative )          LOOP.CFA OF 4 + ENDOF      ( ditto with loop offsets)           +LOOP.CFA OF 4 + ENDOF                                          ( OTHERWISE: CFA doesn't match any special words)               DROP                      ( is def in new module? )             offset-cont               ( if so, offset it )                DUP ENDCASE                 ( endcase consumes one item )     REPEAT DROP ;                 ( drop address of 'semis' )      -->                                                                                                                                                                                                                                                            ( Binary overlay, continued                          11/13/83 )                                                                 : re-link ( first-LFA --- )                                         DECIMAL ; ( deferred word, becomes RE-LINK later )          : DOES.DEF ( lfa --- lfa )                                          DUP LINK> >BODY offset-cont DROP ;                          : VOC.DEF ( lfa --- lfa voclfa )                                    DUP LINK> >BODY 4 + 2 + offset-cont                          (  DUP 4 + offset-cont DROP )                                      @ NAME> >LINK ;                                             : REL-VAR ( >table --- )                                            INFO + DUP offset-cont DROP                                     4 + DUP offset-cont @ 0=                                        IF DUP INFO - DUP @ GLIT.W->R SWAP ! THEN                       12 + offset-cont DROP ;                                      -->                                                            ( Binary overlay, continued                          11/13/83 )                                                                 : REL-RECTYPE ( >table --- ; L=8,9 T=13 )                           INFO +                                                          8 + DUP offset-cont DROP                                        4 + DUP offset-cont DROP                                        4 + DUP offset-cont DROP                                        4 + DUP offset-cont DROP                                        4 + 2 + DUP 4 + offset-cont DROP                                offset-cont @ DUP                                               IF NAME> >LINK re-link                                          ELSE DROP                                                       THEN ;                                                                                                                       -->                                                                                                                            ( Binary overlay, continued                          11/14/83 )                                                                 : REL-ALTTAB ( >table --- ; L=9, T=0 )                              INFO + DUP offset-cont DROP                                     4 + DUP offset-cont DROP                                        4 + DUP offset-cont DROP                                        4 + offset-cont DROP ;                                                                                                      : REL-SIMPFIELD ( >table --- )                                      INFO + DUP offset-cont DROP                                     4 + DUP offset-cont DROP                                        4 + DUP offset-cont DROP                                        4 + offset-cont DROP ;                                                                                                       -->                                                                                                                            (                                                    05/08/90 )                                                                 : REL-CASEROOT ( >table --- )                                       DUP REL-SIMPFIELD                                               INFO + 20 + DUP offset-cont DROP                                4 + offset-cont DROP ;                                                                                                      : REL-RECFIELD ( >table --- ; L=3,4 )                               DUP ?T CASE                                                         1 OF REL-SIMPFIELD ENDOF                                        2 OF REL-CASEROOT  ENDOF                                        3 OF REL-SIMPFIELD ENDOF                                    DROP ENDCASE ;                                                                                                               -->                                                                                                                            (                                                    05/08/90 ) : REL-CONST ( >table --- )                                          DUP INFO + offset-cont DROP                                     DUP ?T CASE                                                         11 OF INFO + 8 + DUP offset-cont DROP                              4 + offset-cont DROP ENDOF                                   15 OF INFO + 4 + offset-cont DROP ENDOF                     DROP ENDCASE ;                                                                                                              : REL-ENUID ( >table --- )                                          INFO + DUP offset-cont DROP                                     8 + offset-cont DROP ;                                                                                                      : REL-UTYPE ( >table --- )                                          DUP ?T CASE                                                     0 OF DUP ?L 9 = IF REL-ALTTAB ELSE DROP THEN ENDOF -->      (                                                    05/08/90 )     7 OF INFO + 4 + DUP offset-cont DROP                                        4 + offset-cont DROP ENDOF                          8 OF INFO + 4 + offset-cont DROP ENDOF                          9 OF INFO + 4 + offset-cont DROP ENDOF                         10 OF INFO + 8 + offset-cont DROP ENDOF                         11 OF INFO + 8 + DUP offset-cont DROP 4 + DUP                            offset-cont DROP 4 + offset-cont DROP ENDOF            12 OF INFO + 4 + DUP offset-cont DROP                                        4 + offset-cont DROP ENDOF                         13 OF REL-RECTYPE ENDOF                                         14 OF INFO + 8 + DUP offset-cont DROP 4 +                           32 0 DO 4 + DUP offset-cont DROP LOOP DROP ENDOF            15 OF INFO + 4 + offset-cont DROP ENDOF                         DROP ENDCASE ;                                                -->                                                            (                                                    05/08/90 ) : REL-TYPE ( >table --- )                                           DUP ?L CASE                                                      8 OF REL-UTYPE ENDOF                                            9 OF REL-UTYPE ENDOF                                           10 OF INFO + 4 + offset-cont DROP ENDOF                         11 OF DROP ENDOF                                                DROP ENDCASE ;                                              : REL-STANDPROC ( >table --- ) DROP ;                           : REL-PROCED ( >table --- )                                         DUP 4 + offset-cont @ plit-cont 4 + offset-cont DROP            DUP INFO + offset-cont DROP                                     DUP INFO + 4 + plit-cont DROP                                   DUP INFO + 8 + offset-cont @ >LINK VOC.DEF                      DUP 1 - C@ 160 = 0= IF re-link ELSE DROP THEN DROP              DROP ; -->                                                  ( Binary overlay, continued                          11/13/83 )                                                                 : BACK-LFA ( >modtab --- lfa ; lf points back to module )           DUP 4 - BODY> >NAME SWAP INFO + 14 + ( nfa lfa )                BEGIN OVER OVER OF@ = NOT                                       WHILE OF@ N>LINK                                                REPEAT SWAP DROP ;                                                                                                          : REL-MODULE ( >table --- )                                         DUP 4 + offset-cont DROP                                        DUP INFO + 4 + DUP @ IF plit-cont THEN DROP                   ( DUP INFO + 8 + offset-cont DROP )                               DUP BACK-LFA DUP OF@ SWAP 0 OVER ! >R >R                        DUP INFO + 14 + offset-cont @ NAME> >LINK re-link               R> R> ! DROP ;                                               -->                                                            ( Binary overlay, continued                          11/13/83 )                                                                 : RE-TABLE ( >table --- )                                           DUP ?L CASE                                                     1 OF REL-VAR ENDOF           2 OF REL-VAR ENDOF                 3 OF REL-RECFIELD ENDOF      4 OF REL-RECFIELD ENDOF            5 OF REL-CONST ENDOF         6 OF REL-CONST ENDOF               7 OF REL-ENUID ENDOF                                            8 OF REL-TYPE ENDOF          9 OF REL-TYPE ENDOF                10 OF REL-TYPE ENDOF         11 OF REL-TYPE ENDOF               12 OF DROP ENDOF                                                13 OF REL-STANDPROC ENDOF                                       14 OF REL-PROCED ENDOF                                          15 OF REL-MODULE ENDOF                                          DROP ENDCASE ;                                               -->                                                            (                                                    05/08/90 ) : SPC.DEF ( lfa --- lfa )                                           DUP LINK> >BODY 4 + offset-cont DROP ;                      : TABLE.DEF ( lfa --- lfa )                                         DUP LINK> >TAB  RE-TABLE ;                                  : spc? ( cfa --- flag )                                             >BODY @ ENVIRONMENT ['] ### >BODY @ = FORTH ;               : TAB.DEF ( lfa --- lfa )                                           DUP LINK> spc? IF SPC.DEF ELSE TABLE.DEF THEN ;              -->                                                            : GETADDR       ( addr  ---  size  voc-link  last-LFA )           DUP @ SWAP                   ( size of module in bytes )        4 + DUP @ HERE + SWAP        ( new LFA of last word )           4 + DUP @ DUP FIRST.NFA !    ( first NFA before relocation )    HERE SWAP - OFFSET !         ( calculate offset at new addr )   4 + @ SWAP ;                 ( last vocabulary in module )    ( Binary overlay, continued                          11/13/83 )                                                                 : RE-LINK       ( first-LFA --- )                                 DUP 0= IF DROP EXIT THEN                                        BEGIN                                                             offset-cont                 ( patch the LFA )                   DUP LINK> @ CASE            ( get CFA of definition )             COL.CFA OF  COL.DEF ENDOF ( process colon definition )          DOES.CFA OF                                                        DUP LINK> >BODY @ VOC.PFA =                                     IF  VOC.DEF MYSELF                                              ELSE DUP LINK> OBJ? IF TAB.DEF ELSE DOES.DEF THEN               THEN                                                         ENDOF                                                      -->                                                                                                                            ( Binary overlay, continued                          11/13/83 )       ( OTHERWISE it's a Constant Variable etc )                    ENDCASE                                                         DUP @ DUP ALL?   ( until next NFA < HERE )                      SWAP @                                                          [ HEX ] FFFF [ DECIMAL ] AND                                    END.VOC = OR NOT                                              WHILE  @ N>LINK               ( follow linked list to next)     REPEAT                                                          DUP @ @ [ HEX ] FFFF [ DECIMAL ] AND END.VOC =                  IF DROP ELSE LATEST SWAP ! THEN ;                                                             ( link dictionary of overlay)                                   ( to previous last def )        ' RE-LINK ' re-link >BODY ! ( defer )                            -->                                                                                                                            ( Binary overlay, continued                          11/14/83 ) -->                                                             : BGET        (  --- ; filename previously placed by caller)      BINFILE OPEN-FILE IF BINFILE .HCB ABORT THEN                    ." Reading..."                                                  BINFILE HERE READFILE         ( read entire file at DP )        HERE R-BIN-BASE-AD !                                            GETADDR                       ( get the addresses from file )   ." Relocating..."                                               DUP RE-LINK                   ( relocate all definitions )      LINK> >NAME CURRENT @ !       ( update the addr in LATEST )     DUP 0 >                                                            IF HERE + VOC-LINK ! ELSE DROP THEN                          ALLOT                         ( extend the DP for new defs )    BINFILE CLOSE-FILE IF BINFILE .HCB ABORT THEN ;               -->                                                             ( #23 forget                                         05/08/90 ) FORTH DEFINITIONS                                               : forget ( nfa --- )                                                DUP HERE U<                                                     IF  CURRENT @ CONTEXT @ <> 24 ?ERROR                                >R VOC-LINK @                                                   BEGIN R@ OVER U<                                                WHILE @ DUP VOC-LINK !                                          REPEAT                                                          BEGIN DUP 6 -                                                         BEGIN N>LINK @ DUP R@ U<                                        UNTIL OVER 4 - ! @ ?DUP 0=                                UNTIL R> DP !                                               ELSE DROP THEN ;                                             -->                                                                                                                            ( # 24  FINDLFA                                      05/07/90 ) ( HIDDEN DEFINITIONS )                                          : FINDLFA ( nfa --- lfa ; start from CURRENT )                      CURRENT @                                                       BEGIN                                                              OVER OVER @ = 0=                                             WHILE                                                              @ DUP 0= IF ABORT THEN N>LINK                                REPEAT                                                          SWAP DROP                                                       DUP CURRENT @ = IF ABORT THEN ;                                                                                             FORTH DEFINITIONS                                               -->                                                                                                                                                                                             \ #25                                                05/08/90 )                                                                 BASE @ HEX                                                                                                                      : MAKE0CC  ( --- )                                                 HERE 82 C, ASCII C DUP C, 80 OR C,                              LATEST , CURRENT @ ! SMUDGE                                     COLDEF.CFCONT ,                                                 ['] RM.INIT ,                                                   ( HIDDEN ) SEMI.CFA ( FORTH ) , UNSMUDGE                        CCAD FIND IF EXT-CHAIN ADD-TO-CHAIN ELSE DROP THEN ;                                                                         BASE !                                                                                                                           -->                                                                                                                            \ #26                                                05/08/90 )                                                                 BASE @ HEX                                                                                                                      : MAKE1CC  ( cfa --- )                                             HERE 82 C, ASCII C DUP C, 80 OR C,                              LATEST , CURRENT @ ! SMUDGE                                     COLDEF.CFCONT ,                                                 ['] RM.INIT ,  ( cfa ) ,                                        ( HIDDEN ) SEMI.CFA ( FORTH ) , UNSMUDGE                        CCAD FIND IF EXT-CHAIN ADD-TO-CHAIN ELSE DROP THEN ;                                                                         BASE !                                                                                                                          -->                                                                                                                             \ #27                                                05/08/90 )                                                                 : DELEXTTAIL ( addr --- )                                           EXT-CHAIN DUP @                                                 BEGIN                                                               2 PICK OVER = 0=                                            WHILE SWAP DROP DUP @                                           REPEAT DROP 0 SWAP ! DROP ;                                                                                                 : MAKEDUMMYDEF ( --- ; countedname HERE )                           HERE C@ 1+ HERE C!                                              ASCII @ HERE DUP C@ + C!                                        build                                                           COLDEF.CFCONT HERE 8 - !                                        SEMI.CFA HERE 4 - ! ;                                        -->                                                            \ #28                                                05/08/90 )                                                                 : WRITEOUT? ( i --- flag )                                          DROP -1 ( tegemata !! )                                         ;                                                                                                                           : WRITE-SHORT-LOOP ( --- )                                          M.R.OUTTABLE M.R.#EL @ DUP                                      IF 1+ 1                                                             DO I DUP WRITEOUT? IF WRITE-SHORT ELSE DROP THEN                LOOP                                                        ELSE DROP CR ." Outtable empty!!" ( ABORT )                     THEN ;                                                                                                                       -->                                                                                                                            \ #29 ?MODULE$                                       05/08/90 )                                                                 : MMODULE$ ( --- ; MMODULE$ XXX ; initializations )                 CR ." Main " BL word 0 DEFMODULEAD !                            LIT" .MBJ" CSTR+ M.R.OUTTABLE M.R.DEFEL M.R.OUTBASES ;      : IMODULE$                                                          BL word FIND                                                    IF EXECUTE DEFMODULEAD !                                          HERE LIT" .IBJ" CSTR+ M.R.OUTTABLE M.R.DEFEL M.R.OUTBASES       MAKEDUMMYDEF                                                  ELSE CR ." No definition module " COUNT TYPE ABORT              THEN CR ." Implementation " ;                               : DMODULE$                                                          CR ." Definition " BL word 0 DEFMODULEAD !                      LIT" .DBJ" CSTR+ M.R.OUTTABLE M.R.DEFEL M.R.OUTBASES ;       -->                                                            \ #30                                                12/16/90 )                                                                 VARIABLE THBUF 252 ALLOT                                        VARIABLE SHBUF 252 ALLOT                                                                                                        : ?BJ-EXISTS? ( --- flag ; THBUF )                                  THBUF SHBUF OVER C@ 2 + CMOVE                                   SHBUF DUP C@ + DUP C@ SWAP ASCII J OVER C! 2 - C!               SHBUF 1+ 0 find                                                 IF -1                                                           ELSE DROP 0                                                     THEN ;                                                                                                                       -->                                                                                                                                                                                            \ #31                                                12/16/90 )                                                                 : NEW-ENOUGH? ( --- flag ; SHBUF, THBUF )                           SHBUF 1+ 0 find                                                 IF                                                                  SCRATCH_BUFF 22 + @ ( shorttime )                               THBUF 1+ 0 find                                                 IF                                                                  SCRATCH_BUFF 22 + @  ( shorttime objtime )                      U< NOT ( flag )                                             ELSE .STATUS DROP 0                                             THEN                                                        ELSE DROP 0                                                     THEN ;                                                       -->                                                                                                                            \ #32                                                12/16/90 )                                                                 VARIABLE STDNAME 20 ALLOT                                                                                                       : STDINIT ( --- )                                                   LIT" STAND.LIB" STDNAME 4 - 0 MOVE-FILENAME ;                                                                               : PAIN.RELDUMMY ( i --- )                                           DUP PAIN.PLACEAD @ W->R DUP INFO - 4 -  ( i place >table )      ROT PAIN.CONTAD @ W->R  ( place >table >table' )                OVER ?N IF 8 ELSE 9 THEN 15 3 PICK SET-L&T                      DUP ?TSIZE ROT 0 TAB! SWAP ! ;                                                                                               -->                                                                                                                                                                                            \ #33                                                12/16/90 )                                                                 : PAIN.RELPROC ( i --- )                                            CURRENT @ SWAP ( current i ) DUP PAIN.PLACEAD @ W->R            CURRENT ! PAIN.CONTAD @ W->R ( current cont )                   DUP N>LINK RE-LINK CURRENT @ ! CURRENT ! ;                  : PAIN.RELMODULE ( i --- )                                          CURRENT @ SWAP ( current i ) DUP PAIN.PLACEAD @ W->R            CURRENT ! PAIN.CONTAD @ W->R ( current cont )                   DUP N>LINK RE-LINK CURRENT @ ! CURRENT ! ;                  : PAIN.RELEXEC ( i --- )                                            DUP PAIN.CONTAD @ W->R SWAP PAIN.PLACEAD @ W->R ! ;         : PAIN.RELFLEN ( i --- )                                            DUP PAIN.CONTAD @ SWAP PAIN.PLACEAD @ W->R ! ;               -->                                                                                                                            \ #34                                                12/16/90 ) VARIABLE n-ad                                                   : LOAD-SHORT ( --- ; n-ad )                                         n-ad @ M.R.OUTTABLE M.R.SEARCHNAME IF EXIT THEN                 n-ad @ SCREEN-HANDLE MOVE-FILENAME                              SCREEN-HANDLE OPEN-FILE ?DISCERR                                n-ad @ M.R.OUTTABLE M.R.DEFEL DUP M.R.OUTBASES ( i )            CR ." Reading objectmodule: " SCREEN-HANDLE .FILENAME           M.R.INPTABLE M.R.TABLEN SCREEN-HANDLE CYKLREAD DROP             DUP M.R.OUTTABLE M.R.NAME M.R.INPTABLE M.R.SEARCHNAME           DUP 0= IF CR ." Link error! " SCREEN-HANDLE .FILENAME                 SCREEN-HANDLE CLOSE-FILE ?DISCERR DROP DROP EXIT THEN     ( i j ) DUP M.R.INPTABLE M.R.DICTLEN @ ( i j dictlen )          HERE OVER SCREEN-HANDLE CYKLREAD DROP ALLOT ( i j )             DUP M.R.INPTABLE M.R.SETLEN @ ( i j setlen )                 -->                                                            ( #35                                                12/16/90 )     SETTABLE-DP @ OVER SCREEN-HANDLE CYKLREAD DROP                  SETTABLE-DP +!  ( i j )                                         DUP M.R.INPTABLE M.R.ASMLEN @ ( i j asmlen )                    ADP @ OVER SCREEN-HANDLE CYKLREAD DROP                          ADP +!  ( i j )                                                 DUP M.R.INPTABLE M.R.FFLLEN @  ST-FFL +!  ( i j )               #PROC @ 4 * PASSTAB @ + OVER M.R.INPTABLE M.R.#PROCLEN @        ( i j base #proclen ) >R R@ 4 * SCREEN-HANDLE CYKLREAD DROP     R> ( i j #proclen ) #PROC +! ( i j )                            DUP M.R.INPTABLE M.R.#PAINAD @ #PAIN !                          ( i j ) PAIN.BUF #PAIN @ 12 * SCREEN-HANDLE CYKLREAD DROP       OVER M.R.OUTLENS ( i j ; LATESTAD wrong!! )                     DUP M.R.INPTABLE M.R.LATESTAD @ W->R 2 PICK M.R.OUTTABLE        M.R.LATESTAD ! ( i j )                                       -->                                                            ( #36                                                12/16/90 )                                                                     ( i j ) SCREEN-HANDLE CLOSE-FILE ?DISCERR                       ."      Relocating..."                                          OVER M.R.OUTTABLE M.R.LATESTAD @ NAME> >LINK DUP RE-LINK        LINK> >NAME CURRENT @ ! ( i j ) #PAIN @ DUP                     IF 0 DO I PAIN.TYPEAD @                                                  CASE 1 OF I PAIN.RELDUMMY   ENDOF                                    2 OF I PAIN.RELPROC    ENDOF                                    4 OF I PAIN.RELMODULE  ENDOF                                    5 OF I PAIN.RELEXEC    ENDOF                                    6 OF I PAIN.RELFLEN    ENDOF                               ENDCASE                                                     LOOP                                                       ELSE DROP                                                       THEN ( i j ) -->                                            ( #37                                                12/16/90 )                                                                     ( i j ) OVER M.R.OUTTABLE M.R.#PROCSTART @ #PROC @ OVER -       IF  ( i j start )                                                   #PROC @ 1+ SWAP                                                 DO ( i j )                                                          I 4 * PASSTAB @ + offset-cont DROP                          LOOP                                                        ELSE DROP                                                       THEN ( i j )                                                    ( i j )                                                         CCAD FIND IF EXT-CHAIN ADD-TO-CHAIN ELSE DROP THEN              ."    Ready"                                                    DROP DROP ;                                                                                                                  -->                                                            \ #38         THANDLE                                10/15/89 ) HANDLE THANDLE THANDLE FILENAME LOADINFO.TMP                    VARIABLE THIN                                                   VARIABLE STAND-LOADED                                           : LOADLOOPINIT ( --- )                                              0 STAND-LOADED !  RCFAERASE 0 #PROC !                           0 M.R.OUTTABLE M.R.#EL ! STDINIT                                MA-INIT MM-INIT B-INIT DHERE DUP BAAS ! MODBASE !               ERASE-BASETABLE SYS-FFL ST-FFL !                                0 MODFLAG ! 0 EXT-CHAIN !                                       0 PH-FLAG ! 0 DUMMYTYPEAD ! 0 DEFMODULEAD !  ASTART ADP !       WERASE SETTABLE-INIT ;    LOADLOOPINIT                                                                                      : LOAD-FTEXT ( --- ; counted name in THBUF )                        THBUF OBJNAME THBUF C@ 1+ CMOVE FLOAD ;                      -->                                                            \ #39                                                10/19/90 ) : CH-COMP-LOOP ( --- )                                              EXT-CHAIN @ DUP                                                 IF                                                                 BEGIN DUP 4 + @ DUP                                                 IF , ELSE DROP THEN  @ DUP 0=                               UNTIL  DROP                                                  ELSE DROP                                                       THEN ;                                                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ #40                                                10/19/90 )                                                                 : OUTTABLE-EMPTY? ( --- flag )                                      M.R.OUTTABLE M.R.#EL @ 0= ;                                                                                                 : STD-EXISTS? ( --- flag )                                          STDNAME 1+ 0 find                                               IF -1                                                           ELSE DROP 0                                                     THEN ;                                                                                                                       -->                                                                                                                                                                                                                                                                                                                            \ #41                                                10/15/89 )                                                                 : IS-STANDARD-MODULE? ( countedstrad --- flag ; file.OB? )          DUP LIT" ASCII.OBD" CS= IF DROP -1 EXIT THEN                    DUP LIT" ASCII.OBI" CS= IF DROP -1 EXIT THEN                    DUP LIT" STR.OBD" CS= IF DROP -1 EXIT THEN                      DUP LIT" STR.OBI" CS= IF DROP -1 EXIT THEN                      DUP LIT" TERMINAL.OBD" CS= IF DROP -1 EXIT THEN                 DUP LIT" TERMINAL.OBI" CS= IF DROP -1 EXIT THEN                 DUP LIT" IO.OBD" CS= IF DROP -1 EXIT THEN                       DUP LIT" IO.OBI" CS= IF DROP -1 EXIT THEN                       DUP LIT" INOUT.OBD" CS= IF DROP -1 EXIT THEN                    DUP LIT" INOUT.OBI" CS= IF DROP -1 EXIT THEN                    DROP 0 ;                                                                                                                     -->                                                            \ #42                                                10/16/89 )  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ #43                                                10/16/89 )  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ #44                                                10/16/89 )                                                                 : LOAD-T-OR-O ( --- ; counted name in THBUF )                       ?BJ-EXISTS?                                                     IF NEW-ENOUGH?                                                      IF SHBUF n-ad ! LOAD-SHORT ELSE LOAD-FTEXT THEN             ELSE LOAD-FTEXT                                                 THEN ;                                                                                                                       -->                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ #45 LOADBIN                                        10/17/89 ) : LOADBIN ( countedstrad --- ; INIT_OBJ ok! )                       SCREEN-HANDLE MOVE-FILENAME                                     SCREEN-HANDLE OPEN-FILE ?DISCERR                                CR ." Loading file: " SCREEN-HANDLE .FILENAME                   MBOOT MBOOTLEN SCREEN-HANDLE CYKLREAD DROP                      [COMPILE] ENVIRONMENT DEFINITIONS                               BIN-BASE-AD @ DP ! LATEST-AD @ CURRENT @ !                      ASTART MCODELEN @ SCREEN-HANDLE CYKLREAD DROP                   HERE SCREEN-HANDLE ?FILESIZE MBOOTLEN MCODELEN @ + -            DUP ALLOT MBOOTLEN MCODELEN @ + SCREEN-HANDLE INITSA            SCREEN-HANDLE CYKLREAD DROP                                     SCREEN-HANDLE CLOSE-FILE ?DISCERR CR                            CCAD FIND IF EXT-CHAIN ADD-TO-CHAIN ELSE DROP THEN              FORTH CH-FIND ;                                              -->                                                            \ #46                                                01/20/90 ) : LOADMAIN ( --- ; LOADMAIN XXX )                                   INIT_OBJ BL word LOADBIN ;                                  : LOADSTANDLIB ( --- )                                              STAND-LOADED @ 0=                                               IF -1 STAND-LOADED ! INIT_OBJ STDNAME LOADBIN                   THEN ;                                                      : LOAD-STAND ( --- ; In form  LOAD-STAND XXX.ext )                  STAND-LOADED @                                                  IF    BL word DROP                                              ELSE  -1 STAND-LOADED ! LOADMAIN                                THEN ;                                                      : LOAD-SHORT$ ( --- ; in the form: LOAD-SHORT$ filename.ext )       BL word n-ad ! LOAD-SHORT ;                                  -->                                                                                                                            \ #47 originaal                                      01/31/90 ) -->                                                             : LOAD-MODULE ( --- ; counted name in THBUF )                       THBUF IS-STANDARD-MODULE?                                       IF OUTTABLE-EMPTY?                                                  IF STD-EXISTS?                                                      IF   LOADSTANDLIB                                               ELSE LOAD-T-OR-O                                                THEN                                                        ELSE LOAD-T-OR-O                                                THEN                                                        ELSE LOAD-T-OR-O                                                THEN ;                                                                                                                       -->                                                                                                                            \ #48                                                01/31/90 ) : D2Base NOOP ;                                                 : LOAD-MODULE ( --- ; counted name in THBUF )                   THBUF IS-STANDARD-MODULE?                                        IF OUTTABLE-EMPTY?                                                 IF STD-EXISTS?                                                     IF   LOADSTANDLIB                                               ELSE LOAD-T-OR-O                                                THEN                                                          ELSE LOAD-T-OR-O                                                THEN                                                        ELSE LOAD-T-OR-O                                                THEN ( D2Base ) ;                                                                                                               -->                                                                                                                            \ #49                                                10/19/90 ) BASE @ HEX                                                      : C.END  ( --- )                                                (  ALSO [COMPILE] FORTH CURRENT @ DEFINITIONS )                    HERE 82 C, ASCII C DUP C, 80 OR C,                              LATEST , CURRENT @ ! SMUDGE                                     COLDEF.CFCONT ,                                                 ( CCAD FIND SWAP DROP 0= IF ) ['] RM.INIT , ( THEN )            CH-COMP-LOOP 0 EXT-CHAIN !                                      ( HIDDEN ) SEMI.CFA ( FORTH ) , UNSMUDGE                     (  PREVIOUS CURRENT ! ) ;                                       BASE !                                                          : LOADLOOPEND ( --- )                                               ( WRITE-SHORT-LOOP )                                            [COMPILE] ENVIRONMENT DEFINITIONS C.END ;                    -->                                                            \ #50 RUNMAIN                                        10/15/89 )                                                                 : RUNMAIN ( --- )                                                   CCAD FIND                                                       IF 0 RM.INITFLAG ! EXECUTE                                      ELSE ." Fatal" ABORT                                            THEN ;                                                                                                                      : SET-SH-NAME ( --- )                                               OBJNAME >R R@ SCREEN-HANDLE DROP 4 + R> C@ CMOVE                LIT" BIN" 1+ SCREEN-HANDLE DROP 4 + DUP C@ + 2 - 3 CMOVE        OBJECTPATH SCREEN-HANDLE DROP 4 + SOUR|DEST ;                                                                                -->                                                                                                                                                                                            \ #51 MENU                                           10/16/89 ) : RDMNAME? ( --- ; THBUF - counted string, len=0 => eof )           0 THBUF C! THBUF 1+ THIN !                                      BEGIN                                                               THIN @ 1 THANDLE LREAD                                          IF THIN @ THBUF - 1 - THBUF C! 0 THIN @ C! -1                   ELSE THIN @ C@ 10 =                                                 IF   THIN @ THBUF - 1 - THBUF C! 0 THIN @ C! -1                 ELSE THIN @ C@ 13 =                                                 IF   0                                                          ELSE 1 THIN +! 0                                                THEN                                                        THEN                                                        THEN                                                        UNTIL ;                                                      -->                                                            \ #52 MENU                                           10/16/89 ) DECIMAL                                                         : MLOADLOOP ( --- )                                                 THANDLE OPEN-FILE DUP                                           IF CR ." File " THANDLE .FILENAME THEN                          ?DISCERR THBUF 107 THANDLE LREAD DROP                           LOADLOOPINIT CH-FIND [COMPILE] ENVIRONMENT DEFINITIONS          BEGIN [ HEX ]                                                       THBUF 8 THANDLE LREAD DROP THBUF C@ 0D = 0=                 WHILE                                                               THBUF @ 20202020 = 0=                                           IF THANDLE -8 SEEK-REL ?DISCERR RDMNAME?                            THANDLE CLOSE-FILE ?DISCERR                                     CR THBUF COUNT TYPE ABORT                                   THEN [ DECIMAL ]                                         -->                                                            ( #53 MAINTASK                                       10/16/89 )         RDMNAME? LOAD-MODULE                                        REPEAT                                                          THANDLE CLOSE-FILE ?DISCERR                                     LOADLOOPEND ;                                               : MAINTASK ( --- )                                                  INIT_OBJ SCRATCH_BUFF C@ 0=                                     IF ( link )                                                         HERE BIN-BASE-AD ! MLOADLOOP SET-SH-NAME                        SCREEN-HANDLE MAKE-FILE ?DISCERR                                ADP @ ASTART - MCODELEN ! LATEST LATEST-AD !                    MBOOT MBOOTLEN SCREEN-HANDLE CYKLWRITE                          ASTART MCODELEN @ SCREEN-HANDLE CYKLWRITE                       BIN-BASE-AD @ HERE OVER - SCREEN-HANDLE CYKLWRITE               SCREEN-HANDLE CLOSE-FILE ?DISCERR                        -->                                                            ( #54                                                10/17/89 )     ELSE ( run ) CR                                                     ." Running file: " SCREEN-HANDLE .FILENAME                      MBOOT MBOOTLEN SCREEN-HANDLE CYKLREAD DROP                      [COMPILE] ENVIRONMENT DEFINITIONS                               BIN-BASE-AD @ DP ! LATEST-AD @ CURRENT @ !                      ASTART MCODELEN @ SCREEN-HANDLE CYKLREAD DROP                   HERE SCREEN-HANDLE ?FILESIZE MBOOTLEN MCODELEN @ + -            DUP ALLOT MBOOTLEN MCODELEN @ + SCREEN-HANDLE INITSA            SCREEN-HANDLE CYKLREAD DROP                                     SCREEN-HANDLE CLOSE-FILE ?DISCERR CR RUNMAIN                THEN ;                                                      : STARTLR                                                           ['] EXIT_FORTH UABORT ! MAINTASK EXIT_FORTH ;               : MAKETASK ( --- )                                                  ['] STARTLR UIDENT ! ; -->                                  \ #55 CUNIT$                                         12/16/90 ) : CUNIT$ ( --- ; CUNIT$ XXX )                                      BL word DROP                                                    EXT-CHAIN @ DUP                                                 IF  BEGIN DUP @                                                     WHILE @                                                         REPEAT DUP 4 + @ DUP >NAME C@ 130 = 0=                          IF  SWAP DELEXTTAIL MAKE1CC                                     ELSE DROP DROP MAKE0CC                                          THEN                                                        ELSE DROP MAKE0CC                                               THEN                                                            M.R.OUTTABLE M.R.#EL @ DUP M.R.OUTLENS WRITE-SHORT              CR ;                                                                                                                          ;S                                                             (  SAARSENI OSA KOOPIA 06.12.90                      12/07/90 ) : SET-TA-NAME ( --- )                                               OBJNAME >R R@ SCREEN-HANDLE DROP 4 + R> C@ CMOVE                LIT" TA " 1+ SCREEN-HANDLE DROP 4 + DUP C@ + 2 - 3 CMOVE        OBJECTPATH SCREEN-HANDLE DROP 4 + SOUR|DEST ;               : MAINTASK ( --- )                                                  INIT_OBJ SCRATCH_BUFF C@ 0=                                     IF ( link )                                                         HERE BIN-BASE-AD ! MLOADLOOP SET-SH-NAME                        ADP @ ASTART - MCODELEN ! LATEST LATEST-AD !                    SCOMP  StoPRINT                                                 SET-TA-NAME                                                     [COMPILE] ENVIRONMENT                                           LIT" CC" FIND IF SCW ELSE ABORT" CC??"  THEN             -->                                                                                                                            (                                                    11/08/90 ) FORTH DEFINITIONS                                               HERE CONSTANT OVERLAY                                           : DEF <BUILDS , DOES> @ ;                                       5 DEF VIIS                                                      VOCABULARY VVV IMMEDIATE                                        : FFF ." FFFFFFFFFF" ;                                          VVV DEFINITIONS                                                 6 DEF KUUS                                                      FORTH DEFINITIONS                                               : GGG ." GGGGGGGGGGGG" ;                                        ;S                                                                                                                                                                                                                                                                                                                              (                                                    01/15/91 )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 