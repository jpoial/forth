( Link to floating-point module                      12/03/90 ) ;S                                                                  Floating-point module is designed by J. Helekivi                                  linked to FORTH by V. Soo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( FLOATOP                                            12/03/90 ) VARIABLE FLENTRY ( Place to hold entry point to floating                            point module )                              HEX                                                             CODE FLOATOP    ( offs --- )                                            ( Call floating point operation at offset 'offs'                  in floating point module. )                                   BX      POP          BX      POP                                2E C, 1EFF H, FLENTRY H, ( call dword ptr cs:[FLENTRY] )        NEXT,                                                   END-CODE                                                        DECIMAL                                                          -->                                                                                                                                                                                                                                                            ( FLOATOP_CF                                         12/11/90 ) HEX                                                             CODE FLOATOP_CF ( offs --- cf )                                                 ( Same but return carry flag )                          BX      POP             BX      POP                             2E C, 1EFF H, FLENTRY H,                                        AX, 0 # MOV                                                     1$ JNB                                                               AX DEC                                             1$:     AX      PUSH            AX      PUSH                            NEXT,                                                   END-CODE                                                        DECIMAL                                                          -->                                                                                                                                                                                            ( FLOATOP_CMP                                        12/11/90 ) HEX                                                             CODE FLOATOP_CMP ( offs --- n )                                                 ( Same but return comparision result )                  BX      POP             BX      POP                             2E C, 1EFF H, FLENTRY H,                                        AX, 0 # MOV                                                     1$ JE                                                           2$ JG                                                                AX      DEC                                                1$ JMP                                                  2$:          AX      INC                                        1$:     CWD             AX      PUSH            DX      PUSH            NEXT,                                                   END-CODE         HERE 10000 > DECIMAL 19 ?ERROR                 ;S                                                              ( FLOC                                               12/03/90 ) 0 CONSTANT FLBASE                                               VARIABLE CURRLOC                                                : FLOC  ( Use in form FLOC XXXX )                                       <BUILDS CURRLOC @ H, 2 CURRLOC +!                               DOES> H@ FLBASE + H@ ;                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( Locations                                          12/03/90 ) FLOC $LPOINT    FLOC $FLDATA    FLOC $FLSP                      FLOC $EXECFL    FLOC $ASIN      FLOC $ACOS                      FLOC $ASIND     FLOC $ACOSD     FLOC $ATAN                      FLOC $ATAN2     FLOC $ATAN2D    FLOC $ATAND                     FLOC $CEIL      FLOC $FLOOR     FLOC $CCDTEST                   FLOC $CCDCMP    FLOC $DECIMAL   FLOC $CCDADD                    FLOC $CCDSUB    FLOC $CCDNEG    FLOC $CCDMUL                    FLOC $CCDDIV    FLOC $CCDMUL2   FLOC $CCDDIV2                   FLOC $EXP       FLOC $FABS      FLOC $FPCONST                   FLOC $CCKORRUTA FLOC $CCKORDA10 FLOC $CCFADD                    FLOC $CCFSUB    FLOC $FPTEKST   FLOC $FOUT                      FLOC $CCFMUL    FLOC $CCFDIV                                    FLOC $CCFMUL2   FLOC $CCFDIV2                                   FLOC $LOG       FLOC $LN        FLOC $LOG2                      FLOC $LOG10     FLOC $CCMCPY    FLOC $POW    -->                ( Locations                                          12/03/90 ) FLOC $CCSAVE    FLOC $CCRESTOR  FLOC $SIN                       FLOC $SIND      FLOC $COS       FLOC $COSD                                                      FLOC $SINH                      FLOC $COSH      FLOC $SQRT      FLOC $TAN                       FLOC $TAND      FLOC $TANH      FLOC $CCDTOF                    FLOC $CCFTOD                                                    FLOC $CCDTOI    FLOC $CCDTOL    FLOC $CCUTOD                    FLOC $CCITOD    FLOC $CCLTOD    FLOC $CCULTOD                                                   FLOC $CCITOF                    FLOC $CCUTOF    FLOC $CCLTOF    FLOC $CCFTOI                    FLOC $CCFTOL    FLOC $MATHERR                                    -->                                                                                                                                                                                                                                                            ( FLSP FLDATA LPOINT ALIGN_PARA SETCONST             12/11/90 ) 0 CONSTANT FLSP                                                 0 CONSTANT FLDATA                                               0 CONSTANT LPOINT                                               HEX                                                             : ALIGN_PARA HERE 0F + 0FFFFFFF0 AND DP ! ;                     DECIMAL                                                         : SETCONST ( n cfa --- )                                                >BODY ! ;                                                                                                               -->                                                                                                                                                                                                                                                                                                                                                                                             ( FLOATBIN LOADFLOAT                                 12/11/90 ) HANDLE FLOATBIN                                                 : LOADFLOAT                                                             ALIGN_PARA                                                      HERE  ['] FLBASE  SETCONST                                      FLOATBIN FILENAME FLOAT.BIN                                     FLOATBIN OPEN-FILE 16 ?ERROR                                    FLOATBIN                                                        FLOATBIN ?FILESIZE FLOATBIN 0 SEEK-ABS 16 ?ERROR                DUP ALLOT                                                       FLBASE READ 16 ?ERROR DROP                                      FLOATBIN CLOSE-FILE DROP ;                                -->                                                                                                                                                                                                                                                           ( TUNEFLOAT INITFLOAT                                12/11/90 ) : TUNEFLOAT                                                             $FLSP FLBASE + ['] FLSP SETCONST                                $FLDATA FLBASE + ['] FLDATA SETCONST                            $LPOINT FLBASE + ['] LPOINT SETCONST                            FLBASE 4 ->L ?fs: +  16 <-L                                     $EXECFL + FLENTRY ! ;                                   : INITFLOAT                                                             LOADFLOAT                                                       TUNEFLOAT ;                                               -->                                                                                                                                                                                                                                                                                                                                                                                           ( DFLARG FLVAR FLARG DFVAL                           12/11/90 ) : DFLARG ( dfp addr n --- )                                             OVER FLBASE - SWAP FLSP + H! 2! ;                       : FLVAR ( addr n --- )                                                  SWAP FLBASE - SWAP FLSP + H! ;                          : FLARG ( fp addr n --- )                                               OVER FLBASE - SWAP FLSP + H!  ! ;                                                                                       : DFVAL ( addr len --- dfp errflag )                                    DUP >R FLDATA 8 + SWAP  CMOVE                                   0 FLDATA 8 + R> + C!                                            $FLDATA  8 + LPOINT H!                                          FLDATA 0 FLVAR                                                  $FPCONST FLOATOP_CF >R                                          FLDATA 2@ R> ;                                          -->                                                             ( DFSTR                                              12/12/90 ) ( Convert double float to string )                              : DFSTR ( dfp n m ff --- addr len )                             (       dfp     - double float to convert                               n       - length of the field for result                        m       - number of fractal digits                              ff      - format flags                                                    Mask                                                          1 - fixed format                                                2 - exponent format                                               if both bits are 0 use C-format %g                            4 - fill with                                                       0: blanks; 1: zeros                                         8 - align to                                                        0: right; 1: left                           ) -->                                                           ( DFSTR <cont.>                                      12/12/90 )         [ HEX ]                                                         FLSP H!                                                         0FF AND                                                         SWAP 8 <-L OR                                                   FLSP 2+ H!                                                      FLDATA 8 + 4 FLVAR                                              FLDATA 6 DFLARG                                                 $FOUT FLOATOP                                                   FLDATA 8 + COUNTZ ;                                     DECIMAL                                                         -->                                                                                                                                                                                                                                                                                                                             ( f2op f1op                                          12/12/90 ) : f2op ( fp1 fp2 offs --- fp3 )                                         >R                                                              FLDATA     2 FLARG                                              FLDATA 4 + 4 FLARG                                              FLDATA 8 + 0 FLVAR                                              R> FLOATOP                                                      FLDATA 8 + @ ;                                          : f1op ( fp1 offs --- fp2 )                                             >R                                                              FLDATA     2 FLARG                                              FLDATA 4 + 0 FLVAR                                              R> FLOATOP                                                      FLDATA 4 + @ ;                                                                                                          -->                                                             ( df2op df1op                                        12/12/90 ) : df2op ( dfp1 dfp2 offs --- dfp3 )                                     >R                                                              FLDATA      2 DFLARG                                            FLDATA 8  + 4 DFLARG                                            FLDATA 16 + 0 FLVAR                                             R> FLOATOP                                                      FLDATA 16 + 2@ ;                                        : df1op ( dfp1 offs --- dfp2 )                                          >R                                                              FLDATA     2 DFLARG                                             FLDATA 8 + 0 FLVAR                                              R> FLOATOP                                                      FLDATA 8 + 2@ ;                                                                                                         -->                                                             ( Operators: DF+ DF- DF* DF/ F+ F- F* F/ DFNEGATE ...12/13/90 ) : DF+ $CCDADD df2op ;           ( dfp1 dfp2 --- dfp3 )          : DF- $CCDSUB df2op ;                                           : DF* $CCDMUL df2op ;                                           : DF/ $CCDDIV df2op ;                                           : F+  $CCFADD f2op ;            ( fp1 fp2 --- fp3 )             : F-  $CCFSUB f2op ;                                            : F*  $CCFMUL f2op ;                                            : F/  $CCFDIV f2op ;                                            : DFNEGATE $CCDNEG df1op ;      ( dfp1 --- dfp2 )               : 2DF* $CCDMUL2 df1op ;                                         : 2DF/ $CCDDIV2 df1op ;                                         : 2F*  $CCFMUL2 f1op ;          ( fp1 --- fp2 )                 : 2F/  $CCFDIV2 f1op ;                                          HEX                                                             : FNEGATE 80000000 XOR ; DECIMAL -->                            ( Type transfer: DF>F F>DF                           12/13/90 ) : DF>F ( dfp --- fp )                                                   FLDATA     2 DFLARG                                             FLDATA 8 + 0 FLVAR                                              $CCDTOF FLOATOP                                                 FLDATA 8 + @ ;                                          : F>DF ( fp --- dfp)                                                    FLDATA     2 FLARG                                              FLDATA 4 + 0 FLVAR                                              $CCFTOD FLOATOP                                                 FLDATA 4 + 2@ ;                                         -->                                                                                                                                                                                                                                                                                                                             ( Type transfer; DF>S S>DF                           12/13/90 ) : DF>S ( dfp --- n )                                                    FLDATA     2 DFLARG                                             FLDATA 8 + 0 FLVAR                                              $CCDTOL FLOATOP                                                 FLDATA 8 + @ ;                                          : S>DF ( n --- dfp )                                                    FLDATA     2 FLARG                                              FLDATA 4 + 0 FLVAR                                              $CCLTOD FLOATOP                                                 FLDATA 4 + 2@ ;                                         : U>DF ( n --- dfp )                                                    FLDATA     2 FLARG                                              FLDATA 4 + 0 FLVAR                                              $CCULTOD FLOATOP                                                FLDATA 4 + 2@ ;            -->                          ( Type transfer; F>S S>F                             12/13/90 ) : F>S ( fp --- n )                                                      FLDATA     2 FLARG                                              FLDATA 8 + 0 FLVAR                                              $CCFTOL FLOATOP                                                 FLDATA 8 + @ ;                                          : S>F ( n --- fp )                                                      FLDATA     2 FLARG                                              FLDATA 4 + 0 FLVAR                                              $CCLTOF FLOATOP                                                 FLDATA 4 + @ ;                                          -->                                                                                                                                                                                                                                                                                                                             ( Functions: dfun                                    12/15/90 ) : dfun ( dfp1 offs --- dfp2 )                                           >R                                                              FLSP 2+ 2!                                                      FLDATA 0 FLVAR                                                  R> FLOATOP                                                      FLDATA 2@ ;                                             : d2fun ( dfp1 dfp2 offs --- dfp3 )                                     >R                                                              FLSP 2+ 2!                                                      FLSP 10 + 2!                                                    FLDATA 0 FLVAR                                                  R> FLOATOP                                                      FLDATA 2@ ;                                             -->                                                                                                                             ( Functions: ASIN ACOS ASIND ACOSD ATAN ATAN2 ...    12/15/90 ) : ASIN $ASIN dfun ; : ACOS $ACOS dfun ;                         : ASIND $ASIND dfun ; : ACOSD $ACOSD dfun ;                     : ATAN $ATAN dfun ; : ATAN2 $ATAN2 d2fun ;                      : ATAN2D $ATAN2D d2fun ; : ATAND $ATAND d2fun ;                 : CEIL $CEIL dfun ; : FLOOR $FLOOR dfun ;                       : FABS $FABS dfun ;                                             : EXP $EXP dfun ; : LOG $LOG dfun ;                             : LOG2 $LOG2 dfun ; : LOG10 $LOG10 dfun ;                       : SIN $SIN dfun ; : SIND $SIND dfun ;                           : COS $COS dfun ; : COSD $COSD dfun ;                           : SINH $SINH dfun ; : COSH $COSH dfun ;                         : SQRT $SQRT dfun ; : TAN $TAN dfun ;                           : TAND $TAND dfun ; : TANH $TANH dfun ;                          -->                                                                                                                            (  POW DFLIT FLIT                                    12/15/90 ) : POW $POW d2fun ;                                              : DFLIT                                                                 BL WORD COUNT DFVAL 17 ?ERROR                                   [COMPILE] DLITERAL                                      ; IMMEDIATE                                                     : FLIT                                                                  BL WORD COUNT DFVAL 17 ?ERROR                                   DF>F                                                            [COMPILE] LITERAL                                       ; IMMEDIATE                                                     -->                                                                                                                                                                                                                                                                                                                             ( Comparision: DFCMP DF> DF< DF= DFTEST DF0= DF0< ...12/18/90 ) : DFCMP ( dfp1 dfp2 --- n ; n = sign [dfp1 - dfp2] )                    FLDATA      0 DFLARG                                            FLDATA 8  + 2 DFLARG                                            $CCDCMP FLOATOP_CMP ;                                   : DF> DFCMP 0> ;                                                : DF< DFCMP 0< ;                                                : DF= DFCMP 0= ;                                                : DFTEST ( dfp --- n )                                                  FLDATA 0 DFLARG                                                 $CCDTEST FLOATOP_CMP ;                                  : DF0= DFTEST 0= ;                                              : DF0< DFTEST 0< ;                                              : DF0> DFTEST 0> ;                                               ;S                                                                                                                             ( TEST                                               12/12/90 ) INITFLOAT                                                       : TEST                                                                  DFLIT -1 .STACK                                                 DFLIT 0 .STACK                                                  POW .STACK                                                      15 7 1 DFSTR .STACK DUMP ;                              : TEST1                                                                 DFLIT 2 .STACK                                                  DFLIT 3 .STACK                                                  POW .STACK                                                      15 7 1 DFSTR .STACK DUMP ;                              : TEST2                                                                 DFLIT 2 .STACK DFLIT 3 .STACK                                   DF- .STACK                                                      15 7 1 DFSTR .STACK DUMP ;                              